---
id: m-54d3
status: closed
deps: []
created: 2026-02-19T19:05:54Z
type: task
priority: 0
assignee: Adam Avenir
updated: 2026-02-19T19:53:38Z
---
# Adopt built-in pipeline retry in plugin examples and skill docs

## Summary

mlld has a built-in => retry mechanism in pipelines that provides automatic retry with feedback hints, attempt tracking, and fallback. Several plugin examples and skill docs manually implement retry logic (call LLM, check result, rebuild prompt with feedback, call LLM again) instead of using this built-in. Update examples and documentation to use the idiomatic pattern.

## How => retry works

Retry is a pipeline stage primitive. When a stage returns => retry, the pipeline re-executes from the first stage with:

- @mx.try — current attempt number (1-indexed)
- @mx.hint — the value passed to retry "feedback" or retry { key: "val" }
- @mx.tries / @pipeline.tries — array of all previous attempt outputs

Example:
```mlld
exe @validator(input) = when [
  @input.valid => @input
  @mx.try < 3 => retry "need more detail"
  * => "fallback"
]
var @result = @raw | @validator
```

The hint flows back to the source stage, which can read @mx.hint to adjust behavior on retry. This replaces manual "check -> rebuild prompt -> call again" patterns.

## Places to update

### 1. Event-agent example: manual gate+retry -> pipeline retry (PRIMARY)

File: plugins/mlld/examples/event-agent/index.mld (lines 50-88)

Current pattern (~38 lines): calls @claudePoll, checks @agentResult, runs @checkOutput gate, if gate fails manually builds @retryPrompt with feedback appended, calls @claudePoll again, checks retry result.

Should become a pipeline (~15 lines):
```mlld
exe @callAgent(task) = [
  let @prompt = ...build prompt, append @mx.hint if present for retry feedback...
  @claudePoll(@prompt, "sonnet", "@root", @tools, @outPath)
  => <@outPath>?
]

exe @qualityGate(result) = when [
  !@result => { status: "failed" }
  @checkOutput(@task, @result).pass => @result
  @mx.try < 3 => retry @checkOutput(@task, @result).feedback
  * => { status: "failed", reason: "gate_retry_failed" }
]

var @result = @task | @callAgent | @qualityGate
output @result to "@outputPath"
```

### 2. Event-agent router: confidence-based refinement -> pipeline retry

File: plugins/mlld/examples/event-agent/lib/router.mld (lines 8-44)

Currently: calls haiku, checks confidence, manually calls sonnet if low. This is a natural retry-with-escalation pattern where @mx.hint carries the low-confidence result and the source stage can switch models on retry.

### 3. Skill docs: missing retry documentation

| File | What to add |
|------|-------------|
| plugins/mlld/skills/orchestrator/SKILL.md | New section: "Quality Gates and Retry" showing pipeline retry for LLM output validation |
| plugins/mlld/skills/orchestrator/syntax-reference.md | Add => retry syntax with hint objects |
| plugins/mlld/skills/orchestrator/anti-patterns.md | New anti-pattern: "Manual Retry Trap" — manually rebuilding prompts instead of using => retry |
| plugins/mlld/skills/agents/SKILL.md (lines 220-239) | Gate Pattern section should show => retry as the implementation |
| plugins/mlld/skills/llm-first/SKILL.md | Reference => retry in "Verify, Don't Decide" and "Check and Repair" (lines 62-73) |

### 4. Other plugin examples to audit

- plugins/mlld/examples/audit/index.mld (lines 133-139) — verification phase defaults to "confirmed" on failure instead of retrying
- plugins/mlld/examples/research/index.mld (lines 193-199) — invalidation calls with no retry on failure
- plugins/mlld/examples/development/index.mld (lines 144-170) — worker dispatch with no quality gate

For these, evaluate whether adding a pipeline retry stage improves reliability. The audit and research examples may benefit; development may not (its decision loop already handles failure recovery).

## Getting up to speed

- Retry docs: docs/src/atoms/syntax/pipelines-retry.md and docs/src/atoms/syntax/pipelines-context.md
- Test fixtures (concrete examples of patterns):
  - tests/cases/feat/pipeline/retry-basic/example.md
  - tests/cases/feat/pipeline/retry-hint-reception/example.md
  - tests/cases/feat/pipeline/retry-hint-object/example.md
  - tests/cases/feat/pipeline/retry-conditional-fallback/example.md
  - tests/cases/feat/pipeline/retry-best-of-n/example.md
  - tests/cases/feat/security/guard-retry/example.md
- Current manual pattern: plugins/mlld/examples/event-agent/index.mld lines 50-88
- Skill docs structure: Browse plugins/mlld/skills/
- Pipeline basics: docs/src/atoms/syntax/pipelines-basics.md

