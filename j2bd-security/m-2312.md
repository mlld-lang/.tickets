---
id: m-2312
status: closed
deps: []
created: 2026-02-04T04:31:57Z
type: task
priority: 2
assignee: Adam
tags: [urgency-high, j2bd-mcp, security-bug]
updated: 2026-02-04T04:40:30Z
---
# Fix object literal label propagation - labels lost during construction

## Bug

When a labeled variable is used inside an object literal, its labels are lost. This is a security hole:

```mlld
var secret @key = "sk-123"
var @obj = { text: @key }
show @obj.mx.labels   // [] -- should be ["secret"]
```

Direct variable passing preserves labels correctly (`@echo(@key)` works). The issue is specifically in object/array construction.

## Root Cause

`CollectionEvaluator.evaluateObject()` in `interpreter/eval/data-values/CollectionEvaluator.ts:152-248` evaluates each property value but does NOT aggregate security descriptors from constituent values. When it calls `this.evaluateDataValue(entry.value, env)` (line 161), the result may carry security metadata, but the final object returned is a plain `Record<string, any>` with no security context.

Compare with `interpolateAndRecord()` (lines 12-31 in the same file) which correctly collects and merges security descriptors during template interpolation.

## Fix Approach

The object (and array) evaluation needs to:
1. Collect security descriptors from each evaluated property value / array element
2. Merge them into an aggregate descriptor
3. Attach the aggregate to the returned object via `env.recordSecurityDescriptor()` or by returning a structured value

Look at how `interpolateAndRecord()` does this with `collectSecurityDescriptor` callbacks and `env.mergeSecurityDescriptors()`. Apply the same pattern to object and array construction.

Key files:
- `interpreter/eval/data-values/CollectionEvaluator.ts` - evaluateObject() (line 152) and evaluateArray() (line 253)
- `interpreter/utils/structured-value.ts` - for understanding how structured values carry security metadata
- `interpreter/eval/var.ts` - for understanding how security descriptors are associated with variables

The fix should ensure labels propagate through ALL collection construction (objects AND arrays), per the spec: 'labels propagate through ALL transformations'.

## Verification

After fix:
```mlld
var secret @key = "sk-123"
var @obj = { text: @key }
show @obj.mx.labels   // should show ["secret"]
var @arr = [@key]
show @arr.mx.labels   // should show ["secret"]
```

