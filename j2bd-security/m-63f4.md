---
id: m-63f4
status: closed
deps: []
created: 2026-02-04T10:34:56Z
type: task
priority: 2
assignee: Adam
tags: [urgency-high, phase-2, prevent-exfil]
updated: 2026-02-04T10:47:18Z
---
# Fix exeLabels hardcoded to [] across all evaluators

## Problem

Policy label flow checks for exe-declared labels (net:w, destructive, safe, etc.) never fire because exeLabels is hardcoded to [] at every checkLabelFlow call site except one.

## Root Cause

The correct pattern exists at directive.ts:588-593:
```ts
const execVar = findExecutableInput(extractedInputs);
const execDescriptor = execVar?.mx ? varMxToSecurityDescriptor(execVar.mx) : undefined;
const exeLabels = execDescriptor?.labels ? Array.from(execDescriptor.labels) : [];
```

But all other sites hardcode `exeLabels: []`.

## Files to Fix

1. **interpreter/eval/run.ts** - Lines ~407, ~540, ~672 (3 sites)
2. **interpreter/eval/show.ts** - Line ~1266 (1 site)
3. **interpreter/eval/append.ts** - Line ~86 (1 site)
4. **interpreter/eval/output.ts** - Line ~193 (1 site)
5. **interpreter/eval/pipeline/builtin-effects.ts** - Line ~254 (1 site)
6. **interpreter/eval/pipeline/executor.ts** - Line ~824 (1 site)
7. **interpreter/eval/directive.ts** - Lines ~453, ~481, ~500, ~545, ~559, ~578 (6 non-exe sites that may or may not need fixing depending on context)

## Implementation Approach

For each site:
1. Check if the call is in a context where an executable variable is being invoked
2. If yes, extract the exe labels using the pattern from directive.ts:588-593
3. If the call is for a non-exe operation (e.g., a raw `run cmd` or `show`), exeLabels:[] is correct

The key distinction: when checkLabelFlow is called for an exe invocation, the exe's declared labels (net:w, destructive, etc.) must be passed. When called for a direct directive (run cmd, show, etc.), there are no exe labels.

## Test Approach

After fixing, verify with: a policy that denies secretâ†’net:w should block when calling an exe labeled net:w with secret data. Currently this passes silently because exeLabels is [].

Run existing tests: npm test interpreter/eval/run.ts, npm test core/policy


**2026-02-04 10:46 UTC:** Fixed all hardcoded exeLabels:[] sites. Added getEnclosingExeLabels() to ContextManager that walks the op stack to find enclosing exe context labels. All 14 sites fixed, all tests pass.
