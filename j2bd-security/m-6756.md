---
id: m-6756
status: closed
deps: []
created: 2026-02-09T08:57:12Z
type: task
priority: 2
assignee: Adam Avenir
tags: [phase-2, urgency-high, security]
updated: 2026-02-09T09:18:35Z
---
# Phase 2: Build complete audit guard implementation

## Context

All 5 documentation atoms are complete (signing-overview, sign-verify, autosign-autoverify, labels-influenced, pattern-audit-guard). The implementation needs to demonstrate the full audit guard pattern end-to-end.

## Current State

- `llm/run/j2bd/security/impl/main.mld` exists but has the enforcement guard COMMENTED OUT
- No `prompts/audit-criteria.att` template file exists
- The mock LLMs work but the enforcement guard is disabled

## Requirements

1. **Create `llm/run/j2bd/security/impl/prompts/audit-criteria.att`** — the signed audit template with @content placeholder matching the target example

2. **Update `llm/run/j2bd/security/impl/main.mld`** to:
   - Load the template from `./prompts/audit-criteria.att` using `template` directive
   - ENABLE the enforcement guard (currently commented out) — `guard @ensureVerified after llm = when [@mx.tools.calls.includes("verify") => allow, * => retry "Must verify signed instructions before proceeding"]`
   - Add a comment explaining when the guard would fire (only in MCP context with real LLMs, not with mock printf commands)
   - Show the influenced label on @processed output
   - Gate final action on audit approval using when blocks
   - Match the target example's end-to-end flow: untrusted input → influenced output → audit → action/rejection

3. **Validate** — run `mlld validate` or `mlld <file>` on the implementation to confirm it parses and runs correctly

## Target Example Reference

The final implementation should closely mirror the target example in the job spec, adapted for what actually works in mlld today. Key elements:
- `var @auditCriteria = template "./prompts/audit-criteria.att"`
- `sign @auditCriteria by "security-team" with sha256`
- `exe llm @processData(input) = ...` (mock is fine)
- `var untrusted @externalInput = ...`
- `var @processed = @processData(@externalInput)`
- `show @processed.mx.labels` to demonstrate influenced label
- `exe llm @audit(content) = ...` (mock is fine)
- `guard @ensureVerified after llm = when [...]`
- `when @auditResult.approved => [...]` / `when !@auditResult.approved => [...]`

## Files to Create/Modify

- CREATE: `llm/run/j2bd/security/impl/prompts/audit-criteria.att`
- MODIFY: `llm/run/j2bd/security/impl/main.mld`

## Validation

Run `mlld llm/run/j2bd/security/impl/main.mld` to verify the script runs end-to-end without errors.


**2026-02-09 09:18 UTC:** Two friction points discovered during implementation: (1) guard bypass via with clause doesn't work on var assignments for after-guards, (2) double-quote interpolation in when blocks produces [object Object]. Both documented in worker friction report.
