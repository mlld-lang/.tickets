---
id: m-89f4
status: closed
deps: []
created: 2026-02-04T11:37:11Z
type: task
priority: 2
assignee: Adam
tags: [urgency-high, security, phase-3-4]
updated: 2026-02-04T11:46:26Z
---
# Fix field-access.ts: wrap primitives with security labels on property/array access

When accessing @arr[0] or @obj.prop on a security-labeled parent, the returned primitive loses its security labels because inheritExpressionProvenance() uses a WeakMap that can't key on primitives.

## Root Cause

field-access.ts line 784-787:
```
const provenanceSource = parentVariable ?? structuredWrapper ?? value;
if (provenanceSource) {
  inheritExpressionProvenance(accessedValue, provenanceSource);
}
```
WeakMap silently fails for primitive accessedValue (string, number, boolean).

## Fix Pattern (from commit 4a6960878)

Replace lines 784-787 with logic that:
1. Extracts security descriptor from provenanceSource using extractSecurityDescriptor()
2. If descriptor has labels or taint AND accessedValue is primitive (typeof !== 'object' || === null), wrap it in a StructuredValue using wrapExecResult() and apply the descriptor via applySecurityDescriptorToStructuredValue()
3. If accessedValue is already an object, use existing inheritExpressionProvenance() path

## Imports Needed

Add to field-access.ts imports:
- extractSecurityDescriptor from './structured-value' (already partially imported)
- applySecurityDescriptorToStructuredValue from './structured-value'
- wrapExecResult from './structured-exec'

## Test Verification

After fix, run these adversarial test files (already exist):
- tmp/adversarial-exe-array-map.mld - should be BLOCKED (was: EXFIL)
- tmp/adversarial-array-access-direct.mld - should be BLOCKED (was: EXFIL)
- tmp/adversarial-object-access-strip.mld - should be BLOCKED (was: EXFIL)
- tmp/adversarial-array-whole.mld - should still be BLOCKED (already works)
- tmp/adversarial-ec1-basic.mld - should still be BLOCKED (regression check)

Also run: npm test interpreter/utils to check for regressions.

## Important Notes

- The fix should ONLY wrap when the parent has security labels - don't add overhead for non-security code paths
- The preserveContext path (lines 789-800) should also get the wrapped value, not the raw primitive
- Check if arraySlice and arrayFilter cases (line 727+) also need the same treatment - they return arrays so WeakMap should work, but verify

