---
id: m-0540
status: closed
deps: []
created: 2026-02-09T18:11:36Z
type: task
priority: 2
assignee: Adam Avenir
tags: [urgency-high, excellence]
updated: 2026-02-09T18:29:04Z
---
# Format capability denials using MlldDenial structure

Capability denial errors dump raw Guard context JSON instead of using the structured MlldDenial format that label-flow denials use.

**Root cause**: In core/errors/GuardError.ts, `formatGuardMessage()` (line 104-132) produces 'Guard blocked operation: Command npm denied by policy' and this overrides `formatDenialMessage()`. Also, `buildGuardDenialContext()` (line 156-186) always uses blocker.type='guard' even for policy-generated guards.

**Fix**: In core/policy/guards.ts, when creating PolicyGuardSpec for capability guards (lines 141-160, __policy_cmd_access; lines 162-175, __policy_deny_sh; etc.), include metadata that tells GuardError to use policy formatting:

1. Add a `policyName` field to the guard spec or pass it through the policyCondition return
2. In GuardError constructor or buildGuardDenialContext, detect policy guards (guardName starts with '__policy') and:
   - Set blocker.type = 'policy' 
   - Set blocker.name to the policy's display name
   - Set blocker.rule = 'capabilities.allow' (or 'capabilities.deny')
   - Add suggestions like 'Add cmd:npm:* to capabilities.allow'
   - Don't pass custom `message` so formatDenialMessage handles it

**Expected result**: Instead of 'Guard blocked operation: Command npm denied by policy [JSON dump]', users see:
```
MlldDenial: Operation denied
  Operation: /operation "npm install"
  Blocked by: Policy p
  Rule: capabilities.allow
  Reason: Command 'npm' denied by policy
  Suggestions:
  - Add 'cmd:npm:*' to capabilities.allow
```

**Test**: Update core/policy/guards-command-access.test.ts line 37 to expect the new format.

