---
id: m-272f
status: closed
deps: []
created: 2026-02-03T21:02:24Z
type: task
priority: 2
assignee: Adam
tags: [urgency-high, security]
updated: 2026-02-03T21:06:27Z
---
# Block cmd:sh and cmd:bash when deny: ['sh'] is set

## Problem

`capabilities.deny: ['sh']` generates a `__policy_deny_sh` guard that filters on `op:sh` (blocking `run sh { ... }`). But `run cmd { sh -c ... }` fires `op:cmd` and goes through `__policy_cmd_access` / `evaluateCommandAccess`, which only checks `denyMap.cmd` patterns - not `denyMap.sh`. So shell access via cmd is unblocked.

## Fix

In `core/policy/guards.ts`, function `evaluateCommandAccess` (line 296), add a check BEFORE the existing denyPatterns logic (line 329):

```typescript
// Block sh/bash commands when deny: ['sh'] is active
const denyMap = deny && deny !== true && typeof deny === 'object' && !Array.isArray(deny)
  ? deny as Record<string, unknown>
  : undefined;
if (denyMap && isDenied('sh', denyMap)) {
  const firstWord = commandTokens[0]?.toLowerCase() ?? '';
  if (firstWord === 'sh' || firstWord === 'bash') {
    return {
      allowed: false,
      commandName,
      reason: 'Shell access denied by policy'
    };
  }
}
```

Note: `denyMap` is already computed on line 329 in `evaluateCommandAccess` as a local var. You may need to hoist or rename to avoid shadowing the outer `denyMap` from the guard generation scope. The `isDenied` function is already exported in the same file (line 434).

## Test

Run `mlld tmp/adversarial-v2-deny-sh-bypass.mld` - should now exit 1 with 'Shell access denied by policy' instead of outputting 'BYPASS_VIA_CMD'.

Also run existing tests: `npm test core/policy`

