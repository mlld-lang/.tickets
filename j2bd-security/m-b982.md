---
id: m-b982
status: closed
deps: []
created: 2026-02-09T16:48:08Z
type: task
priority: 2
assignee: Adam Avenir
tags: [phase-2, urgency-high]
updated: 2026-02-09T16:58:25Z
---
# Policy composition enforcement test cases

Create test fixtures that demonstrate ACTUAL ENFORCEMENT of composed policies, matching the target example.

## Test 1: Command allowed after composition (tests/cases/security/policy-composition-allow/)

Three inline policies composed with union(). `run cmd { echo ok }` succeeds because echo is in all allow lists (intersection).

```mlld
var @team = { capabilities: { allow: ["cmd:git:*", "cmd:echo:*"] } }
var @project = { capabilities: { allow: ["cmd:echo:*", "cmd:node:*"] } }
var @myOverrides = { capabilities: { allow: ["cmd:echo:*", "cmd:jq:*"] } }
policy @combined = union(@team, @project, @myOverrides)
run cmd { echo "allowed by all layers" }
show @result
```

Expected: `allowed by all layers`

## Test 2: Command denied after composition (tests/cases/exceptions/security/policy-composition-deny/)

Deny union: curl denied by project layer, rm denied by team layer. Either should fail.

```mlld
var @team = { capabilities: { allow: ["cmd:git:*", "cmd:echo:*"], deny: ["cmd:rm:*"] } }
var @project = { capabilities: { allow: ["cmd:git:*", "cmd:echo:*"], deny: ["cmd:curl:*"] } }
policy @combined = union(@team, @project)
run cmd { curl example.com }
```

Expected error: denied by policy (capability deny)

## Test 3: Label flow denied in composed policy (tests/cases/exceptions/security/policy-composition-label-deny/)

Label rules from project layer should block secret→exfil flow even after composition.

```mlld
var @team = { defaults: { unlabeled: "untrusted" }, capabilities: { allow: ["cmd:echo:*"] } }
var @project = { capabilities: { allow: ["cmd:echo:*"] }, labels: { secret: { deny: ["exfil"] } } }
var @local = { capabilities: { allow: ["cmd:echo:*"] } }
policy @combined = union(@team, @project, @local)
var secret @key = "abc123"
exe exfil @send(data) = run cmd { echo "@data" }
show @send(@key)
```

Expected error: label 'secret' cannot flow to 'exfil'

## Important patterns:
- Use `.mld` files (strict mode, no `/` prefix needed)
- Exception tests go in `tests/cases/exceptions/security/` with `error.md` containing the expected error pattern
- Success tests go in `tests/cases/security/` with `expected.md`
- Build fixtures with `npm run build:fixtures` and run with `npm run test:case -- <path>`
- Variable name `@local` might be reserved — use `@myOverrides` or `@localOverrides` instead
- The `capabilities:` wrapper is the normalized form — flat `allow: [...]` also works but capabilities is clearer for tests

