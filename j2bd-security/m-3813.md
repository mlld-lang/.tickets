---
id: m-3813
status: closed
deps: []
created: 2026-02-03T20:47:00Z
type: task
priority: 2
assignee: Adam
tags: [security, bugfix, urgency-high]
updated: 2026-02-03T20:49:39Z
---
# Fix __policy_deny_sh guard to filter on op:sh

The __policy_deny_sh guard in core/policy/guards.ts:153-172 filters on 'op:cmd' (line 157), but `run sh { ... }` fires 'op:sh' (operation-labels.ts:34), not 'op:cmd'. So the deny guard never intercepts shell blocks.

**Fix**: Change `filterValue: 'op:cmd'` to `filterValue: 'op:sh'` on line 157. Then update the policyCondition function (lines 162-170) - it no longer needs to parse command tokens looking for 'sh'/'bash' since it will only fire for op:sh operations. Simplify to always deny.

**Before** (guards.ts:153-172):
```typescript
if (denyMap && isDenied('sh', denyMap)) {
  guards.push({
    name: '__policy_deny_sh',
    filterKind: 'operation',
    filterValue: 'op:cmd',  // BUG: should be 'op:sh'
    ...
    policyCondition: ({ operation }) => {
      // Checks first word for 'sh'/'bash' - unnecessary if filtering op:sh
    }
  });
}
```

**After**:
```typescript
if (denyMap && isDenied('sh', denyMap)) {
  guards.push({
    name: '__policy_deny_sh',
    filterKind: 'operation',
    filterValue: 'op:sh',
    scope: 'perOperation',
    block: makeGuardBlock(),
    timing: 'before',
    privileged: true,
    policyCondition: () => {
      return { decision: 'deny', reason: 'Shell access denied by policy' };
    }
  });
}
```

**Test**: After fix, this should fail:
```mlld
policy @noShell = { capabilities: { deny: ["sh"] } }
run sh { echo "should be blocked" }
```

Run: `npm test core/policy`

