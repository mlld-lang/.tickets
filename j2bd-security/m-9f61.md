---
id: m-9f61
status: closed
deps: []
created: 2026-02-04T01:59:54Z
type: task
priority: 2
assignee: Adam
tags: [urgency-high, j2bd-mcp]
updated: 2026-02-04T06:37:06Z
---
# Phase 3+4: Verify and adversarial-test MCP security demo

Combined verification and adversarial testing for the MCP security job.

## Phase 3: Verification

1. Run `mlld validate pipeline/mcp-security-demo.mld` - confirm syntax is valid
2. Run `npm run build && mlld pipeline/mcp-security-demo.mld` end-to-end
3. Verify each exit criterion:
   - `import tools from mcp` syntax works and tools are callable
   - Tool outputs have src:mcp taint (check @result.mx.taint)
   - Guard blocks secret data from flowing to MCP tools
   - Policy restricts MCP operations
   - Audit trail via after-guard works
4. Document any gaps found

## Phase 4: Adversarial Testing

Try to break the security guarantees:
- Can you circumvent the guard by calling the MCP tool indirectly?
- Does taint actually propagate through transformations?
- Can you remove src:mcp taint without a privileged guard?
- Does the policy.labels.src:mcp.deny actually block operations?

## Exit Criteria Check

For each exit criterion, report PASS or FAIL with evidence:
1. Import MCP tools - PASS/FAIL
2. Automatic src:mcp tainting - PASS/FAIL
3. Guard blocking secrets from MCP - PASS/FAIL
4. Policy restricting MCP operations - PASS/FAIL
5. Audit trail of MCP tool usage - PASS/FAIL

Return status: 'verified' if all pass, 'failed' with details if any fail.


**2026-02-04 02:10 UTC:** ADVERSARIAL VERIFICATION COMPLETE - STATUS: failures_found

Two exit criteria failed:

1. FAIL: Guard blocking secrets from MCP - Secret labels are lost when variables are wrapped in object literals (e.g., @echo({ text: @apiKey })). The guard pattern works for direct passing (@echo(@apiKey)) but the demo uses object syntax, which bypasses the guard entirely. The secret sk-12345-super-secret flows through unblocked.

2. FAIL: Policy restricting MCP operations - Policy label flow rules (labels.src:mcp.deny) are not enforced at runtime. The policy object is created but has no effect on operations.

Three exit criteria passed:
- PASS: Import MCP tools works correctly
- PASS: Automatic src:mcp tainting works and propagates through transformations  
- PASS: Audit trail via after-guard works

Results written to j2bd/security/runs/2026-02-03-6/worker-m-9f61-33.json

**2026-02-04 05:08 UTC:** ADVERSARIAL RE-VERIFICATION (run 39): STATUS: failures_found

After fixes 881b32378 (object label propagation) and c48263a81 (policy label flow for template exes):

PASS: EC1 (Import MCP tools), EC2 (Automatic src:mcp taint), EC4 (Policy restricts MCP ops), EC5 (Audit trail)

FAIL: EC3 (Guard blocks secrets from MCP) - Fix 1 is NOT working at runtime. CollectionEvaluator.recordCollectedDescriptors() calls env.recordSecurityDescriptor() but var.ts never retrieves it. Object literals still strip all labels. Secret sk-12345-super-secret flows to MCP tool unblocked via { text: @apiKey }.

Additional finding: Fixture tests for Fix 1 are vacuous smoke tests - build-fixtures.mjs has .mld/.md extension mismatch preventing expected.md from being loaded.

Two bugs to fix: (1) Bridge CollectionEvaluator env-level descriptor to var.ts local accumulator, (2) Fix build-fixtures.mjs line 612 for .mld example files.

**2026-02-04 05:31 UTC:** ADVERSARIAL RE-VERIFICATION (run 41): STATUS: failures_found. After fixes 5f04b9ea0 and c48263a81: PASS EC1,EC2,EC4,EC5. FAIL EC3 - Three bugs: (1) op:exe guards see empty @input for user-defined exe calls, (2) inline object construction at call sites strips labels from guard input, (3) denied handler doesn't catch op:exe guard denials. Fix 1 works for variable-level label propagation but not at guard input preparation stage. Workaround exists (for secret filter) but is too broad. Proxy bypass confirmed. 10 additional adversarial tests run. Results in worker-m-9f61-41.json.

**2026-02-04 05:53 UTC:** **2026-02-04 06:45 UTC:** ADVERSARIAL RE-VERIFICATION (run 44): STATUS: failures_found

After fix 96b14c11c (changed guard from for op:exe to for secret with @mx.op.type == "exe" condition):

PASS: EC1 (Import MCP tools), EC2 (Automatic src:mcp taint), EC4 (Policy restricts MCP ops), EC5 (Audit trail)

FAIL: EC3 (Guard blocks secrets from MCP) - The for secret guard correctly blocks secrets passed through user-defined exe wrappers and secrets in pre-assigned object variables. BUT inline object construction at direct MCP call sites bypasses the guard: @echo({ text: @apiKey }) outputs sk-12345-super-secret with no guard warning.

Root cause: Inline objects at exe call sites do not propagate constituent labels to guard input. Fix 5f04b9ea0 fixed var-assigned objects but call-site code path skips label propagation.

Additional adversarial tests: interpolation bypass (PASS), array wrapping (PASS), nested objects (PASS), taint laundering (PASS), inline object bypass (FAIL confirms EC3).

Results in worker-m-9f61-44.json. 20 test files in tmp/adversarial-*.mld.

**2026-02-04 06:37 UTC:** ADVERSARIAL RE-VERIFICATION (run 54): STATUS: verified. All 5 exit criteria PASS. EC1 (import), EC2 (taint), EC3 (guard blocks secrets), EC4 (policy enforcement), EC5 (audit trail) all verified with concrete proof. 12 additional adversarial bypass tests all passed. Zero bypasses found. Results in worker-m-9f61-54.json.
