---
id: m-6c35
status: closed
deps: []
created: 2026-02-06T02:20:43Z
type: task
priority: 2
assignee: Adam
tags: [j2bd-security, urgency-high, security-fix]
updated: 2026-02-06T02:34:42Z
---
# Redact secret values in guard error messages

## Problem

Guard error messages leak secret-labeled variable values through three channels:
1. `inputPreview` field - shows the raw value of secret variables (e.g., 'sk-12345')
2. `guardInput` field - includes the full Variable object with its value
3. `guardContext` snapshot - includes `input` and `output` variables that carry secret values

This is a security issue: a guard designed to PROTECT secrets inadvertently exfiltrates them in its own error message.

## Evidence

```bash
mlld tmp/excellence-error2-guard-block.mld 2>&1 | grep -c sk-12345
# Returns: 3 (secret appears 3 times in error output)
```

## Root Cause

`buildVariablePreview()` at `interpreter/hooks/guard-pre-hook.ts:278` reads the variable's `.value` property without checking if the variable carries `secret` in its labels. This preview flows into:
- `buildInputPreview()` (line 299) → `inputPreview` in metadata
- `buildDecisionMetadata()` (line 1277) → `guardInput` in metadata  
- `cloneGuardContextSnapshot()` (line 1400) → includes `input`/`output` variables

The error is constructed in `hook-decision-handler.ts:82-99` which passes all these through to `GuardError`.

## Fix

1. **`buildVariablePreview()`** (guard-pre-hook.ts:278): Check if `variable.mx?.labels` includes `'secret'`. If so, return `'[REDACTED]'` instead of the actual value.

2. **`buildInputPreview()`** (guard-pre-hook.ts:299): For `perInput` scope, check `perInput.labels` for `'secret'` before calling `buildVariablePreview()`. Return `'[REDACTED]'` if secret.

3. **`buildDecisionMetadata()`** (guard-pre-hook.ts:1277): When `extras?.inputVariable` has labels including `'secret'`, set `metadata.guardInput` to a redacted placeholder instead of the actual variable.

4. **`cloneGuardContextSnapshot()`** (guard-pre-hook.ts:1400): When cloning `input`/`output`, check if they carry secret labels and redact the value/text properties.

The pattern for checking: `Array.isArray(variable.mx?.labels) && variable.mx.labels.includes('secret')`

Also check for `'sensitive'` label since it has similar protection requirements.

## Test

After the fix:
```bash
mlld tmp/excellence-error2-guard-block.mld 2>&1 | grep -c sk-12345
# Should return: 0
mlld tmp/excellence-error2-guard-block.mld 2>&1 | grep -c REDACTED  
# Should return: >= 1
```

