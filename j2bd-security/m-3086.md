---
id: m-3086
status: closed
deps: []
created: 2026-02-05T15:04:30Z
type: task
priority: 2
assignee: Adam
tags: [urgency-high, bug]
updated: 2026-02-05T15:09:03Z
---
# Fix isDenied() to handle normalized network structure

## Bug

`isDenied()` in `core/policy/guards.ts:519-527` doesn't handle the normalized network capability structure.

When `deny: ["network"]` is specified:
1. It gets normalized to `{ network: { domains: ["*"] } }` in union.ts
2. But isDenied() only checks `denyValue === true` or `Array.isArray(denyValue) && denyValue.includes('*')`
3. The `{ domains: ["*"] }` object doesn't match either condition
4. So the network deny guard never fires

## Evidence

Adversarial test in `tmp/adversarial-test-network-deny-correct.mld`:
```mlld
var @policyConfig = { deny: { network: true } }
policy @p = union(@policyConfig)
run cmd { curl -s https://httpbin.org/get }
```

Expected: Network access denied
Actual: curl succeeds, network request goes through

## Fix

In `isDenied()` at line 519, add handling for the network object structure:

```typescript
function isDenied(
  capability: string,
  deny: Record<string, unknown>
): boolean {
  const denyValue = deny[capability];
  if (denyValue === true) return true;
  if (Array.isArray(denyValue) && denyValue.includes('*')) return true;
  // Handle normalized network structure: { domains: ["*"] }
  if (typeof denyValue === 'object' && denyValue !== null && !Array.isArray(denyValue)) {
    const obj = denyValue as Record<string, unknown>;
    if ('domains' in obj) {
      const domains = obj.domains;
      if (Array.isArray(domains) && domains.includes('*')) return true;
    }
  }
  return false;
}
```

## Verification

After fix, this test should fail with 'Network access denied by policy':
```bash
mlld tmp/adversarial-test-network-deny-correct.mld
```

