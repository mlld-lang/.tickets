---
id: m-4902
status: closed
deps: []
created: 2026-02-05T19:03:23Z
type: task
priority: 2
assignee: Adam
tags: [impl, urgency-high, label-flow, policy-operations]
updated: 2026-02-05T19:09:37Z
---
# Implement policy.operations mapping for label-flow checks

## Gap Analysis

The Target Example in the prevent-exfil job uses `policy.operations: { "net:w": exfil }` syntax, but this field doesn't exist in PolicyConfig. Current implementation only checks for `exfil`, `destructive`, `privileged` directly on exe labels.

## What Needs to Change

### 1. Add `operations` field to PolicyConfig (core/policy/union.ts)

```typescript
export type PolicyConfig = {
  // ... existing fields
  operations?: Record<string, string>;  // Maps semantic labels to risk categories
};
```

### 2. Merge operations during policy union (core/policy/union.ts)

Add `operations: mergePolicyOperations(base.operations, incoming.operations)` to `mergePolicyConfigs()`.

### 3. Resolve operation labels in label-flow.ts

In `checkLabelFlow()`, after building `opTargets`, expand any labels that have mappings:

```typescript
// Before checking rules:
const expandedOpTargets = expandOperationLabels(opTargets, policy.operations);

function expandOperationLabels(targets: string[], mappings?: Record<string, string>): string[] {
  if (!mappings) return targets;
  const expanded = new Set(targets);
  for (const target of targets) {
    const mapped = mappings[target];
    if (mapped) expanded.add(mapped);
  }
  return Array.from(expanded);
}
```

### 4. Update grammar if needed

Check if `operations:` key is already parseable in policy blocks. If not, add it.

## Example After Implementation

```mlld
exe net:w @postToServer(data) = run cmd { curl -d "@data" ... }

policy @config = {
  operations: {
    "net:w": "exfil"      // Maps semantic label to risk category
  },
  defaults: { rules: ["no-secret-exfil"] }
}

var secret @key = "sk-live-12345"
@postToServer(@key)  // BLOCKED: secret â†’ exfil (via net:w mapping)
```

## Tests

1. Add test in label-flow.test.ts showing operations mapping works
2. Verify target example code runs
3. Verify unmapped labels still work (no regression)


**2026-02-05 19:09 UTC:** Ready for Phase 4 adversarial verification. The Target Example's policy.operations syntax is now implemented and tested at the unit level. Need to verify end-to-end with actual mlld execution.
