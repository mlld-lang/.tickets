---
id: m-80f9
status: closed
deps: []
created: 2026-01-29T19:05:15Z
type: task
priority: 0
assignee: Adam
tags: [scope-interpreter, risk-m, size-s]
updated: 2026-01-29T19:15:56Z
---
# Audit mergeChild usage for scoping bugs

**COMPLETED** - All 4 files audited. No issues found.

## Audit Results

| File | Calls | Status |
|------|-------|--------|
| `env.ts` | 1 | ✅ SAFE |
| `exe.ts` | 1 | ✅ SAFE |
| `when-expression.ts` | 3 | ✅ SAFE |
| `when.ts` | 4 | ✅ SAFE |

## Scoping Model

The `mergeChild()` function correctly filters block-scoped bindings:

| Variable Source | `mx.importPath` | Filtered? |
|-----------------|-----------------|-----------|
| `let @x = ...` | `'let'` | ✅ Skipped |
| exe parameter | `'exe-param'` | ✅ Skipped |
| `var @x = ...` | `undefined` | ❌ Merges (intentional) |

This is correct behavior:
- `let` and exe parameters are block-scoped and should NOT leak
- `var` definitions inside blocks SHOULD persist (e.g., `when @x => [var @y = 1]` makes `@y` accessible after)

## Detailed Findings

### env.ts (line 153)
Merges after `@env` block execution. Safe - exe-param and let are filtered.

### exe.ts (line 87)
Merges after exe block execution. Safe - this is where the m-6959 fix was applied.

### when-expression.ts (lines 308, 552, 647)
All three merge action results. Safe - bound values use `importPath: 'let'`.

### when.ts (lines 382, 488, 508, 638)
Lines 382/488/508 merge block actions. Line 638 merges `result.env` from evaluating conditions. All safe - let assignments processed separately, and var definitions intentionally persist.

## Conclusion

The fix for m-6959 (adding `exe-param` to the filter) completes the scoping model. No API changes needed.

