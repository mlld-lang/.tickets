---
id: m-434a
status: closed
deps: []
links: []
created: 2026-02-06T21:42:42Z
type: bug
priority: 1
assignee: Adam Avenir
tags: [when, exe, interpreter, dx]
---
# WhenExpression values silently discarded in exe blocks

## Bug

A `WhenExpression` that produces a non-null value as a statement inside an exe block silently discards the value. The same pattern works correctly in for-blocks and as an exe body.

## Reproduction

```mlld
exe @guard(x) = [
  when !@x => "missing"    >> value silently dropped!
  => "ok: @x"
]
show @guard(null)   >> prints "ok: null" — should print "missing"
```

Also affects match form:
```mlld
exe @route(action) = [
  when @action [
    "greet" => "Hello!"
    "bye" => "Goodbye!"
  ]
  => "fallback"
]
show @route("greet")   >> prints "fallback" — should print "Hello!"
```

## Root cause

`interpreter/eval/exe.ts:83-118` — the exe block statement loop calls `evaluate(stmt, blockEnv)` for WhenExpression nodes and only checks `isExeReturnControl()` on the result. A WhenExpression returns a plain value, not an ExeReturnControl wrapper, so the value is ignored.

The for-block evaluator (`for.ts:862-874`) has explicit WhenExpression handling that checks for non-null results and breaks out of the statement loop. The exe-block evaluator lacks this.

## Inconsistency

- `exe @f(x) = when @x [...]` (when AS body) → works, returns matched value
- `exe @f(x) = [when @x [...]; => "fallback"]` (when IN block) → drops when value, always returns "fallback"
- `for @x in @xs [when @x [...]; => "fallback"]` (when in for-block) → when value wins, for-block breaks on non-null

## Fix approach

Add WhenExpression-aware handling to the exe block evaluator in `exe.ts`, similar to `for.ts:862-874`. When a WhenExpression produces a non-null value in an exe block, treat it as an early return (same as `isExeReturnControl`).

Need to handle the `__whenEffect` flag (side-effect actions like show/output that shouldn't trigger early return).

## Workaround

Use explicit block + return arrow:
```mlld
exe @guard(x) = [
  when !@x => [=> "missing"]     >> works: block form with return arrow
  if !@x [=> "missing"]          >> works: if block with return arrow
  => "ok: @x"
]
```

