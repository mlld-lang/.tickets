---
id: m-0079
status: closed
deps: [m-b1e3]
created: 2026-02-24T16:51:11Z
type: feature
priority: 0
assignee: codex
tags: [security, policy, sh]
updated: 2026-02-27T06:48:40Z
---
# Commands blocked via deny/deny_cmd should also be blocked in sh blocks via regex

## Problem

If a user blocks `cmd:npm:run:*`, they expect npm run to be blocked everywhere. But a user can still run `run sh { npm run malicious-script }` because sh blocks are raw shell — the deny system doesn't inspect sh block contents.

## Expected behavior

When a command pattern is denied (e.g. `cmd:npm:run:*`), the same pattern should be enforced inside sh blocks via regex matching on the sh block body BEFORE execution. This way you don't need to separately write `sh:npm:run:*` — denying a command blocks it everywhere.

## Implementation notes

Before executing any sh block, scan the block body against all denied command patterns. If any pattern matches, deny the execution with a clear error message explaining which deny rule was triggered.

