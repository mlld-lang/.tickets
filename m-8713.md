---
id: m-8713
status: closed
deps: []
created: 2026-02-16T17:08:11Z
type: task
priority: 1
assignee: Adam
tags: [investigate, interpreter, p1, qa-driven]
updated: 2026-02-17T21:08:33Z
---
# investigate: @mx.tools.calls may contain duplicate entries

## Problem

QA found that `@mx.tools.calls` may contain duplicate entries for a single exe invocation. An exe called once showed up multiple times in the calls array.

## Caveat

This needs investigation before confirming as a bug. It's possible that:
- Multiple calls legitimately produce multiple entries (e.g., template interpolation triggers additional internal calls)
- The test methodology was flawed (QA agent may have been counting wrong)

## QA finding

Experiment 08-H-scope-persistence in qa/runs/2026-02-16-0/topics/tool-call-tracking/:
- Called `@innerCall()` once via `var @result = @innerCall()`
- `@mx.tools.calls` showed the call twice
- Self-review concluded: genuine-bug, likely cause is `@mx.tools.calls` getting appended during template interpolation or show operations

## Investigation steps

1. Write a minimal repro:
```mlld
exe @a() = "hello"
exe @b() = "world"
var @x = @a()
var @y = @b()
var @z = @a()
show @mx.tools.calls
show @mx.tools.calls.length
```
Expected: ["a", "b", "a"] with length 3

2. Check the implementation: search for where `@mx.tools.calls` is appended to
   - `interpreter/env/ContextManager.ts` is listed in related-code for tool-call-tracking atom
   - Look for push/append operations on the tools.calls array

3. If duplicates exist, determine whether they represent real internal calls (by design) or double-counting (bug)

## Source
QA run: qa/runs/2026-02-16-0/topics/tool-call-tracking/ experiment 08


**2026-02-17 21:08 UTC:** Not reproducible. Tested 6 scenarios (basic multi-call, single var assignment, show direct, params+template interpolation, nested exe calls, mx.tools.calls var assignment) â€” all produced correct counts with no duplicates. Code analysis confirms single recording point per invocation in evaluateExecInvocation(). Likely flawed QA test methodology.
