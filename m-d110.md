---
id: m-d110
status: closed
deps: []
created: 2026-01-29T20:01:43Z
type: feature
priority: 2
assignee: Adam
updated: 2026-01-30T01:50:38Z
---
# Add simple @var? omission and ?? null coalescing operator

## Summary

Add two related features for cleaner conditional variable handling in templates:

1. **Simple `@var?` omission** - variable interpolation that outputs nothing if falsy
2. **`??` null coalescing operator** - provide fallback values

## Current State

Currently, conditional inclusion requires verbose syntax:
```mlld
`DEBUG@title?`: @title``  >> repeats variable name
```

## Proposed Syntax

### 1. Simple `@var?` (omits if falsy)
```mlld
`DEBUG: @title?`  
>> "DEBUG: MyTitle" (if title="MyTitle")
>> "DEBUG: " (if title="" or undefined)
```

### 2. `??` null coalescing

**Inside templates** (tight binding, no spaces):
```mlld
`DEBUG: @title??"unnamed"`
`DEBUG: @title??'unnamed'`
```

**Outside templates** (spaces allowed):
```mlld
var @name = @title ?? "unnamed"
var @name = @title??"unnamed"  >> also works
```

## Use Case

Conditional debug logging in pipelines:
```mlld
exe @debuglog(input,title) = when [@debugMode => @input | log `=== DEBUG: @title? ===
@input
========`]
```

## Grammar Changes Required

### New AST Node Types

1. **`ConditionalVarOmission`** - For `@var?` standalone
2. **`NullCoalescingTight`** - For `@var??"default"` tight binding in templates

### Grammar Rules to Add

**In `grammar/patterns/conditional-inclusion.peggy`:**

```peggy
// @var? standalone - negative lookaheads ensure no template/coalesce follows
ConditionalVariableOmission "conditional variable omission"
  = "@" id:BaseIdentifier fields:AnyFieldAccess* "?" !"`" !"?" !'"' { ... }

// @var??"default" tight binding for templates
NullCoalescingTight "tight null coalescing"
  = "@" id:BaseIdentifier fields:AnyFieldAccess* "??" default:(
      '"' content:EscapedDoubleStringContent '"' { ... }
    / "'" content:EscapedSingleStringContent "'" { ... }
    ) { ... }
```

### Template Interpolation Updates

**In `grammar/base/unified-quotes.peggy` and `grammar/base/unified-templates.peggy`:**

Update interpolation rules with this order (first match wins):
1. `ConditionalTemplateSnippet` - `@var?`...`` (most specific)
2. `NullCoalescingTight` - `@var??"default"` (must come before #3)
3. `ConditionalVariableOmission` - `@var?` (least specific)

### Type Definitions

**In `core/types/primitives.ts`:**
```typescript
export interface ConditionalVarOmissionNode extends BaseMlldNode {
  type: 'ConditionalVarOmission';
  variable: VariableReferenceNode;
}

export interface NullCoalescingTightNode extends BaseMlldNode {
  type: 'NullCoalescingTight';
  variable: VariableReferenceNode;
  default: { type: 'string'; quote: 'single' | 'double'; value: string; };
}
```

### Interpreter Changes

**In `interpreter/utils/interpolation.ts`:**

Add handlers for both new node types in the interpolation loop.

### Files to Modify

| File | Change |
|------|--------|
| `grammar/patterns/conditional-inclusion.peggy` | Add new rules |
| `grammar/base/unified-quotes.peggy` | Update `UnifiedBacktickInterpolation` |
| `grammar/base/unified-templates.peggy` | Update `UnifiedAtInterpolation` |
| `core/types/primitives.ts` | Add node interfaces |
| `core/types/values.ts` | Update `ContentNodeArray` |
| `interpreter/utils/interpolation.ts` | Add handlers |

### Potential Ambiguities (Resolved)

- **`@var??`** - Require default value after `??` in tight binding
- **`@var?` vs `@var??`** - Match `??` first via rule ordering
- **Nested quotes** - Use standard escape handling

### Recommendations

1. **Phase 1**: Implement `ConditionalVarOmission` first (simpler)
2. **Phase 2**: Implement `NullCoalescingTight`
3. Consider whether to support pipes: `@title?|upper`, `@title??"default"|upper`

### Note on Existing `??` Support

The loose `??` operator already exists in `UnifiedExpression` for outside-template contexts like `var @name = @title ?? "default"`. The tight binding is only needed for template interpolation.

