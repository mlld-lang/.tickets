---
id: m-3726
status: closed
deps: []
created: 2026-02-25T15:36:59Z
type: bug
priority: 0
updated: 2026-02-25T19:31:45Z
---
# --append-json flag does not write to file

## Bug

The `--append-json` CLI flag is supposed to save raw NDJSON events to a file during streaming. A WriteStream is created but never receives any data.

## Reproduce

Create `tmp/repro-append-json.mld`:

```mlld
exe @llm(p) = cmd {echo '{"type":"text","text":"hello"}'}
run stream @llm("test") with { streamFormat: "claude-code" }
```

Run: `mlld tmp/repro-append-json.mld --append-json tmp/captured.jsonl`

Check: `cat tmp/captured.jsonl`

**Actual:** `tmp/captured.jsonl` does not exist or is empty.
**Expected:** `tmp/captured.jsonl` contains the raw NDJSON events, one per line.

## What to fix

Wire the `--append-json` flag through from CLI parsing to the streaming pipeline. When enabled, each raw NDJSON chunk should be appended to the target file. The OptionProcessor needs to pass the file path into StreamingOptions, and the StreamingManager (or a sink) needs to write to it. The WriteStream in ShellCommandExecutor already exists but is never fed data â€” either use it or replace it with a proper sink.

## Verify

Run the repro with `--append-json tmp/captured.jsonl`. Confirm the file exists and each line is valid JSON. Formatted output should still appear on stdout.

## Acceptance Criteria

`mlld script.mld --append-json output.jsonl` writes every raw NDJSON event to the file during streaming execution.

**2026-02-25 19:31 UTC:** Wired --append-json through streaming options and raw NDJSON file append sink with tests (commit 938cc7967).
