---
id: m-9900
status: closed
deps: []
created: 2026-02-15T22:41:02Z
type: bug
priority: 0
assignee: Adam
updated: 2026-02-15T23:16:24Z
---
# Support 'using auth:name' in var assignment

## Problem

This syntax parses successfully:
```mlld
run cmd { echo "hello" } using auth:testkey
exe @fn() = run cmd { echo "hello" } using auth:testkey
env @cfg [ run cmd { echo "hello" } using auth:testkey ]
```

But this fails to parse:
```mlld
var @result = run cmd { echo "hello" } using auth:testkey
```

Error: "Text content not allowed in strict mode" at the ` using` text after the closing `}`.

## Root Cause

File: `/Users/adam/dev/mlld/grammar/patterns/var-rhs.peggy` lines 453-464

The `CodeExecution` rule (used for `var @x = run cmd {}` patterns) does NOT include `using:UsingClause?`:

```peggy
CodeExecution
  = "run" _ kind:CommandKind _ braces:CommandBraces {
      // NO using:UsingClause? here
  }
```

Meanwhile, these rules DO include `using:UsingClause?`:
- `SlashRun` in `grammar/directives/run.peggy` line 144
- `ExeRunCommandPattern` in `grammar/patterns/exe-rhs.peggy` line 248
- `RunBlockAction` in `grammar/patterns/run-action.peggy` line 122

## Fix

In `/Users/adam/dev/mlld/grammar/patterns/var-rhs.peggy` lines 453-464:

Change the `CodeExecution` rule to include `using:UsingClause?`:

```peggy
CodeExecution
  = "run" _ kind:CommandKind _ braces:CommandBraces using:UsingClause? {
      return {
        type: 'CodeExecution',
        kind,
        command: braces.command,
        using: using || undefined,  // Add this field
        location: location()
      };
  }
```

The `UsingClause` grammar is already defined in `/Users/adam/dev/mlld/grammar/patterns/with-clause.peggy` lines 110-118.

## Acceptance Criteria

1. This syntax must parse without errors:
   ```mlld
   var @result = run cmd { echo "API: $KEY" } using auth:testkey
   ```

2. The AST must include a `using` field with the auth credential info

3. Create test case in `tests/cases/feat/` showing var assignment with using auth works

4. Verify the using clause is actually processed during var evaluation (check that auth injection happens)

5. Run `npm test` - all existing tests must pass

6. Run `npm run build:grammar` to regenerate parser files

## Related Files

- `/Users/adam/dev/mlld/grammar/patterns/var-rhs.peggy` (lines 453-464) - THE FIX GOES HERE
- `/Users/adam/dev/mlld/grammar/patterns/with-clause.peggy` (lines 110-118) - UsingClause definition
- `/Users/adam/dev/mlld/interpreter/eval/var/rhs-dispatcher.ts` - May need to handle the `using` field
- Investigation: agent a2b1fd0 full report

**2026-02-15 23:16 UTC:** Implemented support for 'var @x = run cmd { ... } using auth:name' by parsing using clauses in var RHS command branches, preserving command-node metadata (including using) through var directive normalization, and merging node-level using into synthetic run withClause during var execution. Added grammar regression test and feature fixture coverage with policy auth env injection. Validation: npm run build:grammar; npx vitest run grammar/tests/regression/var-run-using-auth.test.ts; npx vitest run interpreter/interpreter.fixture.test.ts -t 'feat/var-assignment-using-auth'; npm test. Commit: 8c196e395.
