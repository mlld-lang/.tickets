---
id: m-396d
status: closed
deps: []
created: 2026-02-09T08:41:30Z
type: bug
priority: 2
assignee: Adam Avenir
updated: 2026-02-09T22:37:51Z
---
# Op-run subtype not reflected in guard matching

tests/cases/security/op-run-subtype-guard: /run node subtype not captured in @mx.op.subtype for guard matching. Guard checking @mx.op.subtype == 'node' doesn't fire.


**2026-02-09 22:37 UTC:** Fixed run-code operation subtype timing for guards. Root cause: pre-guards evaluate operation context before evaluateRun updates it, so @mx.op.subtype remained runCode. Updated interpreter/eval/directive.ts applyRunMetadata to map runCode language to op subtype (node/sh/js/py/prose) during buildOperationContext, before guard evaluation. Kept metadata.runSubtype for existing key matching. Also updated run.ts op-context updates to carry resolved subtype. Removed skip for security/op-run-subtype-guard, rebuilt fixtures, and verified with npx vitest run interpreter/interpreter.fixture.test.ts -t 'op-run-subtype-guard' (passing).
