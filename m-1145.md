---
id: m-1145
status: closed
deps: []
links: []
created: 2026-01-29T05:01:05Z
type: bug
priority: 0
assignee: Adam
tags: [interpreter, when, grammar, breaking-change]
---
# Fix when semantics: => inside blocks should return from enclosing exe

## Problem

`when condition [block; => value]` looks like early return but doesn't return. This causes bugs everywhere - the polish pipeline had this issue in nearly every phase file.

## Decision: Four Valid Forms

1. **Multi-match (all matching conditions run, side effects only):**
```mlld
when [
  @error => show "error"
  @warning => show "warning"
]
```

2. **Switch/first-match (returns first match):**
```mlld
when first [
  @error => null
  @warning => @data
  * => "default"
]
```

3. **Single-line:**
```mlld
when @verbose => show "extra info"
```

4. **Single-line with block (=> inside returns from exe):**
```mlld
when @error => [
  show "Error occurred"
  => null  // Returns from enclosing exe
]
```

## Deprecated Form

```mlld
// This form goes away:
when @condition [
  statements
  => value  // Currently doesn't return - confusing!
]
```

## Key Semantic Change

`=>` inside ANY block should return from the enclosing `exe`, not just be a discarded expression. This makes `=>` consistent everywhere.

## Implementation

1. Start by reviewing all existing `when` tests in tests/cases/
2. Adjust tests to match new expectations
3. Implement grammar changes to deprecate the confusing form
4. Update interpreter to propagate `=>` returns through blocks

