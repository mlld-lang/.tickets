---
id: m-f365
status: closed
deps: [m-ce6f, m-3891, m-3f0a, m-12ab]
created: 2026-02-05T03:10:07Z
type: bug
priority: 1
assignee: Adam
updated: 2026-02-05T08:36:16Z
---
# Keychain sealed path is architectural, not enforced

**Problem**: The 'sealed path' for credentials is described as security but is only architectural (bypasses interpolation). No policy enforcement prevents labeled secrets from leaking.

**What works**:
- macOS keychain reading ✓
- `policy.auth` with `using auth:name` injects to env var ✓
- Credentials bypass string interpolation (architectural) ✓

**What's missing**:
- No policy enforcement on `using auth:*` (no checkLabelFlow call)
- No default guards for secret labels (see related ticket)
- Three separate code paths conflated in docs

**Evidence**:
- Adversarial tests 2-3: secrets freely shown/interpolated
- No `checkLabelFlow()` call after `resolveUsingEnvParts()` in run.ts:548
- No taint tracking for injected env vars

**Gap**: After line 548-549 in run.ts, should add policy check for auth injection.

**Expected**: Credentials from keychain or marked secret should be protected by policy, not just architectural isolation.

**Files**: `interpreter/eval/run.ts`, `interpreter/utils/auth-injection.ts`

## Plan
- Implement `policy.keychain.allow/deny` matching (service/account globs with `{projectname}` expansion) in `interpreter/policy/keychain-policy.ts`.
- Enforce keychain policy and danger gating in both auth injection (`resolveAuthValue`) and direct keychain resolver calls (`@keychain.get/set/delete`) so direct access is blocked unless explicitly allowed.
- Add an explicit policy check hook for `using auth:*` so the operation records the auth path and produces a clear denial reason when keychain access is blocked.
- Keep sealed-path semantics: no auto-taint propagation from `using auth:*` into outputs; apply this consistently in `run.ts` and exec-invocation paths.
- Add tests for keychain allow/deny, missing projectname, danger gating, and `using auth:*` denial messaging.
- Update policy-auth and keychain docs to describe enforcement and the sealed-path behavior.
