---
id: m-989e
status: closed
deps: [m-b814, m-a2fc]
created: 2026-02-05T03:10:06Z
type: bug
priority: 0
assignee: Adam
updated: 2026-02-05T06:20:16Z
---
# capabilities.deny parsed but not enforced

**Problem**: Policy `capabilities.deny` lists are correctly parsed and merged (union semantics) but don't actually block operations.

**What works**:
- `capabilities.allow` IS enforced ✓ (via __policy_cmd_access guard)
- Composition merges deny lists correctly (union) ✓
- Special cases: `deny: ["sh"]` creates __policy_deny_sh guard ✓

**What's broken**:
- Arbitrary `deny.cmd` patterns are NOT enforced
- `evaluateCommandAccess()` has deny checking code (lines 333-340) but it's not being called effectively
- Only hardcoded guards for 'sh' and 'network', no generic deny enforcement

**Evidence**:
- Adversarial test 6: `deny: ["sh"]` → shell executes anyway
- Adversarial test 8: `deny: ["cmd:git:push"]` with `allow: ["cmd:git:*"]` → push executes
- Test 7 shows allow works correctly (blocks curl when not in allowlist)

**Asymmetry**:
- allow = universal guard + enforcement ✓
- deny = hardcoded guards only, no generic mechanism ✗

**Expected**: `capabilities: { deny: ["cmd:git:push", "sh"] }` should block those commands.

**Files**: `core/policy/guards.ts`, `core/policy/guards-command-access.ts`

## Plan
- Add a runtime capability check for `/run cmd` and command-style `/exe` using the interpolated command text (reuse `evaluateCommandAccess` and the pipeline denial error shape).
- Ensure the operation context stores the interpolated command before the check so denial messages use the real command preview.
- Enforce non-command capabilities (`sh`, `js`, `node`, `py`, `prose`, `network`) in the `/run` code path and exec-invocation path using policy allow/deny maps.
- Preserve deny precedence over allow and keep danger gating intact.
- Add integration tests for: `deny: ["sh"]` on `/run sh`, `deny: ["cmd:git:push"]` with `allow: ["cmd:git:*"]`, interpolated commands, and `deny: ["network"]` with a known network command.
- Update policy capability docs/examples to note that denies evaluate against the interpolated command.
