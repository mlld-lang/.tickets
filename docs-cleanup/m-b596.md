---
id: m-b596
status: closed
deps: []
created: 2026-02-17T23:08:29Z
type: task
priority: 3
assignee: Adam Avenir
updated: 2026-02-18T08:04:55Z
---
# Docs consolidation: de-duplicate OUTPUT.md and STREAMING.md

Reduce overlap between output and streaming architecture docs.\n\nDecision path:\n- Either merge into one canonical output/streaming architecture doc,\n- Or keep both files but enforce strict boundaries (OUTPUT = intent/effect/document assembly; STREAMING = stream bus/sinks/adapters/runtime event flow).

## Acceptance Criteria

- Duplicate sections removed.\n- Chosen boundary/merge strategy documented in frontmatter and tldr sections.\n- INTERPRETER.md and ARCHITECTURE.md links point to canonical locations.


**2026-02-17 23:37 UTC:** Doc-audit input (source: `llm/run/doc-audit/tmp/results.json`) for this ticket.
This input MUST be verified with 100% confidence during implementation.

Files in scope to verify:
- `docs/dev/OUTPUT.md` [mostly-current]: Core architecture is accurate but normalizer rules are significantly understated, and the traversal file reference is wrong
- `docs/dev/STREAMING.md` [outdated]: Several interface definitions and file paths are wrong; StructuredResult.streaming shape is substantially incorrect; guard check file is misattributed

Verification bar (required):
- Confirm or disprove each finding for the files above against current code/docs with 100% confidence.
- If disproved, record why with concrete file references.
- If confirmed, update docs in this ticket scope and keep links/frontmatter consistent.

**2026-02-18 00:35 UTC:** Verified against current code. Decision: keep BOTH docs, but enforce strict boundary (no merge).
Boundary: OUTPUT owns intent/effect/document assembly + normalization. STREAMING owns StreamBus/sinks/adapters/SDK stream event flow.

Confirmed audit findings:
- OUTPUT normalizer rules are understated.
- OUTPUT traversal file reference is wrong.
- STREAMING interface/type/path details are stale.
- STREAMING StructuredResult.streaming shape is wrong.
- STREAMING guard check location is misattributed.

Decisive change list

1) docs/dev/OUTPUT.md
- Add frontmatter + tldr boundary statement: this file is canonical for OutputIntent, OutputRenderer, intent->effect mapping, and normalizeOutput.
- Expand normalizer rules to match `interpreter/output/normalizer.ts` exactly:
  - strip leading newlines,
  - strip trailing whitespace per line,
  - enforce blank line before headers,
  - enforce blank line after headers,
  - insert paragraph spacing between non-header/non-list lines,
  - collapse 3+ newlines to 2,
  - ensure single trailing newline,
  - protect frontmatter/code fences/tables during normalization.
- Correct break-collapsing example: renderer preserves up to TWO collapsible breaks (3+ -> 2), not “adjacent collapsible breaks -> single break”.
- Fix related code reference from `interpreter/core/interpreter.ts` to `interpreter/core/interpreter/traversal.ts` (and optionally mention `interpreter/core/interpreter/evaluator.ts` for document node emission).
- Remove or minimize streaming internals duplicated from STREAMING.md; keep only a short cross-link section.
- Do NOT change accurate sections: OutputIntent type mapping (`content|break|progress|error`) and Environment intent->effect routing in `intentToEffect`.

2) docs/dev/STREAMING.md
- Keep file as canonical for streaming runtime/event flow, and state that in frontmatter/tldr.
- Correct sink-selection details:
  - `StreamingManager.configure()` uses `FormatAdapterSink` only when an adapter is provided; otherwise it wires `TerminalSink` + `ProgressOnlySink`.
  - `/run ... with { stream: true }` WITHOUT `streamFormat` does not automatically use adapter parsing.
  - Exec-invocation streaming setup can default to `ndjson` adapter (from `interpreter/eval/exec/streaming.ts`).
- Guard check location: change from `interpreter/hooks/guard-post-hook.ts` to `interpreter/hooks/guard-post-orchestrator.ts` (where `operation.metadata.streaming` is enforced).
- Update StreamAdapter/ParsedEvent definitions to match `interpreter/streaming/adapters/base.ts`:
  - `format: 'ndjson' | 'sse' | 'text'` (not `custom`),
  - include `reset()` on adapter,
  - `templates` is `EventTemplate`, not generic record.
- Fix adapter-emitted SDK event names to hyphenated forms:
  - `streaming:tool-use`, `streaming:tool-result` (not underscore variants).
- Replace StructuredResult.streaming snippet with real `StreamingResult` shape from `sdk/types.ts`:
  - `text?`, `thinking?`, `toolCalls?`, `usage?`, `errors?`, `events?`.
- Correct ExecutionEmitter bridge wording:
  - bus->SDK mapping is implemented in Environment (`enableSdkEmitter`/`emitMappedSdkEvents` in `interpreter/env/Environment.ts`), while `ExecutionEmitter` is pub/sub.
- Correct async-iterator claim:
  - `StreamExecution` async iterator currently subscribes to a fixed event subset and is NOT equivalent to “all events available via .on(...)”.
- Remove stale gotcha about “parallel groups return first result only without fix”; helper now returns aggregated structured output via pipeline execution.
- Do NOT change accurate points: explicit stream opt-in, after-guards incompatible with streaming, and StreamBus core event families.

3) docs/dev/INTERPRETER.md and docs/dev/ARCHITECTURE.md
- Update references so canonical locations are explicit and non-overlapping:
  - OUTPUT.md for intent/effect/normalization,
  - STREAMING.md for StreamBus/sinks/adapters/SDK stream-mode flow.
- Keep links to both docs, but annotate boundary in the link text or surrounding sentence so there is no ambiguity.
