---
id: m-4766
status: closed
deps: []
created: 2026-02-17T23:13:04Z
type: task
priority: 2
assignee: Adam Avenir
updated: 2026-02-18T07:22:40Z
---
# Fold TRANSFORMERS.md into PIPELINE.md and DATA.md

Consolidate transformer architecture into pipeline and data docs.

## Acceptance Criteria

- Transformer runtime behavior is covered in docs/dev/PIPELINE.md and/or docs/dev/DATA.md.\n- docs/dev/TRANSFORMERS.md is ready for deletion by the remove ticket.


**2026-02-17 23:37 UTC:** Doc-audit input (source: `llm/run/doc-audit/tmp/results.json`) for this ticket.
This input MUST be verified with 100% confidence during implementation.

Files in scope to verify:
- `docs/dev/PIPELINE.md` [outdated]: Multiple interface signatures are wrong (RetryContext.allAttempts and PipelineState.allRetryHistory use StructuredValue[] not string[]), grammar file path is incorrect, old @exec/@data/@text directive syntax appears in examples, and the Available Transformers list is incomplete.
- `docs/dev/DATA.md` [mostly-current]: Largely accurate; two medium-severity issues: incorrect file path/line reference for show.ts:630 (file is only 158 lines; pattern lives in show/show-invocation-handlers.ts:56), and the Pipelines section misattributes structuredOutputs/previousOutputs to PipelineExecutor when they actually live in state-machine.ts context building.

Verification bar (required):
- Confirm or disprove each finding for the files above against current code/docs with 100% confidence.
- If disproved, record why with concrete file references.
- If confirmed, update docs in this ticket scope and keep links/frontmatter consistent.

**2026-02-17 23:54 UTC:** Verified against current code/docs (100% confidence). Decisive update list:

- `docs/dev/PIPELINE.md`
  - Fix retry type signatures to match runtime state-machine types:
    - `PipelineState.allRetryHistory` must be `Map<string, StructuredValue[]>` (not `Map<string, string[]>`).
    - `RetryContext.allAttempts` must be `StructuredValue[]` (not `string[]`).
    - Source of truth: `interpreter/eval/pipeline/state-machine.ts`.
  - Replace outdated directive syntax examples that use removed directives (`@exec`, `@data`, `@text`).
    - Use current directive forms (`exe`, `var`, `/exe`, `/var`, `/show`, etc.) consistent with current grammar (`grammar/directives/exe.peggy`, `grammar/directives/var.peggy`).
  - Correct outdated grammar/file-organization references:
    - The “Grammar Organization” block currently references non-existent `grammar/directives/data.peggy`.
    - Update to real files currently used for pipeline/collection parsing (e.g., `grammar/patterns/tail-modifiers.peggy`, `grammar/patterns/with-clause.peggy`, `grammar/patterns/foreach.peggy`, `grammar/patterns/iteration.peggy`, plus relevant directive files that actually exist).
  - Refresh Built-in Transformers section to current runtime reality:
    - Registration happens in `Environment.initializeBuiltinTransformers()` (`interpreter/env/Environment.ts`), including uppercase/lowercase aliases and variant wiring.
    - Runtime definitions come from `interpreter/builtin/transformers.ts`.
    - Update “Available Transformers” to include the current set, not just xml/parse/csv/md.
      - Current definitions include: `typeof`, `exists`, `xml`, `parse` (+ `loose|strict|llm|fromlist`), `json` alias (+ variants), `csv`, `md`, `upper`, `lower`, `trim`, `pretty`, `sort`.
    - Update execution-path snippets to current modules (`interpreter/eval/pipeline/command-execution.ts`, `interpreter/eval/exec-invocation.ts`) instead of stale `pipeline.ts` snippets.
  - Fold in still-valid transformer behavior from `TRANSFORMERS.md`:
    - `@parse.llm` extraction semantics (returns `false` when no parseable JSON is found).
    - Structured result continuity via transformer result normalization + structured wrapping in execution flows.

- `docs/dev/DATA.md`
  - Keep the confirmed fixes from current code audit:
    - Replace bad reference `interpreter/eval/show.ts:630` with the real nested-wrapper conversion location in `interpreter/eval/show/show-invocation-handlers.ts` (`toInvocationDisplayValue`, currently line ~56).
    - Correct pipeline ownership wording: `previousOutputs` / `structuredOutputs` context assembly is in `interpreter/eval/pipeline/state-machine.ts` (`buildStageContext`), not owned by `PipelineExecutor`.

- `docs/dev/TRANSFORMERS.md`
  - After the above merges into `PIPELINE.md`/`DATA.md`, this file is ready for deletion.

- Do NOT carry these stale claims into canonical docs:
  - String-only transformer input as a universal rule (runtime paths accept richer values in some invocation contexts).
  - Any snippets tied to removed directive syntax (`@exec`, `@data`, `@text`).
  - Stale line-specific execution references from old module layouts.
