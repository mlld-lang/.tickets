---
id: m-e338
status: closed
deps: []
created: 2026-02-17T23:13:04Z
type: task
priority: 2
assignee: Adam Avenir
updated: 2026-02-18T07:50:04Z
---
# Fold COMMAND-EXECUTION.md into PIPELINE.md and INTERPRETER.md

Move command execution orchestration details into canonical pipeline/interpreter docs.

## Acceptance Criteria

- Command execution architecture is covered in docs/dev/PIPELINE.md and/or docs/dev/INTERPRETER.md.\n- docs/dev/COMMAND-EXECUTION.md is ready for deletion by the remove ticket.


**2026-02-17 23:37 UTC:** Doc-audit input (source: `llm/run/doc-audit/tmp/results.json`) for this ticket.
This input MUST be verified with 100% confidence during implementation.

Files in scope to verify:
- `docs/dev/PIPELINE.md` [outdated]: Multiple interface signatures are wrong (RetryContext.allAttempts and PipelineState.allRetryHistory use StructuredValue[] not string[]), grammar file path is incorrect, old @exec/@data/@text directive syntax appears in examples, and the Available Transformers list is incomplete.
- `docs/dev/INTERPRETER.md` [mostly-current]: Core architecture is accurately described; Quick Map is missing several directives (bail, env, loop) and misidentifies /log's output destination as stdout instead of stderr

Verification bar (required):
- Confirm or disprove each finding for the files above against current code/docs with 100% confidence.
- If disproved, record why with concrete file references.
- If confirmed, update docs in this ticket scope and keep links/frontmatter consistent.

**2026-02-18 00:17 UTC:** Verified against current docs/code. Decisive consolidation list for folding `docs/dev/COMMAND-EXECUTION.md` into `docs/dev/PIPELINE.md` + `docs/dev/INTERPRETER.md`:

## `docs/dev/PIPELINE.md`

- Add a dedicated “Pipeline Command Execution Orchestration” section migrated from `COMMAND-EXECUTION.md`, grounded in current modules under `interpreter/eval/pipeline/`:
  - entrypoint: `command-execution.ts`
  - stable public contracts: `resolveCommandReference(command, env)` and `executeCommandVariable(commandVar, args, env, stdinInput?, structuredInput?, hookOptions?)`
  - orchestration flow: resolve reference -> normalize executable -> bind pipeline params -> policy preflight + guard preflight -> branch handler dispatch (`execute-command`, `execute-code`, `execute-node`, `execute-template`, `execute-command-ref`) -> final result wrapping/descriptor merge.
  - boundary rule: orchestration file composes handlers/utilities; handlers do not depend on orchestrator internals.
- Fix confirmed retry interface drift in docs to match `interpreter/eval/pipeline/state-machine.ts`:
  - `RetryContext.allAttempts` is `StructuredValue[]` (not `string[]`).
  - `PipelineState.allRetryHistory` is `Map<string, StructuredValue[]>` (not `Map<string, string[]>`).
- Fix grammar-path drift in the “Implementation Components / Grammar Organization” area:
  - remove nonexistent `grammar/directives/data.peggy` reference.
  - keep paths that exist now (for example: `grammar/directives/run.peggy`, `grammar/directives/when.peggy`, `grammar/patterns/with-clause.peggy`, `grammar/patterns/command-reference.peggy`, `grammar/patterns/tail-modifiers.peggy`, `grammar/patterns/variables.peggy`).
- Replace stale legacy directive syntax in examples (`@exec`, `@data`, `@text`) with current slash directives (`/exe`, `/var`) and current invocation style.
- Expand the “Available Transformers” section to match current built-ins in `interpreter/builtin/transformers.ts` (not just XML/PARSE/CSV/MD):
  - include currently registered names like `typeof`, `exists`, `upper`, `lower`, `trim`, `pretty`, `sort`, and parse/json variants (`.loose`, `.strict`, `.llm`, `.fromlist`) in addition to xml/csv/md.
- If verification commands from `COMMAND-EXECUTION.md` are copied over, do not include nonexistent `npm run test:examples`.

## `docs/dev/INTERPRETER.md`

- In Quick Map, add missing directives backed by current evaluator files:
  - `/bail` -> `interpreter/eval/bail.ts`
  - `/env` -> `interpreter/eval/env.ts`
  - `/loop` -> `interpreter/eval/loop.ts`
- Correct `/log` destination description in Quick Map:
  - `/log` behavior should be documented as stderr-directed output path (see pipeline builtin effect execution and stream output handling), not stdout.
- Add a short pointer in Quick Map/Exec+Pipelines to the pipeline command-execution orchestration entrypoint (`interpreter/eval/pipeline/command-execution.ts`) after merging that architecture material from `COMMAND-EXECUTION.md`.

## `docs/dev/COMMAND-EXECUTION.md`

- After migration into PIPELINE/INTERPRETER, reduce to a short pointer stub and mark ready for deletion by the remove ticket.
- Do not keep duplicate standalone command-execution architecture docs once canonical sections exist.
