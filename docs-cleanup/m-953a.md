---
id: m-953a
status: closed
deps: []
created: 2026-02-17T23:13:04Z
type: task
priority: 2
assignee: Adam Avenir
updated: 2026-02-18T07:37:05Z
---
# Fold VARIABLE-IMPORTER-EXTRACTION-MAP.md into IMPORTS.md

Merge variable-importer extraction-map guidance into docs/dev/IMPORTS.md.

## Acceptance Criteria

- docs/dev/IMPORTS.md captures still-relevant extraction-map architecture.\n- docs/dev/VARIABLE-IMPORTER-EXTRACTION-MAP.md is ready for deletion by the remove ticket.


**2026-02-17 23:37 UTC:** Doc-audit input (source: `llm/run/doc-audit/tmp/results.json`) for this ticket.
This input MUST be verified with 100% confidence during implementation.

Files in scope to verify:
- `docs/dev/IMPORTS.md` [mostly-current]: Architecture and component names are accurate, but several code examples use wrong function/class signatures and the circular import detection description misrepresents the implementation

Verification bar (required):
- Confirm or disprove each finding for the files above against current code/docs with 100% confidence.
- If disproved, record why with concrete file references.
- If confirmed, update docs in this ticket scope and keep links/frontmatter consistent.

**2026-02-18 00:04 UTC:** Verified against current code. Use this as the decisive merge/update list.

## docs/dev/IMPORTS.md

- Fold in VARIABLE-IMPORTER extraction-map content as a dedicated section under import architecture, but align it to the current split implementation (not the pre-extraction monolith wording).
- Add an explicit VariableImporter composition map with current ownership:
  - `VariableImporter` orchestrates composition only (`interpreter/eval/import/VariableImporter.ts`)
  - export serialization: `variable-importer/ModuleExportSerializer.ts`
  - export-plan and guard validation: `variable-importer/ModuleExportManifestValidator.ts`, `variable-importer/GuardExportChecker.ts`
  - subtype routing: `variable-importer/ImportTypeRouter.ts`, `variable-importer/NamespaceSelectedImportHandler.ts`
  - variable reconstruction: `variable-importer/factory/ImportVariableFactoryOrchestrator.ts` (+ strategy classes)
  - executable/captured-env rehydration: `variable-importer/executable/ExecutableImportRehydrator.ts`, `variable-importer/executable/CapturedEnvRehydrator.ts`
  - binding/policy side effects: `variable-importer/ImportBindingGuards.ts`, `variable-importer/PolicyImportHandler.ts`
  - metadata envelope parsing: `variable-importer/MetadataMapParser.ts`
- Fold regression-hazard bullets from the extraction map, updated to current code names:
  - captured module env serialization recursion control (WeakSet tracking in `VariableImporter.serializeModuleEnv` + `ModuleExportSerializer`)
  - captured shadow env serialize/rehydrate boundaries (`ShadowEnvSerializer.serializeShadowEnvironmentMaps`, `CapturedEnvRehydrator.deserializeShadowEnvs`)
  - metadata/security propagation via `__metadata__` envelope parsing and `VariableMetadataUtils`
  - import binding collision diagnostics from `ImportBindingGuards` (`IMPORT_NAME_CONFLICT` context)
  - namespace policy side effects via `PolicyImportHandler.applyNamespacePolicyImport`
  - optional missing selected imports for `@payload` / `@state` (null-variable synthesis in `NamespaceSelectedImportHandler`)

- Fix signature/API examples that are currently wrong:
  - Path resolution flow must show:
    - `await ImportPathResolver.resolveImportPath(directive)`
    - then `resolveImportType(directive, resolution)` from `ImportTypePolicy.ts`
    - include `resolution.type` union with `'node'`
  - Circular import detection section must not show a private array stack on `ImportSecurityValidator`.
    - Actual stack is `Set<string>` on `ImportResolver` (`interpreter/env/ImportResolver.ts`), delegated through env methods.
    - `ImportSecurityValidator` delegates with `env.isImporting` / `beginImport` / `endImport`.
    - `ModuleContentProcessor` also maintains `globalImportStack` guard for processing entrypoints.
  - Error-handling snippet for `MlldImportError` must use real constructor:
    - `new MlldImportError(message, options)` where options include `code/details/cause/severity/context`
    - remove old `location` + `importContext` constructor shape.
  - Import binding ownership text must attribute `ensureImportBindingAvailable` and `setVariableWithImportBinding` to `ImportBindingGuards` (with `targetEnv` first arg), not to `Environment`.
  - Shadow-env serialization names must be updated:
    - serializer: `serializeShadowEnvironmentMaps` (not `serializeShadowEnvs`)
    - rehydration via `CapturedEnvRehydrator.deserializeShadowEnvs` / exec context deserializer.
  - Lock-version enforcement attribution/signature must be corrected:
    - implemented in `ModuleImportHandler.validateLockFileVersion(resolverContent, env)` inside `ModuleImportHandler.evaluateModuleImport()`.

- Import type table/text should include the currently supported `templates` import type (`ImportTypePolicy.ts`) in addition to module/static/live/cached/local.

## docs/dev/VARIABLE-IMPORTER-EXTRACTION-MAP.md

- After migrating the architecture/seams/hazards content above into `IMPORTS.md`, mark this file ready for deletion.
- Do not preserve duplicate standalone seam docs once merged.
