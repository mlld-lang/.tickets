---
id: m-8b23
status: closed
deps: []
created: 2026-02-17T23:13:04Z
type: task
priority: 2
assignee: Adam Avenir
updated: 2026-02-18T07:29:04Z
---
# Fold EFFECTS.md into OUTPUT.md and STREAMING.md

Consolidate effect architecture into docs/dev/OUTPUT.md and docs/dev/STREAMING.md with clear boundary ownership.

## Acceptance Criteria

- Effect handling ownership is clearly split between OUTPUT and STREAMING docs.\n- No duplicated architecture sections remain.\n- docs/dev/EFFECTS.md is ready for deletion by the remove ticket.


**2026-02-17 23:37 UTC:** Doc-audit input (source: `llm/run/doc-audit/tmp/results.json`) for this ticket.
This input MUST be verified with 100% confidence during implementation.

Files in scope to verify:
- `docs/dev/OUTPUT.md` [mostly-current]: Core architecture is accurate but normalizer rules are significantly understated, and the traversal file reference is wrong
- `docs/dev/STREAMING.md` [outdated]: Several interface definitions and file paths are wrong; StructuredResult.streaming shape is substantially incorrect; guard check file is misattributed

Verification bar (required):
- Confirm or disprove each finding for the files above against current code/docs with 100% confidence.
- If disproved, record why with concrete file references.
- If confirmed, update docs in this ticket scope and keep links/frontmatter consistent.

**2026-02-18 00:01 UTC:** Verified against current code. Use this as the decisive change list.

## docs/dev/OUTPUT.md

- Keep `OUTPUT.md` as the canonical doc for output/effect routing and document assembly ownership.
- Expand the `Normalizer` rules section to match actual behavior in `interpreter/output/normalizer.ts` (current doc is understated):
  - strips leading newlines before normalization
  - preserves frontmatter block boundaries
  - protects fenced code blocks and markdown tables from paragraph/header rewrites
  - strips trailing whitespace per line
  - enforces blank line before headers
  - enforces blank line after headers when followed by non-header text
  - inserts paragraph breaks with JSON/list guards
  - collapses 3+ newlines to max 2
  - enforces single trailing newline
- Update traversal ownership/file refs for text/newline intent emission:
  - replace `interpreter/core/interpreter.ts` pointer with current sources:
    - `interpreter/core/interpreter/traversal.ts` (text/newline/code-fence non-directive intent emission)
    - `interpreter/core/interpreter/evaluator.ts` (document/code-fence intent emission paths)
- Fold in EFFECTS content that belongs to OUTPUT (effect semantics and document assembly), but keep it strictly current-state:
  - effect types and routing (`doc|both|stdout|stderr|file`) from `interpreter/env/EffectHandler.ts`
  - intent->effect routing in `interpreter/env/Environment.ts` (`intentToEffect`, `emitEffect`)
  - append-mode file effect semantics (`mode: 'append'` is notification-only in handler)
  - structured effect/security metadata path (`sdk/types.ts`, `interpreter/index.ts` collectors)
- Do NOT copy speculative/planned sections from `EFFECTS.md` into OUTPUT:
  - no “Current Problem / Desired Architecture / Implementation Plan / Testing Strategy” narrative
  - no claim that `doc` effects currently stream to stdout (they do not in `DefaultEffectHandler`)

## docs/dev/STREAMING.md

- Keep `STREAMING.md` focused on streaming lifecycle, adapters, SDK streaming events, and guard constraints.
- Fix guard implementation attribution:
  - after-guard streaming denial is enforced in `interpreter/hooks/guard-post-orchestrator.ts`
  - `/run` has additional pre-check in `interpreter/eval/run.ts`
  - `guard-post-hook.ts` is only the hook wrapper/delegator
- Correct streaming adapter/type interfaces to match code:
  - `StreamAdapter.format` is `'ndjson' | 'sse' | 'text'` (not `custom`)
  - `StreamAdapter` includes `reset()`
  - `ParsedEvent.raw` and `timestamp` are optional
  - `ParsedEvent.templates` is `EventTemplate` shape (text/ansi/json), not generic `Record<string,string>`
- Correct SDK event names to hyphenated forms everywhere:
  - `streaming:tool-use`, `streaming:tool-result` (not underscore variants)
- Correct `StructuredResult.streaming` shape to `StreamingResult` from `sdk/types.ts`:
  - optional fields: `text`, `thinking`, `toolCalls`, `usage`, `errors`, `events`
  - no nested `{ accumulated, events: ParsedEvent[] }` wrapper
  - `events` are SDK streaming events and only retained when `keepRawEvents: true`
- Update stream-handle claim:
  - do not claim async iterator yields exactly all `.on(...)` events; current iterator subscription set in `sdk/stream-execution.ts` excludes `streaming:*` formatted adapter events
- Tighten sink behavior wording:
  - `StreamingManager` uses terminal+progress sinks when no adapter is configured
  - adapter path is used when adapter is configured (e.g., streamFormat path; exec-invocation setup may default to ndjson)

## docs/dev/EFFECTS.md (source being folded)

- Decompose and migrate stable content into OUTPUT/STREAMING per ownership above.
- Remove duplicated architecture sections once merged.
- Mark `EFFECTS.md` ready for deletion after merge (no standalone architecture content should remain).

## Boundary split to enforce after merge

- OUTPUT owns: output intents, normalization, effect routing, document assembly, structured effect collection shape.
- STREAMING owns: StreamBus lifecycle, sink/adapters, SDK streaming event surface, streaming guard constraints.
- Avoid duplicated “effect architecture” prose across both docs.
