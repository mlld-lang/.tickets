---
id: m-d002
status: closed
deps: []
created: 2026-02-17T23:13:04Z
type: task
priority: 2
assignee: Adam Avenir
updated: 2026-02-18T07:45:18Z
---
# Fold LSP-TOKEN-VALIDATOR.md into LANGUAGE-SERVER.md

Merge semantic token validator architecture into docs/dev/LANGUAGE-SERVER.md.

## Acceptance Criteria

- Token-validator guidance is incorporated into docs/dev/LANGUAGE-SERVER.md.\n- docs/dev/LSP-TOKEN-VALIDATOR.md is ready for deletion by the remove ticket.


**2026-02-17 23:37 UTC:** Doc-audit input (source: `llm/run/doc-audit/tmp/results.json`) for this ticket.
This input MUST be verified with 100% confidence during implementation.

Files in scope to verify:
- `docs/dev/LANGUAGE-SERVER.md` [outdated]: Multiple sections contain inaccurate token mappings, wrong test file paths, a non-existent npm script, dependency category error, and missing visitors/helpers

Verification bar (required):
- Confirm or disprove each finding for the files above against current code/docs with 100% confidence.
- If disproved, record why with concrete file references.
- If confirmed, update docs in this ticket scope and keep links/frontmatter consistent.

**2026-02-18 00:10 UTC:** Verified against current code before merge. Decisive change list for consolidation into `docs/dev/LANGUAGE-SERVER.md`:

- Add a dedicated "Semantic Token Validator" section in `docs/dev/LANGUAGE-SERVER.md` by migrating the architecture/flow material from `docs/dev/LSP-TOKEN-VALIDATOR.md` (expectations -> visitor/token emission -> matcher -> reporter), but only with current file paths and command names.
- Correct dependency/install guidance:
  - Remove `npm install --save-dev vscode-languageserver` language in install/troubleshooting sections.
  - Reflect current packaging reality (`vscode-languageserver` is in `dependencies` in `package.json`; language server is started directly by `mlld language-server`).
  - If an explicit install command is still documented, use `npm install vscode-languageserver` (not `--save-dev`).
- Replace the semantic token mapping snippet with the current `TOKEN_TYPE_MAP` shape from `cli/commands/language-server-impl.ts`, including:
  - `directiveDefinition -> modifier`
  - `directiveAction -> property`
  - `cmdLanguage -> function`
  - `embedded -> property`
  - `alligator`, `alligatorOpen`, `alligatorClose` -> `interface`
  - `section -> namespace`
  - pass-through support for `function`, `label`, `typeParameter`, `interface`, `namespace`, `modifier`, `enum`.
- Update the "dispatch/visitor" architecture list to match the actual registrations in `services/lsp/ASTSemanticVisitor.ts`:
  - Must include `CommandVisitor`, `TemplateVisitor`, `LiteralVisitor`, `StructureVisitor`, `ConditionalVisitor`, and `LabelVisitor` (in addition to Directive/Variable/FileReference/Foreach/Expression).
- Update helper documentation to reflect actual usage in `services/lsp/utils` + visitors:
  - Include `EffectTokenHelper` (currently used by `DirectiveVisitor` and `FileReferenceVisitor`).
  - Keep `OperatorTokenHelper`, `CommentTokenHelper`, and `LanguageBlockHelper` coverage.
  - Do not assert `TemplateTokenHelper` is part of active visitor flow unless that wiring is added first.
- Fix incorrect test targets in the "Running Tests" section:
  - Replace nonexistent `cli/commands/language-server.test.ts` with existing `cli/commands/language-server-debounce.test.ts` and `cli/commands/language-server-templates.test.ts`.
  - Replace `tests/lsp/semantic-tokens*.test.ts` paths with existing `services/lsp/semantic-tokens.test.ts`, `services/lsp/semantic-tokens-unit.test.ts`, and `services/lsp/highlighting-rules.test.ts`.
- When merging command guidance from `LSP-TOKEN-VALIDATOR.md`, keep only commands/scripts that exist now:
  - Keep: `npm run validate:tokens`, `npm run dump:tokens <file> -- --diagnostics`, `npm run test:nvim-lsp <file>`.
  - Do NOT include `node scripts/validate-token-mappings.mjs` (script is not present in `scripts/`).
- Do not carry forward hardcoded coverage percentages from `LSP-TOKEN-VALIDATOR.md` unless regenerated from a current run.
- After content migration, reduce `docs/dev/LSP-TOKEN-VALIDATOR.md` to a short pointer stub so it is ready for deletion by the remove-ticket.
