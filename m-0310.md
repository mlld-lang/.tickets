---
id: m-0310
status: closed
deps: []
created: 2026-02-23T16:34:18Z
type: bug
priority: 0
assignee: Adam Avenir
tags: [error-handling, interpreter]
updated: 2026-02-25T17:42:14Z
---
# Duplicate error output is systematic across all subsystems

## Bug

Error messages print to stderr twice in a single mlld invocation. This is systemic — it happens across policy denials, import failures, cmd restrictions, js errors, missing files, and more. The error is emitted once by the evaluator and again by the CLI error handler (or error collector).

## Acceptance criteria

1. Write a test script that triggers a policy denial error. Run it with `mlld script.mld 2>&1`. The denial error message must appear exactly once in the combined output.
2. Write a test script that imports a nonexistent file. Run it. The error must appear exactly once.
3. Write a test script that uses a restricted command. Run it. The error must appear exactly once.
4. Add integration tests that assert the error message string appears exactly once in stderr for at least 3 representative error types (policy denial, import failure, runtime error).
5. All existing tests pass: `npm test`

## Where to look

The error emission pipeline has two layers that both print:
- The evaluator/interpreter catches and logs errors during evaluation
- The CLI runner (or top-level error collector) catches the rethrown error and logs it again

Find where errors are caught, logged to stderr, AND rethrown. The fix is to remove the stderr write at one of the two layers — most likely the inner evaluator should throw without printing, and only the outermost CLI handler should print.

## What NOT to do

Do NOT fix this per-subsystem (e.g., special-casing policy errors, then import errors, etc.). The fix must be structural: ensure there is exactly ONE place that prints errors to stderr. Previous attempts fixed individual subsystems and the bug kept recurring.

## History

This ticket has been closed and reopened twice. Previous fixes addressed specific subsystems but the pattern keeps recurring because the root cause (two catch blocks both printing) was not addressed. Third QA run to flag this (2026-02-24-2 and 2026-02-25-0 both confirmed it across 8+ subsystems).
