---
id: m-296f
status: closed
deps: []
created: 2026-02-20T20:06:06Z
type: bug
priority: 0
assignee: Adam
updated: 2026-02-20T20:10:47Z
---
# Collection expression values strip taint descriptors

Array/object literal values that are expressions lose security labels when those expressions carry descriptor metadata.

Confirmed repro:
```mlld
var pii @name = "John Doe"
var @flag = true

var @directTern = @flag ? @name : "x"
show @directTern.mx.labels      # ["pii"]

var @arrTern = [@flag ? @name : "x"]
show @arrTern.mx.labels         # [] (expected ["pii"])

var @objTern = {"k": @flag ? @name : "x"}
show @objTern.mx.labels         # [] (expected ["pii"])
```

Root cause:
- `interpreter/eval/var/collection-evaluator.ts` evaluates expression nodes via `evaluateUnifiedExpression` but returns only `.value` and drops `.descriptor`.
- This is a follow-on of m-f680 (expression descriptor propagation) in collection assembly paths.

Impact:
- Labels can be stripped when building structured data, allowing downstream operations to miss taint.

Acceptance criteria:
1. Collection/object evaluators preserve expression descriptors when assembling arrays/objects.
2. Repro above yields `@arrTern`/`@objTern` labels containing `pii`.
3. Add regression tests under security descriptor propagation fixtures.


**2026-02-20 20:10 UTC:** Fixed in interpreter/eval/var/collection-evaluator.ts by collecting descriptors from expression and when-expression item results, and in interpreter/eval/var/security-descriptor.ts by adding recursive fallback traversal in extractDescriptorsFromDataAst for complex AST shapes (e.g., ternary condition/branches). Regression test added in tests/interpreter/security-metadata.test.ts: preserves labels for expression values in array and object literals. Verified with vitest targeted runs.
