---
id: m-968f
status: closed
deps: []
created: 2026-02-13T16:22:27Z
type: feature
priority: 1
assignee: Adam
updated: 2026-02-13T17:20:00Z
---
# Support top-level => to return a value from scripts

`=>` currently requires an enclosing execution context (exe block or for block). This is correct — returns need somewhere to return to. This ticket adds "script" as another valid execution context, so `=> @value` at the top level sets the script's return value.

Once the script itself is a valid return context, `=>` inside if/when blocks at the top level will work automatically (the existing exe context check in if.ts already handles this — it just needs a script-level context to find).

This also resolves mlld-b1qi (strict mode implicit final output). The strict mode output model becomes explicit:
- `show` — side effect, prints to stdout immediately during execution
- `log` — side effect, prints to stderr immediately during execution
- `=> @value` — terminates execution, the CLI runner prints the return value to stdout
- No `=>` — no final output (only what `show`/`log` emitted during execution)

The implicit "last expression value printed by the runner" behavior is removed. Scripts that want final output use `=>`.

## Use case

Scripts invoked by other scripts or from CLI that need to produce a structured result:

```mlld
var @data = <input.json>
var @result = for @item in @data.items when @item.active => @item.name
=> @result
```

Conditional returns:

```mlld
if @config.mode == "fast" [
  => @fastResult
]
=> @fullResult
```

Side effects and return value together:

```mlld
show "Processing..."
var @result = @claude(@prompt)
show "Done."
=> @result
>> stdout: "Processing...\nDone.\n<result>"
```

## Current behavior

- `=> @value` at top level in strict mode: parse error ("Text content not allowed")
- `=> @value` inside if block at top level: runtime error ("Return statements are only allowed inside exe blocks") — correct, because there's no execution context to return to
- `=> @value` inside if block inside exe: works (exe provides the context)
- Scripts without `=>` may produce implicit final output of the last expression value (the mlld-b1qi duplication bug)

## Design

- Add a script-level execution context so `=>` has a return target at the top level
- `=> @value` terminates script execution (same as exe return semantics — not "set and continue")
- When run from CLI, the return value is printed to stdout
- When imported by another script, the return value is captured by the importer
- Remove the implicit "last expression value" output path — scripts without `=>` produce no final output (only side effects from show/log)
- The existing `if-top-level-return` exception test case should be moved/updated: it correctly tests the current behavior, but the behavior is changing

## Acceptance Criteria

1. `=> @expr` parses at the top level in strict mode (.mld)
2. `=> @expr` parses at top level in markdown mode (.mld.md)
3. `=> @expr` inside if/when blocks at top level works (script provides the execution context)
4. `=> @value` terminates script execution (does not continue to subsequent lines)
5. CLI prints the return value to stdout
6. When script is imported, return value is captured by the importer
7. Scripts without `=>` produce no implicit final output
8. Existing exe-scoped `=>` behavior unchanged
9. Update `tests/cases/exceptions/if-top-level-return` to reflect new behavior
10. Review and update docs (howto, language reference) to document the strict mode output model: show for side-effect output, => for script return value, no implicit output

**2026-02-13 17:20 UTC:** Implemented top-level script return support with parser/runtime/docs updates. Added regression coverage (strict + markdown top-level return, if/when top-level returns, import default capture, no implicit final output). Full test suite passed: npm test. Commit: 3ef271124.

**2026-02-13 18:50 UTC:** Follow-up: markdown mode now requires /=> for top-level script returns; bare => remains text in markdown documents. Updated grammar guards, regression tests, markdown-mode docs, and rc82 changelog. Full suite pass (escalated): npm test.
