---
id: m-1001
status: closed
deps: []
created: 2026-02-15T22:41:05Z
type: enhancement
priority: 0
assignee: Adam
updated: 2026-02-15T23:08:19Z
---
# Meaningful error for string concatenation with +

## Problem

Agents consistently expect `+` to concatenate strings (JavaScript/Python behavior). In mlld, `+` is arithmetic-only and returns `NaN` for string operands.

**What agents try:**
```mlld
var @combined = @firstName + " " + @lastName
show @combined  >> Outputs: NaN
```

**What works in mlld:**
```mlld
var @combined = `@firstName @lastName`
show @combined  >> Outputs: John Doe
```

QA mcp-security experiments 02, 03, 09, 16 all hit this.

## Fix

Per `/Users/adam/dev/mlld/docs/dev/ERRORS.md`, add a helpful error when `+` is used with string operands.

File: `/Users/adam/dev/mlld/interpreter/eval/expressions.ts` around line 377

Current code:
```typescript
case '+':
  return createEvaluatorResult(toNumber(leftValue) + toNumber(rightValue), mergedDescriptor);
```

Enhanced version:
```typescript
case '+': {
  const leftNum = toNumber(leftValue);
  const rightNum = toNumber(rightValue);

  // Detect string + string pattern (both convert to NaN)
  if (Number.isNaN(leftNum) && Number.isNaN(rightNum) &&
      typeof leftValue === 'string' && typeof rightValue === 'string') {
    throw new MlldError(
      'String concatenation with + is not supported. Use template strings instead.',
      {
        code: 'STRING_CONCAT_WITH_PLUS',
        hint: 'Use: var @new = `@first @second` instead of @first + @second',
        leftValue: String(leftValue).substring(0, 50),
        rightValue: String(rightValue).substring(0, 50)
      }
    );
  }

  return createEvaluatorResult(leftNum + rightNum, mergedDescriptor);
}
```

## Acceptance Criteria

1. This code must throw a helpful error:
   ```mlld
   var @a = "hello"
   var @b = "world"
   var @c = @a + @b
   ```
   Expected error message: "String concatenation with + is not supported. Use template strings instead."
   Expected hint: Contains `var @new = \`@first @second\``

2. Arithmetic still works:
   ```mlld
   var @x = 5 + 3  >> 8
   ```

3. Mixed string/number doesn't throw (just returns NaN as before, that's expected):
   ```mlld
   var @x = "hello" + 5  >> NaN (this is fine)
   ```

4. Create test case in `tests/cases/exceptions/` for the string + string error

5. Run `npm test` - all existing tests pass

## Related Files

- `/Users/adam/dev/mlld/interpreter/eval/expressions.ts` (line ~377) - THE FIX GOES HERE
- `/Users/adam/dev/mlld/docs/dev/ERRORS.md` - Error message guidelines
- `/Users/adam/dev/mlld/qa/runs/2026-02-15-2/topics/mcp-security/` experiments 02,03,09,16 - QA evidence
- Investigation: agent aaa899d full report

**2026-02-15 23:08 UTC:** Added targeted plus-operator diagnostics for string+string in expression evaluation with template hint, preserved numeric and mixed behavior, added interpreter test file interpreter/eval/expressions-plus.test.ts and exception fixture exceptions/string-concat-plus. Full npm test passes. Commit: b44be8c9f.
