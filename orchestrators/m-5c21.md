---
id: m-5c21
status: open
deps: [m-9bab, m-a3fe]
created: 2026-02-20T01:13:15Z
type: feature
priority: 1
assignee: Adam Avenir
updated: 2026-02-20T01:13:25Z
---
# Generalize review pipeline to config-driven

## Problem

`llm/run/review/` is hardcoded to review the hooks/checkpoints/resume feature. The 6-phase pipeline structure (spec-compliance, test-quality, docs-accuracy, live-test, invalidation, synthesis) is generic and reusable, but the review targets and reference doc paths are feature-specific.

## Source files

- `llm/run/review/index.mld` — main pipeline (hardcoded spec path, plan path, file groups)
- `llm/run/review/lib/context.mld` — helper functions (`@flatName`, `@mkdirp`, `@flatten`, `@countBySeverity`, `@tagFindings`)
- `llm/run/review/prompts/workers/` — 5 prompt templates (spec-compliance.att, test-quality.att, docs-accuracy.att, live-test.att, invalidate.att, synthesize.att)

## Required changes

### 1. Config-driven entry point

Refactor `index.mld` to load config from `--config` payload:

```mlld
import "@payload" as @p
var @configPath = @p.config
when !@configPath => [ show "Usage: mlld run review --config path/to/config.mld"; done ]
import { @config } from "@configPath"
```

Config shape:
```mlld
var @config = {
  name: "hooks-checkpoints",              >> Used for output dir naming
  spec: "spec-hooks-checkpoints-resume.md",  >> Optional: spec file path
  plan: "plan-hooks-checkpoints-resume.md",  >> Optional: plan file path
  ticketDir: "hooks-checkpoints",            >> Optional: tk directory for ticket context
  ticketIds: [],                             >> Optional: specific ticket IDs
  fileGroups: [                              >> Review target groups
    { id: "hook-registry", name: "Hook Registry", files: "interpreter/hooks/HookRegistry.ts" },
    >> ...
  ],
  parallel: 5                                >> Optional: parallelism (default 5)
}
export { @config }
```

### 2. Extract current hardcoded config

Create `llm/run/review/configs/hooks-checkpoints.mld` with the current hardcoded values from `index.mld`.

### 3. Update prompt templates

Parameterize the 5 prompt templates to accept `refDocsSection` (a compiled context string from spec + plan + tickets) instead of hardcoded spec/plan paths.

### 4. Use shared libraries

Replace local helpers with imports:
```mlld
import { @mkdirp, @flatName } from @lib/common
import { @resolveOutputDir } from @lib/runs
import { @logEvent, @logPhaseStart, @logPhaseComplete } from @lib/events
import { @loadTickets, @formatTickets } from @lib/tickets
```

### 5. Add bail guard to LLM wrapper

The current `@llmCall` (`review/index.mld:51`) is a bare pass-through that doesn't check for failure. Replace with the bail pattern so failed LLM calls are never cached:

```mlld
exe llm @llmCall(prompt, model, dir, tools, outPath) = [
  let @result = @claudePoll(@prompt, @model, @dir, @tools, @outPath)
  when !@result => bail `LLM call failed (no output written to @outPath)`
  => @result
]
```

### 5. Support flexible reference docs

Build a `@refDocs` context string from whatever combination of spec, plan, and tickets the config provides. The prompt templates receive this as a single variable rather than individual file paths.

## Acceptance criteria

- `mlld run review --config llm/run/review/configs/hooks-checkpoints.mld` produces the same output as the current hardcoded version.
- A new review can be configured by creating a new `.mld` config file — no code changes to the pipeline.
- All 6 phases work with config-driven targets.
- Shared libraries are used (no local `@mkdirp`, `@flatName`, etc.).
- Approved plan at: `.claude/plans/binary-jingling-petal.md`

