---
id: m-5870
status: open
deps: []
created: 2026-02-20T01:12:50Z
type: task
priority: 2
assignee: Adam Avenir
---
# Create llm/lib/common.mld shared library

## Problem

Three filesystem utilities are duplicated with identical implementations across 8+ orchestrator files.

## Exact duplications

**`@mkdirp(dir)`** — `sh { mkdir -p "$dir" }`:
- `llm/run/qa/index.mld:40`
- `llm/run/polish/index.mld:55`
- `llm/run/review/lib/context.mld:6`
- `llm/run/review-docs/index.mld:34`
- `llm/run/doc-writer/index.mld:43`
- `llm/run/doc-audit/index.mld:27`
- `llm/run/pr-review/index.mld:48`
- `llm/run/j2bd/index.mld:47`

**`@fileExists(path)`** — `sh { test -f "$path" && echo "yes" || echo "no" }`:
- `llm/run/review-docs/index.mld:241`
- `llm/run/j2bd/lib/context.mld:5`
- `llm/run/qatest2/lib/context.mld:3`

**`@flatName(path)`** — `@path.replaceAll("/", "--")`:
- `llm/run/review/lib/context.mld:4`
- `llm/run/review-docs/lib/context.mld:4`

## Required change

### Step 1: Create `llm/lib/common.mld`

```mlld
>> Common utilities — shared filesystem helpers
>> Import: import { @fileExists, @mkdirp, @flatName } from @lib/common

needs { sh }

exe @fileExists(path) = sh { test -f "$path" && echo "yes" || echo "no" }
exe @mkdirp(dir) = sh { mkdir -p "$dir" }
exe @flatName(path) = @path.replaceAll("/", "--")

/export { @fileExists, @mkdirp, @flatName }
```

### Step 2: Update orchestrators

In each file listed above, replace the local definition with an import. Add to the import block at the top of each file:

```mlld
import { @mkdirp } from @lib/common
>> or
import { @fileExists, @mkdirp, @flatName } from @lib/common
```

Only import what each file uses. Delete the local `exe` definition after adding the import.

### Step 3: Verify

Run each orchestrator's help/dry-run or a simple smoke test to confirm imports resolve.

## Acceptance criteria

- `llm/lib/common.mld` exists with `@fileExists`, `@mkdirp`, `@flatName` exported.
- No orchestrator in `llm/run/` defines its own `@mkdirp`, `@fileExists`, or `@flatName`.
- All orchestrators that previously used these functions import from `@lib/common`.
- The `@lib/` path alias is already configured in `mlld-config.json` (verify it resolves to `llm/lib/`).

