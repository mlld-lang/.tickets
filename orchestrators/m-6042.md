---
id: m-6042
status: open
deps: []
links: []
created: 2026-02-27T18:11:28Z
type: task
priority: 2
assignee: Adam Avenir
---
# Clean up orchestrator workarounds: replace js/sh with native mlld

## Problem

Multiple orchestrators use `js { }`, `sh { }`, and `cmd { }` blocks for things mlld handles natively. This makes the code harder to read and misrepresents mlld's capabilities to LLM agents reading these files as examples.

## Required changes

### 1. Replace `@fileExists()` shell with native `@exists()`

mlld has native `@exists()`. Replace all `sh { test -f "$path" && echo "yes" || echo "no" }` with `@exists()`. Update the `@lib/common.mld` spec in m-5870 to use `@exists()` instead of the shell version.

Files: `review-docs/index.mld:241`, `j2bd/lib/context.mld:5`, `qatest2/lib/context.mld:3`

### 2. Replace `ls | grep | sort` with mlld glob

- `polish/index.mld:56` — `sh {ls "$qaRoot" | grep '^20' | sort -r | head -1}`
- `qa/index.mld:92-100` — `sh { ls -1 "$qaRoot" | grep '^20' | sort -r | ...}`
- `qa/lib/aggregate.mld:24` — `sh { find "$dir/topics" -name "$filename" -type f | sort }`

Replace with native glob patterns and for-loop filtering.

### 3. Replace `sh {cat ...}` with file read

- `qa/lib/aggregate.mld:13` — `let @raw = sh {cat "$path" 2>/dev/null}` → `let @raw = <@path>?`

### 4. Replace `js { return arrays.filter(Boolean).flat() }` with native `.flat()`

mlld has native `.flat()` on arrays. Replace:
- `review/lib/context.mld:9` — `exe @flatten(arrays) = js { ... }` → native flat
- `doc-audit/index.mld:28` — `exe @flatMap(arrays) = js { ... }` → native flat + for-loop

### 5. Replace `@wrap(tag, body)` JS with mlld template + common lib

`llmstxt.mld:15-20` uses `js { return '<' + tag + '>' + body + '</' + tag + '>'; }` because backtick `<@tag>` is ambiguous (mlld interprets it as a file read). Add `@wrap` to `@lib/common.mld` and document the `<@var>` file-read ambiguity as a known gotcha in `docs/src/atoms/intro.md`.

### 6. Replace YAML frontmatter parsing JS with native `@file.mx.fm.*`

`howto.mld` has 25+ JS blocks parsing YAML frontmatter with regex (`.match(/^---\n([\s\S]*?)\n---/)`). mlld natively exposes frontmatter fields via `@file.mx.fm.fieldname`. Replace all frontmatter regex parsing with native access.

### 7. Replace Date.now() JS with `@now`

- `polish/lib/tickets.mld:182-183` — `js { return new Date(lastEnrich).getTime(); }` and `js { return Date.now(); }` → use `@now` and mlld's native timestamp handling where possible.

### 8. Add native UUID generation to mlld (feature request)

`qa/phases/flail.mld:9` uses `cmd {uuidgen | tr '[:upper:]' '[:lower:]'}`. mlld should have a native UUID builtin. File a separate feature ticket if needed.

## Acceptance criteria

- No `sh { test -f }` for file existence — use `@exists()`
- No `sh { ls | grep | sort }` for directory traversal — use mlld glob
- No `sh { cat }` for file reading — use `<@path>?`
- No `js { arrays.flat() }` — use native `.flat()`
- No JS frontmatter parsing in `howto.mld` — use `@file.mx.fm.*`
- `@wrap` helper in `@lib/common.mld` with gotcha documented
- `@now` used instead of JS Date calls where possible

