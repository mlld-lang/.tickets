---
id: m-9113
status: closed
deps: [m-0a7c]
created: 2026-02-12T18:24:28Z
type: bug
priority: 0
assignee: Adam
tags: [structured-value, data-model, show]
updated: 2026-02-12T21:02:06Z
---
# StructuredValue: JSON serialization leaks internal wrapper fields

When a bare StructuredValue is displayed via show or serialized via JSON.stringify, the internal wrapper fields (type, text, data, metadata) can leak into output instead of showing clean data.

Root cause: createASTAwareJSONReplacer in interpreter/utils/ast-evaluation.ts does NOT handle StructuredValues. A StructuredValue with type: 'object' matches the AST node check for type === 'object', falls through without the entries/properties it expects, and JSON.stringify serializes all enumerable properties (type, text, data, metadata.security.taint, metadata.security.sources, etc).

Reproduction: var @stance via pipe through @json, then show @stance dumps full wrapper: {type, text, data, metadata...}. But var @result = { stance: @stance } then show @result gives clean output because object construction extracts the inner value.

Commit 54737f07e made cmd/sh outputs stay wrapped as StructuredValues, increasing the likelihood of hitting this path.

Fix needed in createASTAwareJSONReplacer (ast-evaluation.ts): Add StructuredValue detection early in the replacer (before type === 'object' check). Return val.data to unwrap cleanly. The existing structuredValueJsonReplacer in structured-value.ts does this correctly but is not used by JSONFormatter.

Additionally: perform a review of other locations where StructuredValues might leak through JSON serialization. Check all callers of JSONFormatter.stringify and JSON.stringify that could receive StructuredValues. See docs/dev/DATA.md for the StructuredValue contract.

Affected files: interpreter/utils/ast-evaluation.ts (createASTAwareJSONReplacer), interpreter/utils/display-formatter.ts (formatForDisplay), interpreter/core/json-formatter.ts (JSONFormatter.stringify), interpreter/utils/structured-value.ts (structuredValueJsonReplacer exists but unused by JSONFormatter)


**2026-02-12 20:42 UTC:** Additional repro: the nested case also leaks. When a StructuredValue is a value inside a plain object, show still dumps the wrapper:

var @result = <@outPath> | @json    >> StructuredValue
var @output = { stance: @result }   >> plain object containing SV
show @output                        >> dumps {stance: {type, text, data, metadata}}

Expected: {"stance": {"mode": "contending", ...}}
Actual: {"stance": {"type": "object", "text": "...", "data": {...}, "metadata": {...}}}

Note: output ... to "file" writes clean JSON — the issue is specifically in the show/JSON.stringify path. This means the earlier analysis that 'wrapping in another object works' was wrong — it depends on HOW the object was constructed. Object literal construction with SV values does NOT unwrap them during serialization.

This confirms the fix must be in createASTAwareJSONReplacer since it handles nested serialization recursively.

**2026-02-12 21:02 UTC:** Implemented fix for StructuredValue wrapper leakage in show/JSON serialization.\n\nChanges:\n- interpreter/utils/ast-evaluation.ts: createASTAwareJSONReplacer now detects StructuredValue values early and returns .data before AST object checks.\n- interpreter/eval/show/show-invocation-handlers.ts: replaced direct JSON.stringify object branches with JSONFormatter.stringify(..., { pretty: false }) so show invocation paths use the shared replacer too.\n- interpreter/core/json-formatter.test.ts: added regression tests for both bare StructuredValue serialization and nested StructuredValue inside plain object serialization.\n\nValidation:\n- npx vitest run interpreter/core/json-formatter.test.ts (pass, 5/5)\n- npx vitest run interpreter/output-formats.test.ts (fails on existing parser/fixture expectations unrelated to this patch in current branch).
