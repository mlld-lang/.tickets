---
id: m-3e35
status: closed
deps: []
links: []
created: 2026-01-25T12:43:20Z
type: bug
priority: 2
assignee: Adam Avenir
tags: [interpreter, parallel, for-loop]
---
# show directive doesn't output inside for parallel blocks

When using `show` inside a `for parallel` block, nothing is output to stdout.

## Reproduction

```mlld
var @items = ["a", "b", "c"]
var @results = for parallel(2) @item in @items [
  show \`Processing: @item\`
  => @item
]
show \`Done. Results: @results.length\`
```

## Expected
```
Processing: a
Processing: b
Processing: c
Done. Results: 3
```

## Actual
```
Done. Results: 3
```

The show statements inside the parallel block are silently ignored.

## Impact
No visibility into parallel execution progress, making debugging difficult.


## Notes

**2026-01-25T12:55:24Z**

## Investigation Findings

Root cause in `/Users/adam/dev/mlld/interpreter/eval/show.ts` lines 1310-1317:

```typescript
// Only emit the effect if we're not in an expression context
if (!context?.isExpression) {
  if (!isStreamingShow) {
    env.emitEffect('both', content, { source: directive.location });
  }
}
```

The `evaluateForExpression` function in `for.ts:644` passes `{ isExpression: true }` when evaluating nodes, causing show to skip emitting effects.

This is intentional design (expression contexts shouldn't have side effects) but breaks user expectations when using show for progress logging inside parallel loops.

**2026-01-25T18:28:39Z**

## Fixed

Added `allowEffects` flag to EvaluationContext. For-expression blocks now pass `allowEffects: true` to allow show/output effects while still capturing return values.

Changes:
- `interpreter/core/interpreter.ts`: Added `allowEffects?: boolean` to EvaluationContext
- `interpreter/eval/show.ts`: Check `context?.allowEffects` to allow effects even when `isExpression: true`
- `interpreter/eval/for.ts`: Pass `allowEffects: true` when evaluating for-expression bodies
- `tests/cases/feat/for/directive-actions/expected.md`: Updated to expect show effects

Templates still suppress effects (via `isExpression: true` without `allowEffects`) which is correct behavior.
