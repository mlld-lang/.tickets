---
id: m-964b
status: closed
deps: []
created: 2026-02-16T17:07:33Z
type: bug
priority: 0
assignee: Adam
tags: [bug, validate, p0, qa-driven]
updated: 2026-02-16T17:19:21Z
---
# bug: mlld validate extractGuards checks wrong AST field

## Problem

`mlld validate` guard extraction checks `guardNode.subtype` instead of `guardNode.values.timing` to determine guard timing (before/after/always). This causes guards to not be properly reported in validation output.

## Where to look

- `cli/commands/analyze.ts` or wherever `extractGuards` is implemented
- Search for `extractGuards` and `subtype` 
- The AST for guard nodes stores timing in `values.timing`, not in `subtype`
- Run `npm run ast -- 'guard @g before op:run = when [* => allow]'` to see the actual AST structure

## Fix

Change the field access from `guardNode.subtype` to `guardNode.values.timing` (or whatever the AST actually uses â€” verify with the ast command first).

## Verification

```bash
echo 'guard @g before op:run = when [* => allow]' | npx mlld validate --format json
```

The guards array in the JSON output should include the guard with correct timing.

## Source
QA run: qa/runs/2026-02-16-0/topics/validate-features/


**2026-02-16 17:19 UTC:** Updated extractGuards to read timing from guard timing fields (values/meta/raw) with subtype fallback, fixed guard-name extraction for VariableReference nodes, added analyze regression for before/after/always guard timings, and verified with npm test.
