---
id: m-63d5
status: open
deps: []
created: 2026-02-25T20:52:50Z
type: feature
priority: 3
assignee: Adam Avenir
---
# SDK-based payload injection for doc test expectations with external dependencies

Many doc test blocks reference undefined context variables (@items, @mode, @user, etc.) because they are fragments that assume surrounding code defines them. Rather than skipping all of these, we could use the SDK to inject prior context:

1. Add a payload.mld file in the hash dir that sets up the prior context and exports a @payload object
2. The doc-expect script imports @payload and makes it available when running the example
3. The example gets an implicit 'import @payload' prepended (or uses dynamic modules)
4. processMlld already supports dynamicModules option for runtime module injection

This would let us write expectations for many currently-skipped blocks. Example:
  tests/cases/docs/atoms/flow-control/08-for--basics/037e7ff0/payload.mld:
    var @items = ["apple", "banana", "cherry"]
    export { @items }

Then the example block 'for @item in @items => show @item' would work.

Approach options:
(a) inject values as payload via processMlld dynamicModules
(b) treat the example as a dynamic module and prepend import @payload
(c) payload.mld file exports context, gets composed with example at execution time


**2026-02-25 21:04 UTC:** Sibling ticket: q-fe38 (file-loading test infrastructure). q-fe38 covers file deps, this ticket covers context variable deps.

**2026-02-25 21:04 UTC:** Skipped blocks needing context injection:
atoms/core: 06-templates-loops/e53cead6 (@items), 11-file-loading-frontmatter/dd2f00ae (@fm), 29-escaping-at/afcfff6f (var redefinition), 30-escaping-defaults/46545942 (@user,@item,@post), 30-escaping-defaults/9ffa44b6 (@user)
atoms/flow-control: 05-when-blocks/4da810ce (@isProd), 06-when-local-vars/09ea1fbb (@mode), 08-for-basics/037e7ff0 (@items), 09-for-collection/9c742b82, 10-for-block/e85bf93c (@items), 11-for-filter/a752d6e7, 12-for-skip/7f00c7c6, 13-for-object/11371823 (@cfg), 15-for-batch/e7c2369c, 16-for-parallel/0e178608 (@tasks), 16-for-parallel/93cfe9c2 (@items), 20-while/b4f01b27 (@initial)
