---
id: m-702d
status: closed
deps: []
created: 2026-02-24T20:35:39Z
type: bug
priority: 0
assignee: Adam Avenir
updated: 2026-02-25T00:57:15Z
---
# Block-form exe and env exe broken in pipeline stages and while loops

## Summary

Block-form executables (`exe @fn(n) = [...]`) and env executables (`exe @fn = env [...]`) fail with "Unsupported code language: mlld-exe-block" when used as pipeline stages or while loop processors. Direct invocation via `run @fn(...)` works fine.

## Root Cause

There are two dispatch paths for invoking executables:

1. **Direct invocation** (works): `run-exec-definition-dispatcher.ts` (line 708) and `exec/code-handler.ts` (line 136) both explicitly check for `mlld-exe-block` and call `evaluateExeBlock()`.

2. **Pipeline/while invocation** (broken): `interpreter/eval/pipeline/command-execution/handlers/execute-code.ts` has explicit branches for `mlld-when` (line 54), `mlld-foreach` (line 100), `mlld-for` (line 121), `mlld-loop` (line 130) — but NO branch for `mlld-exe-block` or `mlld-env`.

When `mlld-exe-block` hits this path, it falls through to the generic code path, `CommandExecutorFactory.getCodeExecutor('mlld-exe-block')` returns null, and throws "Unsupported code language: mlld-exe-block".

## Fix

Add `mlld-exe-block` and `mlld-env` branches to `interpreter/eval/pipeline/command-execution/handlers/execute-code.ts`, following the same pattern as the existing `mlld-when`/`mlld-foreach`/`mlld-for`/`mlld-loop` handlers. `evaluateExeBlock()` is already imported at line 12 of that file. For `mlld-env`, call `evaluateEnv()`.

## Affected Paths

- Pipeline stages: `PipelineCommandInvoker.invokeCommand()` → `executeCommandVariable()` → `executeCodeHandler()` → falls through
- While loops: `single-stage-runner.ts` line 194 → `PipelineCommandInvoker` → same broken path

## No existing test coverage

Zero tests for `mlld-exe-block` or `mlld-env` in the pipeline module. Existing exe-block tests only cover direct invocation.

