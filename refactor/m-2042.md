---
id: m-2042
status: closed
deps: [m-e217]
created: 2026-02-09T06:36:42Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-15ea
tags: [refactor, pipeline-executor, phase-5]
updated: 2026-02-11T06:02:14Z
---
# Refactor Program: Modularize interpreter/eval/pipeline/executor.ts - Phase 5: Extract single-stage orchestration

Objective:
Refactor single-stage orchestration into a dedicated stage-runner component.

Instructions for the implementing agent:
- Extract `executeSingleStage` orchestration responsibilities (stage-env construction, operation context, retry loop, pre/post effects sequencing).
- Preserve rate-limit retry behavior, guard-driven retry behavior, and pipeline-context lifetime boundaries.
- Keep stage hook-node and command execution context generation behavior intact.
- Add coverage for effect ordering, retry flow, and stage-context lifecycle behavior.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Single-stage execution orchestration is moved behind a dedicated collaborator.
2. Retry/effect/context behavior remains stable under characterization tests.
3. Exit criteria: all tests pass with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-11 06:02 UTC:** --dir refactor Extracted single-stage orchestration behind a dedicated runner collaborator and rewired PipelineExecutor to delegate executeSingleStage.

Completed phase checklist items:
- Moved executeSingleStage orchestration responsibilities (stage env build, operation context boundary, retry loop, pre/post effect sequencing) into PipelineSingleStageRunner.
- Preserved rate-limit retry and GuardError retry behavior through the extracted runner path.
- Preserved pipeline context lifetime boundaries via capture + withPipeContext + final cleanup.
- Preserved stage hook-node and command execution context generation by keeping runtime factory methods on PipelineExecutor and consuming them from the runner.
- Added characterization coverage for effect ordering, retry flow, and stage-context lifecycle behavior.

Touched runtime modules (line counts + ownership):
- interpreter/eval/pipeline/executor.ts (843 LOC): pipeline orchestration, runtime factories, and service wiring; executeSingleStage now delegates to runner.
- interpreter/eval/pipeline/executor/single-stage-runner.ts (356 LOC): owns single-stage orchestration, stage-env capture, retry/error handling, output finalization, and inline effect sequencing.

Test module added:
- interpreter/eval/pipeline/executor/single-stage-runner.test.ts (188 LOC): characterizes ordering, retry signal handling, and parent pipeline-context cleanup.

Sub-checkpoint verification (build + targeted tests):
- npm run build && npx vitest run interpreter/eval/pipeline/executor/single-stage-runner.test.ts interpreter/eval/pipeline/executor/inline-stage-executor.test.ts interpreter/eval/pipeline/executor/while-stage-adapter.test.ts interpreter/eval/pipeline/executor.test.ts
- Status: PASS

Phase close gate:
- npm run build && npm test && npm run test:tokens && npm run test:examples
- Status: PASS

Guardrail confirmations:
- No new sub-60 runtime module introduced (new runtime module is 356 LOC).
- No callback-lambda service injection introduced; composition uses interface-typed runtime service object.
- No duplicated shared logic introduced across sibling extraction modules in this phase.
- Touched module dependency direction remains acyclic in the executor extraction area.
