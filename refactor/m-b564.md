---
id: m-b564
status: closed
deps: [m-0e6b]
links: []
created: 2026-02-09T06:03:26Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-9f2b
tags: [refactor, exec-invocation, phase-6, handlers]
updated: 2026-02-10T19:49:00Z
---
# Phase 6: Introduce handler map for non-command/non-code executables

Objective:
Introduce explicit executable-type handlers for non-command/non-code paths.

Instructions for the implementing agent:
- Replace the monolithic executable-type branching with handler modules for:
  - node function/class
  - template
  - data
  - pipeline executable
  - command-ref
  - section
  - resolver
- Keep command and code handlers in place for later phases.
- Preserve unknown-type and error handling behavior.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Non-command/non-code executable paths use dedicated handlers.
2. Dispatch structure is clearer and preserves behavior.
3. Existing tests for these executable types remain green.
4. Full test gate passes and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-10 19:48 UTC:** Phase implementation complete.

What changed:
- Added `interpreter/eval/exec/non-command-handlers.ts` (508 LOC) as the non-command/non-code executable dispatch module.
  - Ownership: explicit matcher + handler map and dedicated handlers for node function/class, template, data, pipeline, command-ref, section, resolver executable types.
  - Keeps command/code handling out of scope for this phase.
- Updated `interpreter/eval/exec-invocation.ts` (2455 LOC) to delegate non-command/non-code execution paths to `executeNonCommandExecutable(...)` and keep command/code branches in-place.

Checklist evidence:
- Replaced monolithic non-command/non-code branch with dedicated handler map for all required executable types.
- Preserved unknown-type/error behavior by returning `undefined` from non-command dispatch when no route matches and keeping the existing fallback throw in `exec-invocation.ts`.

Targeted tests run (all pass):
- `npm run build`
- `npx vitest run interpreter/eval/exec-invocation.structured.test.ts interpreter/eval/exec-invocation.env-injection.test.ts interpreter/eval/exec-invocation.autoverify.test.ts tests/pipeline/exec-structured.test.ts tests/interpreter/import/object-reference-resolver.test.ts interpreter/eval/import/executable-in-object.test.ts interpreter/eval/show.structured.test.ts`
- `npx vitest run interpreter/interpreter.fixture.test.ts -t "slash/exe/reference"`
- `npx vitest run interpreter/interpreter.fixture.test.ts -t "output/resolver"`
- `npx vitest run interpreter/interpreter.fixture.test.ts -t "path-section-bracket"`
- `npx vitest run interpreter/interpreter.fixture.test.ts -t "exe-pipeline-with-retry"`

Full gate run (pass):
- `npm run build && npm test && npm run test:tokens && npm run test:examples`

Wave 2 guardrail attestations:
- No new sub-60 runtime module introduced in this phase.
- No duplicated pre/post implementations introduced in touched area.
- No callback-lambda service injection introduced for service composition; one callback seam remains for `evaluateExecInvocation` recursion in command-ref handling, documented inline as recursion seam.
- Shared handler option/service types and dispatch contracts are defined once in `non-command-handlers.ts` for this extraction area.
- Dependency direction remains acyclic in touched modules.
