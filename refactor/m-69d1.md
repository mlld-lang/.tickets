---
id: m-69d1
status: closed
deps: [m-c639]
created: 2026-02-09T06:36:42Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-15ea
tags: [refactor, pipeline-executor, phase-7]
updated: 2026-02-11T06:14:51Z
---
# Refactor Program: Modularize interpreter/eval/pipeline/executor.ts - Phase 7: Extract execution loop and streaming lifecycle

Objective:
Separate execution-loop control flow and streaming lifecycle from the executor composition root.

Instructions for the implementing agent:
- Extract main pipeline-loop orchestration (`execute`) into collaborators that handle state transitions and event emission.
- Isolate streaming lifecycle concerns (`emitStream`, stage streaming checks, teardown behavior).
- Preserve state-machine transition behavior, iteration safety guard, and return-structured semantics.
- Add tests for event ordering on success/failure/abort and teardown behavior in `finally` paths.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Execution-loop and streaming lifecycle concerns are separated into focused modules.
2. Public `PipelineExecutor.execute` behavior remains backward-compatible.
3. Exit criteria: all tests pass with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-11 06:14 UTC:** --dir refactor Extracted execution-loop control flow and streaming lifecycle responsibilities from PipelineExecutor into dedicated collaborators.

Completed phase checklist items:
- Added PipelineExecutionLoopRunner and moved main execute-loop orchestration into it (state-machine transitions, stage dispatch, retry-history refresh, iteration safety guard, and final-state handling).
- Added PipelineStreamingLifecycle and moved streaming stage detection, stream-event emission, lifecycle setup, and teardown behavior into this service.
- Preserved returnStructured semantics by delegating final structured return through stageOutputs.getFinal when requested.
- Preserved event sequencing behavior for success/failure paths and added explicit abort-order characterization coverage.
- Preserved teardown behavior in finally paths and added characterization coverage for teardown invocation even when execution fails.

Touched runtime modules (line counts + ownership):
- interpreter/eval/pipeline/executor.ts (508 LOC): composition root and runtime service wiring; execute now delegates to execution-loop runner and streaming lifecycle.
- interpreter/eval/pipeline/executor/execution-loop-runner.ts (201 LOC): owns pipeline execution-loop transition control and final-state dispatch.
- interpreter/eval/pipeline/executor/streaming-lifecycle.ts (87 LOC): owns streaming enablement checks, event emission, configuration, and teardown handling.

Test updates:
- interpreter/eval/pipeline/executor.characterization.test.ts (373 LOC): added abort event-order assertion and teardown-in-finally assertion.

Sub-checkpoint verification (build + targeted tests):
- npm run build && npx vitest run interpreter/eval/pipeline/executor.characterization.test.ts interpreter/eval/pipeline/executor/parallel-stage-runner.test.ts interpreter/eval/pipeline/executor/single-stage-runner.test.ts tests/pipeline/parallel-runtime.test.ts
- Status: PASS

Phase close gate:
- npm run build && npm test && npm run test:tokens && npm run test:examples
- Status: PASS

Guardrail confirmations:
- No new sub-60 runtime module introduced (new runtime modules are 201 LOC and 87 LOC).
- No callback-lambda service injection introduced; composition uses interface-typed service collaborators.
- No duplicated shared logic introduced across sibling extraction modules in this phase.
- Touched module dependency direction remains acyclic in the executor extraction area.
