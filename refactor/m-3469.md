---
id: m-3469
status: closed
deps: []
created: 2026-02-09T06:59:36Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-943f
tags: [refactor, import-directive-evaluator, phase-0]
updated: 2026-02-10T12:57:35Z
---
# Refactor Program: Modularize interpreter/eval/import/ImportDirectiveEvaluator.ts - Phase 0: Baseline and characterization



Objective:
Establish a behavior baseline for all import flows before extraction.

Instructions for the implementing agent:
- In scope: characterization coverage and extraction-boundary mapping only.
- Out of scope: moving runtime logic into new modules.
- Map responsibilities across MCP imports, resolver/input imports, module/node imports, file/url/directory imports, and policy/needs enforcement.
- Add characterization coverage for high-risk branches: alias collisions, import type mismatch validation, directory import skip patterns, module candidate fallback, and policy needs failures.
- Capture extraction seams and regression risks in ticket notes; do not move code across files in this phase.

Preserve behavior checks:
- Import type inference and declared-type mismatch errors remain baseline-locked.
- MCP import alias/binding behavior remains baseline-locked.
- Resolver/module/node/file/url/directory flow parity remains baseline-locked.
- Needs/policy enforcement and binding collision guarantees remain baseline-locked.

## Acceptance Criteria

1. Characterization coverage exists for every listed high-risk branch and preserve-behavior check.
2. Baseline notes include concrete extraction boundaries and regression hazards.
3. No intentional runtime semantic change is introduced.
4. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 12:55 UTC:** Phase implementation complete (characterization-only, no runtime logic extraction):
- Added high-risk branch characterization suite:
  interpreter/eval/import/import-directive-evaluator.characterization.test.ts
- Coverage locks behavior for:
  - alias-collision handling (MCP selected import duplicate aliases + existing binding guard),
  - declared import-type mismatch validation,
  - directory import skipDirs option validation,
  - module candidate fallback selection order,
  - needs/policy unmet failure error semantics.
- No ImportDirectiveEvaluator runtime logic moved across files in this phase.

Acceptance checklist status:
- [x] Characterization coverage for listed high-risk branches
- [x] Baseline extraction/risk notes captured in ticket notes
- [x] No intentional runtime semantic changes introduced

Tests run:
- npx vitest run interpreter/eval/import/import-directive-evaluator.characterization.test.ts interpreter/eval/import/import-types.test.ts interpreter/eval/import/import-runtime-validation.test.ts interpreter/eval/import/mcp-import.test.ts => PASS
- npm run build && npm test && npm run test:tokens && npm run test:examples => PASS

**2026-02-10 12:57 UTC:** Post-commit validation complete. Checklist status: all m-3469 characterization checkpoints complete. Commands run (all pass): npx vitest run interpreter/eval/import/import-directive-evaluator.characterization.test.ts interpreter/eval/import/import-types.test.ts interpreter/eval/import/import-runtime-validation.test.ts interpreter/eval/import/mcp-import.test.ts; npm run build && npm test && npm run test:tokens && npm run test:examples. Commit: a47df5584.
