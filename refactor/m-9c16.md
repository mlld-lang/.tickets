---
id: m-9c16
status: closed
deps: [m-dbcd]
created: 2026-02-09T07:00:44Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-21f6
tags: [refactor, when-evaluator, phase-7]
updated: 2026-02-11T16:27:48Z
---
# Refactor Program: Modularize interpreter/eval/when.ts - Phase 7: Final composition cleanup and contract verification



Objective:
Reduce `when.ts` to composition and verify public behavior contracts.

Instructions for the implementing agent:
- Refactor top-level exports to delegate to extracted modules with minimal inline logic.
- Remove duplicate helper code and ensure dependency directions remain acyclic.
- Attach architecture notes summarizing module boundaries and call flow.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Phase objectives for this slice are fully implemented with cohesive module boundaries.
2. Runtime behavior, error surface, and metadata contracts remain aligned with baseline expectations.
3. Phase-specific coverage is added or updated for the extracted responsibilities.
4. Exit criteria: all tests pass, with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-11 16:27 UTC:** Completed final composition cleanup and contract verification for `when.ts`.

What changed in this phase:
- Reduced `interpreter/eval/when.ts` to composition-oriented orchestration and subtype dispatch.
- Moved none-with-operator validation helper into `interpreter/eval/when/form-handlers.ts` so simple-form validation lives with form handling logic.
- Moved expression-error preview formatting helper into `interpreter/eval/when/condition-evaluator.ts` so condition diagnostics stay local to condition runtime.
- Removed now-unneeded runtime callback seams from `when.ts` service wiring.

Module boundaries and call flow:
- `when.ts` composes runtime services and dispatches to simple/match/block handlers.
- `when/form-handlers.ts` owns form-level orchestration, action execution flow, and block-specific environment merge behavior.
- `when/match-engines.ts` owns first/any/all matching semantics and none/wildcard placement validation.
- `when/condition-evaluator.ts` owns condition branch evaluation (unary wrappers, expression nodes, exec invocation, generic path) and error wrapping.
- `when/condition-utils.ts` owns pure comparison/truthiness/denied-target utility semantics.

Touched runtime modules (line counts + ownership):
- `interpreter/eval/when.ts` — 79 lines — composition and dispatch only.
- `interpreter/eval/when/form-handlers.ts` — 248 lines — form-level orchestration and validation.
- `interpreter/eval/when/condition-evaluator.ts` — 257 lines — condition runtime and diagnostics.

Targeted validation:
- `npx vitest run interpreter/eval/when/condition-utils.test.ts interpreter/eval/when/match-engines.test.ts interpreter/eval/when.characterization.test.ts` ✅ pass

Full gate validation:
- `npm run build && npm test && npm run test:tokens && npm run test:examples` ✅ pass

Guardrail attestations:
- No new sub-60 runtime module introduced.
- No callback-lambda service injection introduced.
- Dependency direction remains acyclic across the `interpreter/eval/when/*` extraction area.
