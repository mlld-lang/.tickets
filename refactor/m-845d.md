---
id: m-845d
status: closed
deps: [m-68f8]
created: 2026-02-09T07:01:50Z
type: epic
priority: 1
assignee: Adam Avenir
tags: [refactor, pipeline-command-execution]
updated: 2026-02-10T11:35:38Z
---
# Refactor Program: Modularize interpreter/eval/pipeline/command-execution.ts



Largest unplanned target file: `interpreter/eval/pipeline/command-execution.ts` (~1,480 LOC).

This epic coordinates a phased refactor that decomposes pipeline command execution into focused modules while preserving executable resolution, parameter binding semantics, guard integration, policy label-flow checks, and output wrapping behavior.

Execution order:
1. Phase 0 through Phase 7 proceed strictly in order.
2. Each phase closes only after its exit criteria are met.
3. No phase starts until its dependency ticket is closed.

Cross-phase constraints:
- Keep exported APIs stable: `resolveCommandReference` and `executeCommandVariable`.
- Preserve pipeline input binding semantics for first-parameter `@input` handling across structured/text formats.
- Preserve guard pre-hook integration and guard-denial handling behavior.
- Preserve policy checks and descriptor propagation across command/code/node/template/ref execution branches.
- Preserve retry signaling semantics and structured wrapping behavior for pipeline stages.

## Acceptance Criteria

1. Phase tickets (0-7) exist under this epic and are dependency-linked in sequence.
2. Each phase ticket includes explicit implementation instructions and explicit exit criteria.
3. Final structure splits responsibilities into cohesive modules under `interpreter/eval/pipeline/command-execution/` (or equivalent) and reduces `command-execution.ts` to orchestration.
4. Final validation command passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-09 08:11 UTC:** Safety-hardening pass completed for phases m-fe13 -> m-7a82.

Tightening applied:
- Each phase now has explicit in-scope/out-of-scope boundaries and concrete module boundaries.
- Preserve-behavior checks are explicit for @input first-parameter binding, structured wrapping, guard preflight outcomes, policy label/descriptor propagation, retry signaling, and branch parity.
- Exit criteria in every phase requires the full gate command:
  npm run build && npm test && npm run test:tokens && npm run test:examples

Dependency verification:
- Verified linear chain with `tk dep tree --full m-7a82` in a temporary workspace mount that maps `.tickets/refactor` as `.tickets`.
- No dependency rewiring required.

Residual risk:
- Phase 6 remains dense because code/node/template/ref extraction is grouped; strict branch-level parity checks are required before closure.

**2026-02-09 08:25 UTC:** Micro-planning addendum (hotspot): added explicit branch-parity checklist to phase m-c8ba.

Focus:
- Enforces per-branch parity matrix for code/node/template/commandRef.
- Adds explicit closure gate that every checklist scenario is backed by tests before phase close.

**2026-02-10 11:35 UTC:** Epic completion summary:
- All phase tickets under m-845d are closed in dependency order:
  m-fe13 -> m-9edc -> m-abb7 -> m-cddf -> m-c97c -> m-a69c -> m-c8ba -> m-7a82.
- Final orchestration cleanup completed in phase m-7a82 with:
  - extracted finalizer module (`finalize-result.ts`),
  - contract verification tests,
  - dependency-boundary tests,
  - architecture notes (`docs/dev/COMMAND-EXECUTION.md`).
- Public API contracts and branch parity (command/provider/code/node/template/commandRef) remain verified by tests.

Final epic gate (post phase-7 commit) executed:
- npm run build && npm test && npm run test:tokens && npm run test:examples
- Result: PASS
