---
id: m-98a8
status: closed
deps: [m-b1de]
links: []
created: 2026-02-09T06:03:26Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-9f2b
tags: [refactor, exec-invocation, phase-4, args]
updated: 2026-02-10T19:26:20Z
---
# Phase 4: Extract argument normalization and parameter binding

Objective:
Extract argument normalization and parameter binding logic.

Instructions for the implementing agent:
- Move argument evaluation/normalization into dedicated module(s) (suggested: `interpreter/eval/exec/args.ts`).
- Preserve handling for structured values, regex literals, data literals, variable references, load-content nodes, nested exec invocation, and template arrays.
- Keep guard candidate/original variable tracking behavior intact.
- Extract parameter variable binding into small testable helpers.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Argument normalization and parameter binding are extracted and covered by tests.
2. Structured-value and security descriptor behavior for args remains unchanged.
3. Characterization tests for env injection and structured invocation remain green.
4. Full test gate passes and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-10 19:25 UTC:** Completed Phase 4 extraction for argument normalization and parameter binding.

Changes:
- interpreter/eval/exec/args.ts (364 LOC): owns argument evaluation/normalization and parameter variable binding helpers, including structured/regex/literal/reference/load-content/nested-exec/template-array handling.
- interpreter/eval/exec-invocation.ts (3196 LOC): delegates arg normalization and param binding to exec/args.ts while preserving existing execution flow and descriptor merge behavior.

Checklist/acceptance coverage:
- Extracted argument normalization into dedicated module and extracted parameter binding into dedicated helpers.
- Preserved guard candidate/original variable tracking behavior via bindExecParameterVariables + guard-candidate clone helper.
- Preserved structured value and descriptor merge behavior for object/array/variable args.

Targeted tests run (PASS):
- npx vitest run interpreter/eval/exec-invocation.structured.test.ts interpreter/eval/exec-invocation.env-injection.test.ts interpreter/eval/exec-invocation.autoverify.test.ts tests/pipeline/exec-structured.test.ts interpreter/methods.split.test.ts tests/interpreter/hooks/guard-pre-hook.test.ts

Full gate run (PASS):
- npm run build && npm test && npm run test:tokens && npm run test:examples

Wave 2 guardrails:
- No new runtime module under 60 LOC introduced in touched area.
- No duplicated helper implementation introduced across sibling extracted modules in this phase.
- No callback-lambda constructor injection introduced; one explicit recursion seam callback remains in service contract for nested ExecInvocation arg evaluation and is documented inline.
- Shared extraction-area types for this slice are defined in exec/args.ts and reused by call sites.
- Dependency direction remains acyclic in touched area.
