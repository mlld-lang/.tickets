---
id: m-04d8
status: closed
deps: [m-21f6]
created: 2026-02-09T07:03:18Z
type: epic
priority: 1
assignee: Adam Avenir
tags: [refactor, exe-evaluator]
updated: 2026-02-11T17:33:25Z
---
# Refactor Program: Modularize interpreter/eval/exe.ts



Largest unplanned target file: `interpreter/eval/exe.ts` (~1,469 LOC).

This epic coordinates a phased refactor that decomposes executable-definition and exe-block logic into focused modules while preserving executable definition semantics, shadow environment capture behavior, metadata/capability propagation, and runtime wrapper behavior.

Execution order:
1. Phase 0 through Phase 7 proceed strictly in order.
2. Each phase closes only after its exit criteria are met.
3. No phase starts until its dependency ticket is closed.

Cross-phase constraints:
- Keep exported APIs stable: `evaluateExe` and `evaluateExeBlock`.
- Preserve supported exec subtypes and resulting executable definition shapes.
- Preserve security metadata/capability context propagation and autosign behavior.
- Preserve shadow env capture/rehydration semantics and JS sync wrapper behavior.
- Preserve control-flow behavior for exe-block, when-expression returns, and loop control markers.

## Wave 2 Architecture Contract

Target end state for `interpreter/eval/exe.ts`:
- Public exports stay stable: `evaluateExe` and `evaluateExeBlock`.
- Exe-block runtime, shadow-env declaration handling, subtype definition builders, variable/security assembly, and wrapper creation are separated into cohesive modules under `interpreter/eval/exe/`.
- Executable definition shapes and metadata/security propagation remain behavior-compatible.
- Shared definition-builder contracts and wrapper context types are defined once and reused.

Wave 2 guardrails for every phase in this epic:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate subtype builder logic across core and control-flow families.
- Do not compose builder services via callback-lambda constructor bundles.
- Verify no circular dependencies inside `interpreter/eval/exe*` after each phase.

## Minimum Targeted Test Evidence

Every phase note includes targeted coverage from suites that exercise this area, using files such as:
- `interpreter/eval/if.test.ts`
- `tests/interpreter/security-metadata.test.ts`
- representative fixtures under `tests/cases/feat/exe-blocks/*`
- representative fixtures under `tests/cases/valid/feat/exe-*`

## Acceptance Criteria

1. Phase tickets (0-7) exist under this epic and are dependency-linked in sequence.
2. Each phase ticket includes explicit implementation instructions and explicit exit criteria.
3. Final structure splits responsibilities into cohesive modules under `interpreter/eval/exe/` (or equivalent) and reduces `exe.ts` to orchestration.
4. Final validation command passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-11 17:33 UTC:** Epic completion architecture note (`interpreter/eval/exe.ts` modularization).

Final module map + responsibilities:
- interpreter/eval/exe.ts (107 lines): top-level `evaluateExe` orchestration, subtype family dispatch, security/context assembly wiring, and stable export surface.
- interpreter/eval/exe/block-execution.ts (124): executable block runtime and control-return propagation.
- interpreter/eval/exe/definition-helpers.ts (157): shared subtype parse/materialization helpers and guardrails for definition construction.
- interpreter/eval/exe/environment-declaration.ts (106): shadow environment declaration handling and wrapper routing.
- interpreter/eval/exe/core-definition-builders.ts (560): command/data/value/code/resolver/template/template-file/section/prose definition builders.
- interpreter/eval/exe/control-flow-definition-builders.ts (165): when/foreach/for/loop/block control-flow executable builders.
- interpreter/eval/exe/variable-assembly.ts (198): executable Variable materialization, source syntax tagging, security metadata/capability propagation, and autosign integration.
- interpreter/eval/exe/sync-js-wrapper.ts (82): synchronous JS wrapper behavior and assignment-context wrapping.
- interpreter/eval/exe/exec-wrapper.ts (152): async exec wrapper behavior, invocation context normalization, and secure runtime invocation.

Composition seams and callback policy:
- Composition remains direct via imported services/helpers.
- No callback-lambda constructor bundles are introduced.
- No recursion-only seam requiring callback injection exists in this extraction area.

Distribution + guardrails:
- Runtime extraction area line counts: 82, 106, 124, 152, 157, 165, 198, 560 (+ orchestrator 107).
- No extracted runtime module is under 60 lines.
- No extracted runtime module is a thin forwarder; each owns concrete behavior.
- Shared helpers/types remain centralized and reused; no duplicated subtype-builder logic.
- Dependency direction in interpreter/eval/exe* remains acyclic.

Epic validation evidence:
- Full gate pass at epic completion:
  npm run build && npm test && npm run test:tokens && npm run test:examples
