---
id: m-719d
status: closed
deps: []
created: 2026-02-09T07:00:10Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-68f8
tags: [refactor, guard-post-hook, phase-0]
updated: 2026-02-10T09:38:47Z
---
# Refactor Program: Modularize interpreter/hooks/guard-post-hook.ts - Phase 0: Baseline and characterization



Objective:
Establish characterization coverage for after-guard behavior before extraction.

Instructions for the implementing agent:
- In scope: characterization tests and extraction-boundary mapping only.
- Out of scope: code movement and behavior changes.
- Map major flows: guard selection, streaming guard denial, per-input/per-operation decisions, retry/error paths, and transformed output emission.
- Add/expand tests for descriptor propagation, label modifications, retry vs deny branching, and pipeline non-retryable enforcement.
- Capture extraction seams and regression risks; do not move code across files in this phase.

Preserve behavior checks:
- Guard selection precedence remains baseline-locked (output labels, input fallback, operation labels).
- Deny/retry decisions and non-retryable source enforcement remain baseline-locked.
- Descriptor and label-modification propagation remains baseline-locked.
- Guard runtime action behavior and metadata payload shapes remain baseline-locked.

## Acceptance Criteria

1. Characterization coverage exists for all high-risk flows and preserve-behavior checks.
2. Baseline notes include concrete extraction boundaries and regression hazards.
3. No intentional runtime semantic change is introduced.
4. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 09:38 UTC:** Completed phase-0 characterization without code movement in runtime modules.

What changed:
- Expanded `tests/interpreter/hooks/guard-post-hook.test.ts` with baseline-lock tests for:
  - output-label vs input-fallback selection behavior,
  - operation-label guard selection path,
  - deny vs retry precedence,
  - retry behavior for retryable pipeline sources,
  - descriptor/label propagation for transformed outputs.
- Added local helper `createLabeledVariable(...)` for concise fixture setup in guard-post tests.

Checklist coverage completed:
- guard selection precedence mapping (output labels -> input fallback -> operation scope)
- streaming deny branch preserved via existing + targeted suites
- deny/retry branching and non-retryable enforcement preserved
- transformed output descriptor + label-modification propagation preserved
- no runtime extraction/movement in this phase (tests only)

Extraction seams / regression hazards captured:
- selection-source coupling (output path, input fallback, operation keys/opLabels)
- retry/deny reduction ordering and retry-signal gating
- pipeline sourceRetryable enforcement boundary
- transformed-output metadata propagation boundary

Tests run:
- `npx vitest run tests/interpreter/hooks/guard-post-hook.test.ts tests/streaming/guard-streaming.test.ts` ✅
- `npm run build && npm test && npm run test:tokens && npm run test:examples` ✅
