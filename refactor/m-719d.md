---
id: m-719d
status: open
deps: []
created: 2026-02-09T07:00:10Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-68f8
tags: [refactor, guard-post-hook, phase-0]
updated: 2026-02-09T07:00:10Z
---
# Refactor Program: Modularize interpreter/hooks/guard-post-hook.ts - Phase 0: Baseline and characterization



Objective:
Establish characterization coverage for after-guard behavior before extraction.

Instructions for the implementing agent:
- In scope: characterization tests and extraction-boundary mapping only.
- Out of scope: code movement and behavior changes.
- Map major flows: guard selection, streaming guard denial, per-input/per-operation decisions, retry/error paths, and transformed output emission.
- Add/expand tests for descriptor propagation, label modifications, retry vs deny branching, and pipeline non-retryable enforcement.
- Capture extraction seams and regression risks; do not move code across files in this phase.

Preserve behavior checks:
- Guard selection precedence remains baseline-locked (output labels, input fallback, operation labels).
- Deny/retry decisions and non-retryable source enforcement remain baseline-locked.
- Descriptor and label-modification propagation remains baseline-locked.
- Guard runtime action behavior and metadata payload shapes remain baseline-locked.

## Acceptance Criteria

1. Characterization coverage exists for all high-risk flows and preserve-behavior checks.
2. Baseline notes include concrete extraction boundaries and regression hazards.
3. No intentional runtime semantic change is introduced.
4. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples
