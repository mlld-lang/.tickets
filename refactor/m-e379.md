---
id: m-e379
status: closed
deps: [m-96c2]
links: []
created: 2026-02-09T06:03:26Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-9f2b
tags: [refactor, exec-invocation, phase-2, streaming]
updated: 2026-02-10T19:08:47Z
---
# Phase 2: Isolate exec invocation streaming lifecycle

Objective:
Isolate streaming lifecycle setup/finalization logic.

Instructions for the implementing agent:
- Extract streaming option resolution, adapter selection, chunk effect wiring, and finalization into `interpreter/eval/exec/streaming.ts` (or equivalent).
- Preserve semantics for:
  - stream request detection from invocation and with-clause metadata
  - stream format adapter loading
  - chunk deduping/output routing
  - finalization in the `finally` path (`finalizeResults`, `setStreamingResult`)
- Ensure no regression in streaming and provenance execution tests.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Streaming lifecycle code is isolated behind a clear API.
2. Finally-path cleanup semantics remain identical.
3. Streaming/provenance related tests pass.
4. Full test gate passes and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-10 19:08 UTC:** Completed Phase 2 streaming lifecycle isolation for exec invocation without behavior changes.

Checklist completion:
- [x] Isolated streaming option resolution and stream request detection from invocation and with-clause metadata.
- [x] Isolated stream-format adapter selection and streaming manager configuration.
- [x] Isolated chunk dedupe and output routing behavior into a single chunk-effect factory.
- [x] Isolated finally-path streaming finalization (`finalizeResults` + `setStreamingResult`).

Touched runtime modules and ownership:
- `interpreter/eval/exec/streaming.ts` (128 LOC): streaming setup/configure, definition-level stream request merge helper, chunk effect creation, finalization helper.
- `interpreter/eval/exec-invocation.ts` (3902 LOC): delegates streaming lifecycle to `exec/streaming.ts` while preserving existing control flow.

Wave 2 guardrail attestation:
- No new runtime module under 60 LOC was introduced.
- No callback-lambda service-composition injection was introduced.
- Shared streaming lifecycle helpers/types for this extraction area are defined once in `exec/streaming.ts` and imported.
- Dependency direction remains acyclic in touched area (`exec-invocation.ts` -> `exec/streaming.ts`).

Targeted test evidence:
- `npm run build && npx vitest run interpreter/eval/exec-invocation.structured.test.ts interpreter/stream-execution.test.ts tests/streaming/regression-output.test.ts tests/interpreter/hooks/pipeline-context.test.ts tests/pipeline/exec-structured.test.ts` => PASS.

Full gate evidence:
- `npm run build && npm test && npm run test:tokens && npm run test:examples` => PASS.
