---
id: m-e379
status: open
deps: [m-96c2]
links: []
created: 2026-02-09T06:03:26Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-9f2b
tags: [refactor, exec-invocation, phase-2, streaming]
---
# Phase 2: Isolate exec invocation streaming lifecycle

Objective:
Isolate streaming lifecycle setup/finalization logic.

Instructions for the implementing agent:
- Extract streaming option resolution, adapter selection, chunk effect wiring, and finalization into `interpreter/eval/exec/streaming.ts` (or equivalent).
- Preserve semantics for:
  - stream request detection from invocation and with-clause metadata
  - stream format adapter loading
  - chunk deduping/output routing
  - finalization in the `finally` path (`finalizeResults`, `setStreamingResult`)
- Ensure no regression in streaming and provenance execution tests.

## Acceptance Criteria

1. Streaming lifecycle code is isolated behind a clear API.
2. Finally-path cleanup semantics remain identical.
3. Streaming/provenance related tests pass.
4. Full test gate passes and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

