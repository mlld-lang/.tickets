---
id: m-735c
status: closed
deps: [m-70f1]
created: 2026-02-09T07:00:10Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-68f8
tags: [refactor, guard-post-hook, phase-2]
updated: 2026-02-10T09:49:59Z
---
# Refactor Program: Modularize interpreter/hooks/guard-post-hook.ts - Phase 2: Extract descriptor and output normalization services



Objective:
Isolate output/descriptor shaping logic used across guard decisions.

Instructions for the implementing agent:
- In scope: output normalization, descriptor extraction/merge/apply, replacement normalization.
- Out of scope: decision loop orchestration and retry error signal construction.
- Extract raw output normalization, output descriptor extraction, descriptor merge/apply helpers, and replacement normalization.
- Preserve structured value handling and descriptor application semantics for transformed outputs.
- Add tests for descriptor merge behavior across output/input fallback and replacement paths.

Module boundaries:
- Descriptor module owns descriptor extraction/merge/apply behavior.
- Output normalization module owns raw/transformed output shaping.
- Decision engine consumes normalized outputs and descriptors.

Preserve behavior checks:
- Descriptor propagation and label modifications remain unchanged.
- Structured value output handling remains unchanged.
- Replacement-path descriptor semantics remain unchanged.

## Acceptance Criteria

1. Descriptor/output normalization logic is extracted into focused modules.
2. Descriptor merge/apply and replacement normalization behavior remain baseline-compatible.
3. Tests cover descriptor propagation across fallback and replacement paths.
4. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 09:49 UTC:** Completed phase-2 extraction for descriptor/output normalization services in guard post-hook.

What changed:
- Added descriptor service module `interpreter/hooks/guard-post-descriptor.ts` with:
  - `extractOutputDescriptor`
  - `mergeDescriptorWithFallbackInputs`
  - `mergeGuardDescriptor`
  - `applyDescriptorToVariables`
- Added output normalization module `interpreter/hooks/guard-post-output-normalization.ts` with:
  - `normalizeRawOutput`
  - `normalizeFallbackOutputValue`
  - `normalizeReplacementVariables`
  - `buildTransformedGuardResult`
- Updated `interpreter/hooks/guard-post-hook.ts` to consume extracted services and removed duplicated inline implementations.
- Added focused tests:
  - `tests/interpreter/hooks/guard-post-descriptor.test.ts`
  - `tests/interpreter/hooks/guard-post-output-normalization.test.ts`

Checklist coverage completed:
- raw output normalization extracted ✅
- output descriptor extraction/merge/apply extracted ✅
- replacement normalization extracted ✅
- structured transformed-output shaping extracted ✅
- descriptor propagation and replacement-path semantics validated via focused tests + hook integration suites ✅

Tests run:
- `npx vitest run tests/interpreter/hooks/guard-post-descriptor.test.ts tests/interpreter/hooks/guard-post-output-normalization.test.ts tests/interpreter/hooks/guard-post-hook.test.ts tests/interpreter/hooks/guard-pre-hook.test.ts` ✅
- `npm run build && npm test && npm run test:tokens && npm run test:examples` ✅
