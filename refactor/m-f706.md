---
id: m-f706
status: open
deps: []
created: 2026-02-09T06:44:04Z
type: task
priority: 1
assignee: Adam Avenir
---
# Refactor Program: Modularize interpreter/eval/run.ts - Phase 0: Baseline and characterization

Objective:
Establish a behavior baseline and refactor safety net for interpreter/eval/run.ts before moving logic into new modules.

Instructions for the implementing agent:
- Produce a subtype-to-responsibility map for evaluateRun covering runCommand, runCode, runExec, runExecInvocation, runExecReference, and runPipeline.
- Add or expand characterization tests that lock current behavior for high-risk paths:
  - command interpolation, command policy denial, command analyzer blocking, command-size guard, workingDir resolution
  - stdin resolution from withClause.stdin and pre-extracted stdin inputs
  - operation-context updates (labels, sources, command metadata) for command and code paths
  - runCode argument extraction and auto-unwrap behavior
  - runExec field access resolution, commandRef recursion, and circular-call detection
  - executable definition handling for command, commandRef, builtin transformer, code, template, and prose
  - pipeline application from withClause.pipeline, stage-0 retry eligibility, and descriptor hint propagation
  - streaming + streamFormat finalization and effect-emission gating
- Capture baseline risk notes and module extraction boundaries in this ticket.
- Do not perform structural refactors in this phase.

## Acceptance Criteria

1. Characterization tests cover the high-risk paths listed above and pass.
2. Baseline responsibility map and extraction boundaries are attached to this ticket.
3. No intentional runtime semantic change is introduced.
4. Exit criteria (required before next phase): full test gate passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

