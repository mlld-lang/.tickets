---
id: m-f706
status: closed
deps: [m-3bb8]
created: 2026-02-09T06:44:04Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-bd66
tags: [refactor, run, phase-0]
updated: 2026-02-11T06:54:40Z
---
# Refactor Program: Modularize interpreter/eval/run.ts - Phase 0: Baseline and characterization

Objective:
Establish a behavior baseline and refactor safety net for interpreter/eval/run.ts before moving logic into new modules.

Instructions for the implementing agent:
- Produce a subtype-to-responsibility map for evaluateRun covering runCommand, runCode, runExec, runExecInvocation, runExecReference, and runPipeline.
- Add or expand characterization tests that lock current behavior for high-risk paths:
  - command interpolation, command policy denial, command analyzer blocking, command-size guard, workingDir resolution
  - stdin resolution from withClause.stdin and pre-extracted stdin inputs
  - operation-context updates (labels, sources, command metadata) for command and code paths
  - runCode argument extraction and auto-unwrap behavior
  - runExec field access resolution, commandRef recursion, and circular-call detection
  - executable definition handling for command, commandRef, builtin transformer, code, template, and prose
  - pipeline application from withClause.pipeline, stage-0 retry eligibility, and descriptor hint propagation
  - streaming + streamFormat finalization and effect-emission gating
- Capture baseline risk notes and module extraction boundaries in this ticket.
- Do not perform structural refactors in this phase.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Characterization tests cover the high-risk paths listed above and pass.
2. Baseline responsibility map and extraction boundaries are attached to this ticket.
3. No intentional runtime semantic change is introduced.
4. Exit criteria (required before next phase): full test gate passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-11 06:31 UTC:** Phase 0 baseline + characterization checkpoint completed.

What changed (phase-0 only; no structural refactor):
- Added `interpreter/eval/run.characterization.test.ts` (472 LOC) to lock high-risk `run.ts` branch behavior before extraction.
- Kept runtime logic unchanged; this phase is characterization + boundary mapping only.

Subtype-to-responsibility map for `evaluateRun` (`interpreter/eval/run.ts`):
- Entry orchestrator: `evaluateRun` at line 180.
- `runCommand` branch starts at line 357.
  - command interpolation / pre-extracted command resolution
  - command-size guard
  - analyzer + policy checks
  - stdin/using/env-auth flows
  - provider-vs-local execution wiring
  - command operation-context updates
- `runCode` branch starts at line 673.
  - raw code extraction + dedent
  - arg extraction + auto-unwrap
  - capability policy + arg label-flow checks
  - code execution wiring + code operation-context updates
- `runExec` branch starts at line 787.
  - executable lookup (simple + field-access)
  - definition dispatch (command, commandRef, builtin transformer, code, template, prose)
  - recursion / circular-call checks
- `runExecInvocation` branch starts at line 1432.
- `runExecReference` branch starts at line 1444.
- `runPipeline` branch starts at line 1456.
- post-execution lifecycle:
  - pipeline application (`withClause.pipeline`) starts at line 1476
  - streaming finalization starts at line 1509
  - effect-emission gating (`shouldEmitFinalOutput`) starts at line 1543

Baseline extraction boundaries for next phases:
- Phase 1: pure helpers + pre-extracted input readers (`extractRawTextContent`, `dedentCommonIndent`, `resolveRunCodeOpType`, `mergeAuthUsing`, pre-extracted command/stdin/exec readers).
- Phase 2: shared operation-context/policy/label-flow helpers.
- Phase 3: isolate full `runCommand` orchestration seam.
- Phase 4: isolate full `runCode` orchestration seam.
- Phase 5: isolate executable reference resolver (including field-chain path).
- Phase 6: isolate executable definition handlers/dispatcher.
- Phase 7: isolate pipeline/streaming/output finalization lifecycle.

Baseline risk notes locked by characterization:
- Builtin transformer runExec field-access invocation currently throws `input.trim is not a function` for `@json.strict(...)` in this path.
- Simple commandRef recursion path currently raises `Run exec directive identifier must be a command reference` in recursive fallback.
- Non-replayable stage-0 retry in run pipeline path currently resolves to base output rather than hard-failing.

Touched runtime modules and ownership:
- `interpreter/eval/run.ts` (1652 LOC): unchanged runtime orchestrator owning all run subtype branches + lifecycle.

Guardrail confirmations (phase-0):
- No new runtime modules added, so no new sub-60 runtime module introduced.
- No callback-lambda service injection introduced.
- No shared-type duplication introduced in runtime code.
- Dependency direction unchanged in runtime area for this phase (test-only additions).

Targeted sub-checkpoint evidence (pass):
- `npm run build && npx vitest run interpreter/eval/run.characterization.test.ts interpreter/eval/run.structured.test.ts interpreter/eval/run-in-blocks.test.ts tests/integration/policy-command-exec.test.ts tests/pipeline-context-retry.test.ts`

**2026-02-11 06:54 UTC:** Full gate evidence (phase-0 exit criteria) completed:\n- npm run build && npm test && npm run test:tokens && npm run test:examples\n- Status: PASS (all commands exited 0 in local run).\nNo runtime behavior changes were introduced in phase-0; only characterization and boundary mapping.
