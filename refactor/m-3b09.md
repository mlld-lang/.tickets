---
id: m-3b09
status: open
deps: [m-65ab]
created: 2026-02-09T07:00:11Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-68f8
tags: [refactor, guard-post-hook, phase-7]
updated: 2026-02-09T07:00:11Z
---
# Refactor Program: Modularize interpreter/hooks/guard-post-hook.ts - Phase 7: Final composition cleanup and shared-boundary verification



Objective:
Reduce `guard-post-hook.ts` to composition and finalize module boundaries.

Instructions for the implementing agent:
- In scope: final orchestration cleanup, dependency-direction verification, and parity validation.
- Out of scope: new guard features or behavior changes.
- Refactor `guardPostHook` to orchestrate extracted collaborators with minimal inline branching.
- Remove duplicate or dead logic introduced during extraction and verify no cyclic dependencies in new modules.
- Attach architecture notes documenting module boundaries and integration points with guard-pre/shared utilities.
- Run final parity checks against Phase 0 baselines for selection precedence, retry enforcement, descriptor/label propagation, and runtime/helper behavior.

Module boundaries:
- `guard-post-hook.ts` is orchestration-only after this phase.
- Extracted modules have acyclic dependencies with explicit ownership (selection, normalization, decision engine, retry enforcement, runtime/actions, helpers).
- Hook output/error contracts remain stable.

Preserve behavior checks:
- Guard selection precedence remains unchanged.
- Deny/retry/non-retryable enforcement remains unchanged.
- Descriptor and label-modification propagation remains unchanged.
- Helper/runtime action behavior and metadata/error payloads remain unchanged.

Micro-checklist (final parity gate):
- Add end-to-end cases that combine multi-guard matching + transformed outputs + retry enforcement.
- Add a case where selection precedence changes candidate order and assert unchanged final decision.
- Add descriptor/label propagation assertions for both deny and retry-emitting flows.
- Add a full integration case that exercises runtime actions plus helper-injected behavior in after-hook timing.

## Acceptance Criteria

1. `guard-post-hook.ts` becomes orchestration-focused with clear, acyclic module boundaries.
2. Runtime behavior, error surface, and metadata contracts remain baseline-compatible.
3. Final parity checks cover all listed preserve-behavior requirements.
4. Every item in the micro-checklist is backed by explicit tests before closing this phase.
5. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples
