---
id: m-2e93
status: closed
deps: [m-8659]
created: 2026-02-09T07:06:40Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-9747
tags: [refactor, core-interpreter, phase-4]
updated: 2026-02-10T12:28:25Z
---
# Refactor Program: Modularize interpreter/core/interpreter.ts - Phase 4: Extract specialized expression/node evaluators



Objective:
Isolate specialized node-family evaluators into explicit modules with stable return contracts.

Instructions for the implementing agent:
- In scope: extract specialized handlers for complex node families listed in this ticket.
- Out of scope: top-level dispatch semantics, interpolation/security adapter extraction, and namespace utility extraction.
- Split node-family handlers into modules under `interpreter/core/interpreter/handlers/` (or equivalent) with one module per family cluster.
- Preserve delegation boundaries and return-shape contracts for each family.
- Add tests for parity across ExecInvocation, VariableReferenceWithTail, NewExpression, LabelModification, unified expressions, control-flow nodes (`when`/`for`/`loop`/`foreach`), load-content/file-reference, code, and command nodes.

Module boundaries:
- Each specialized handler owns one node family and receives explicit interpreter context.
- Shared helper dependencies are imported through stable utility modules only.
- Handler modules do not alter global intent/effect ordering rules.

Preserve behavior checks:
- Node-family return shapes and wrappers remain baseline-compatible.
- Delegation boundaries remain stable between dispatch and specialized handlers.
- Control-flow node semantics remain unchanged.
- Load-content/file-reference and command/code node behavior remains unchanged.

Micro-checklist (node-family drift guard):
- Add one positive and one negative-path test per extracted node family cluster (`ExecInvocation`, `VariableReferenceWithTail`, `NewExpression`, `LabelModification`, unified expressions, control-flow, load-content/file-reference, code, command).
- Add a dispatch-to-handler identity assertion for each family so routing drift fails fast.
- Assert return-shape invariants per family (primitive/wrapper/object expectations) using baseline snapshots.
- Assert expression-context vs document-context behavior remains unchanged for families that depend on context.
- Assert effect/intent ordering remains unchanged for families that emit effects.

## Acceptance Criteria

1. Specialized node-family handlers are extracted into cohesive modules with explicit boundaries.
2. Delegation behavior and return contracts remain baseline-compatible.
3. Preserve-behavior checks are covered for each listed node family.
4. Every item in the micro-checklist is backed by explicit tests before closing this phase.
5. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 12:26 UTC:** Phase implementation complete:
- Extracted specialized node-family handlers into interpreter/core/interpreter/handlers/: execInvocation, variableReferenceWithTail, newExpression, labelModification, unifiedExpression, control-flow (when/exeBlock/foreach/for/loop), load-content, file-reference, code, and command.
- Rewired interpreter/core/interpreter.ts to delegate those families through dedicated handler modules while preserving existing dispatch ordering and return contracts.
- Added handler identity registry (handler-registry.ts) and dispatch identity assertions in interpreter/core/interpreter/dispatch.test.ts.
- Added comprehensive parity tests in interpreter/core/interpreter/handlers/specialized-handlers.test.ts covering positive/negative paths for each extracted family cluster, context-sensitive behavior checks, return-shape invariants (inline snapshots), and effect behavior assertions for when-expression effect payload handling.

Micro-checklist status:
- [x] Positive and negative-path coverage per extracted family cluster
- [x] Dispatch-to-handler identity assertions for extracted families
- [x] Return-shape invariants asserted for extracted families
- [x] Context-sensitive behavior checks retained where context influences semantics
- [x] Effect behavior assertions retained for families producing effect payloads

Tests run:
- npx vitest run interpreter/core/interpreter/handlers/specialized-handlers.test.ts interpreter/core/interpreter/dispatch.test.ts interpreter/core/interpreter.characterization.test.ts interpreter/core/interpreter/traversal.test.ts interpreter/core/interpreter/resolve-variable-reference.test.ts => PASS
- npm run build && npm test && npm run test:tokens && npm run test:examples => PASS

**2026-02-10 12:28 UTC:** Phase complete.
- Commit: 542a556c2
- Post-commit full gate rerun: npm run build && npm test && npm run test:tokens && npm run test:examples => PASS
- Exit criteria satisfied; phase ready to close.
