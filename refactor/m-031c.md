---
id: m-031c
status: closed
deps: [m-6f9d]
created: 2026-02-09T07:01:17Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-225c
tags: [refactor, content-loader, phase-6]
updated: 2026-02-10T16:19:36Z
---
# Refactor Program: Modularize interpreter/eval/content-loader.ts - Phase 6: Extract transform/template application and result finalization



Objective:
Modularize transform and wrapping/finalization layers.

Instructions for the implementing agent:
- In scope: transform/template application helpers and finalization adapter extraction.
- Out of scope: source transport and section extraction internals.
- Extract transform/template application helpers (`applyTransformToResults`, `applyTemplateToAstResults`) into transformation modules.
- Extract finalization helpers (`finalizeLoaderResult`, type/text inference, metadata merging) into a structured output adapter module.
- Add tests for output shape consistency across strings, arrays, LoadContentResult objects, and structured values.

Module boundaries:
- Transformation module owns transform/template application behavior.
- Finalization adapter module owns type/text inference, metadata merge, and return-shape normalization.
- Loader orchestration invokes these modules as terminal stages.

Preserve behavior checks:
- Transform/template application semantics remain unchanged.
- Finalization return-shape contracts remain unchanged across supported result families.
- Metadata merge behavior during finalization remains unchanged.
- Downstream pipeline compatibility of finalized outputs remains unchanged.

Micro-checklist (mixed output-shape matrix):
- Add mixed transform cases that produce both text and structured outputs in the same run and assert stable finalization shape.
- Add glob + AST + template combined cases and assert unchanged wrapper/type inference behavior.
- Add metadata-merge edge cases where transformed structured values carry descriptors and assert unchanged merge results.
- Add downstream pipeline compatibility assertions for each finalized output family.

## Acceptance Criteria

1. Transform and finalization logic is extracted into dedicated modules.
2. Output-shape and metadata contracts remain baseline-compatible.
3. Tests cover strings, arrays, structured objects, and LoadContentResult finalization parity.
4. Every item in the micro-checklist is backed by explicit tests before closing this phase.
5. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 16:19 UTC:** Implemented phase scope by extracting transformation and finalization logic from content-loader orchestration.

Changes:
- Added interpreter/eval/content-loader/transform-utils.ts with applyTransformToResults and applyTemplateToAstResults.
- Added interpreter/eval/content-loader/finalization-adapter.ts with finalizeLoaderResult and type/text/metadata merge helpers.
- Updated interpreter/eval/content-loader.ts to delegate terminal transform/finalization behavior to the extracted modules.
- Added interpreter/eval/content-loader/finalization-adapter.test.ts and expanded content-loader characterization coverage for output-shape parity.

Checklist completed:
- mixed transform cases (text + structured output finalization shape)
- glob + AST + template combined wrapper/type inference behavior
- metadata merge edge cases for transformed structured values
- downstream pipeline compatibility across finalized output families

Tests:
- Targeted: npx vitest run interpreter/eval/content-loader.characterization.test.ts interpreter/eval/content-loader.test.ts interpreter/eval/content-loader-ast.test.ts interpreter/eval/content-loader.structured.test.ts interpreter/eval/content-loader/finalization-adapter.test.ts (pass)
- Full gate: npm run build && npm test && npm run test:tokens && npm run test:examples (pass)
