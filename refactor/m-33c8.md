---
id: m-33c8
status: closed
deps: [m-2136]
created: 2026-02-09T07:00:10Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-68f8
tags: [refactor, guard-post-hook, phase-4]
updated: 2026-02-10T10:02:00Z
---
# Refactor Program: Modularize interpreter/hooks/guard-post-hook.ts - Phase 4: Extract retry enforcement and error signal builders



Objective:
Isolate after-guard retry/deny error construction and enforcement logic.

Instructions for the implementing agent:
- In scope: retry context retrieval, retryability enforcement, and retry/deny signal builder extraction.
- Out of scope: guard runtime evaluator extraction and helper injection extraction.
- Extract retry context retrieval, retryability checks, and deny-on-non-retryable-source behavior into a dedicated module.
- Extract `GuardError`/`GuardRetrySignal` builders while preserving payload and metadata shape.
- Add tests for retry denied vs retry signaled paths, including hint/reason propagation.

Module boundaries:
- Retry enforcement module owns retryability checks and source-type gating.
- Signal builder module owns `GuardError` and `GuardRetrySignal` payload construction.
- Decision engine delegates enforcement and signal creation through explicit APIs.

Preserve behavior checks:
- Retry allowed/denied branching remains unchanged.
- Non-retryable source denial enforcement remains unchanged.
- Retry/deny payload and metadata shapes remain unchanged.

Micro-checklist (retry enforcement edge matrix):
- Add cases for retryable and non-retryable sources that both request retry and assert branch outcome parity.
- Add a case where retry is requested after output transformation and assert identical enforcement behavior.
- Add payload-shape assertions for both `GuardRetrySignal` and deny `GuardError` paths, including hints/reasons metadata.
- Add a case with missing retry context and assert unchanged fallback behavior.

## Acceptance Criteria

1. Retry enforcement and signal builders are extracted into focused modules.
2. Retry/deny enforcement semantics remain baseline-compatible.
3. Tests cover retry-denied, retry-signaled, and metadata propagation paths.
4. Every item in the micro-checklist is backed by explicit tests before closing this phase.
5. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 10:01 UTC:** Refactor slice complete: extracted retry-context/retryability enforcement into interpreter/hooks/guard-post-retry.ts and GuardError/GuardRetrySignal payload builders into interpreter/hooks/guard-post-signals.ts; guard-post-hook now delegates to these modules. Checklist complete: (1) retryable vs non-retryable retry request parity, (2) retry-after-transform enforcement parity, (3) payload shape assertions for GuardRetrySignal and deny GuardError including hints/reasons, (4) missing retry-context fallback behavior. Tests: npx vitest run tests/interpreter/hooks/guard-post-retry.test.ts tests/interpreter/hooks/guard-post-signals.test.ts tests/interpreter/hooks/guard-post-hook.test.ts tests/interpreter/hooks/guard-post-decision-engine.test.ts tests/interpreter/hooks/guard-pre-hook.test.ts (PASS); npm run build && npm test && npm run test:tokens && npm run test:examples (PASS).
