---
id: m-1781
status: closed
deps: [m-7b5b]
links: []
created: 2026-02-09T06:24:51Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-d11b
tags: [refactor, var, phase-1, security]
updated: 2026-02-11T04:10:46Z
---
# Refactor Program: Modularize interpreter/eval/var.ts - Phase 1: Extract assignment context and descriptor services

Objective:
Extract assignment-context and security-descriptor helpers from `var.ts` without changing behavior.

Instructions for the implementing agent:
- Move identifier/metadata/security setup logic into focused helpers (example targets: `interpreter/eval/var/assignment-context.ts` and `interpreter/eval/var/security-descriptor.ts`).
- Extract descriptor collectors and merge helpers from `prepareVarAssignment`, including template/data AST descriptor scans.
- Preserve externally consumed exports (including `extractDescriptorsFromDataAst`) through re-export or compatibility wrapper if module boundaries change.
- Keep call order intact in `prepareVarAssignment` so downstream phases do not absorb behavior drift.
- Add focused unit tests for descriptor extraction/merge edge cases and assignment context generation.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Assignment context and descriptor helper logic live in dedicated module(s) with narrow interfaces.
2. `prepareVarAssignment` behavior and exported API surface remain stable.
3. Added tests cover descriptor extraction/merge edge cases.
4. Exit criteria: all tests pass, with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-11 04:10 UTC:** Phase close evidence (post-regression fix):

Implemented:
- interpreter/eval/var/assignment-context.ts (73 LOC): owns identifier/capability/source metadata extraction and preserves raw directive securityLabels for downstream metadata application.
- interpreter/eval/var/security-descriptor.ts (291 LOC): owns descriptor-state lifecycle, merge/extract helpers, and descriptor application paths.
- interpreter/eval/var.ts (2145 LOC): orchestration keeps prepareVarAssignment/evaluateVar flow; patch applies raw securityLabels from assignment context into applySecurityOptions to preserve unlabeled/default semantics.

Checklist status:
- [x] Extract assignment context and descriptor helpers into focused modules.
- [x] Preserve exported API surface, including extractDescriptorsFromDataAst compatibility from var.ts.
- [x] Keep call order in prepareVarAssignment unchanged.
- [x] Add focused tests for extracted modules and descriptor behavior.

Targeted tests:
- npx vitest run interpreter/eval/var/assignment-context.test.ts interpreter/eval/var/security-descriptor.test.ts interpreter/eval/var.characterization.test.ts tests/interpreter/security-metadata.test.ts interpreter/interpreter.fixture.test.ts -t "influenced-label-propagation|audit-log-taint|collection-element-access-array|collection-element-access-object|defaults-unlabeled-trust-label|expression-descriptor|expression-tracking|pipeline-taint" -> PASS

Full gate:
- npm run build && npm test && npm run test:tokens && npm run test:examples -> PASS

Guardrail evidence:
- No new sub-60 runtime modules introduced in this phase (runtime modules are 73 LOC and 291 LOC; type/barrel exceptions not used).
- No callback-lambda service injection introduced; composition uses direct function/service module calls.
- No cycle introduced in touched var extraction area (assignment-context and security-descriptor remain leaf helpers imported by var.ts).
