---
id: m-68f8
status: closed
deps: [m-c494]
created: 2026-02-09T07:00:09Z
type: epic
priority: 1
assignee: Adam Avenir
tags: [refactor, guard-post-hook]
updated: 2026-02-10T10:27:16Z
---
# Refactor Program: Modularize interpreter/hooks/guard-post-hook.ts



Largest unplanned target file: `interpreter/hooks/guard-post-hook.ts` (~1,588 LOC).

This epic coordinates a phased refactor that decomposes post-guard evaluation into focused modules while preserving deny/retry behavior, descriptor propagation, output transformation behavior, and after-guard retry enforcement semantics.

Execution order:
1. Phase 0 through Phase 7 proceed strictly in order.
2. Each phase closes only after its exit criteria are met.
3. No phase starts until its dependency ticket is closed.

Cross-phase constraints:
- Keep `guardPostHook` contract and output behavior stable.
- Preserve guard override handling and guard selection precedence (output labels, input fallback, operation labels).
- Preserve after-guard retry semantics, retry-signal construction, and non-retryable source denial behavior.
- Preserve descriptor merge/label-modification propagation across transformed outputs.
- Preserve guard helper/runtime behavior and metadata/error payload shapes.

## Acceptance Criteria

1. Phase tickets (0-7) exist under this epic and are dependency-linked in sequence.
2. Each phase ticket includes explicit implementation instructions and explicit exit criteria.
3. Final structure splits responsibilities into cohesive modules under `interpreter/hooks/guard-post/` (or equivalent) and reduces `guard-post-hook.ts` to orchestration.
4. Final validation command passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-09 08:15 UTC:** Safety-hardening pass completed for phases m-719d -> m-3b09.

Tightening applied:
- Added explicit in-scope/out-of-scope boundaries to each phase.
- Added concrete module boundaries for override/selection utilities, descriptor normalization, decision engine, retry enforcement, runtime actions, and helper/clone utilities.
- Added explicit preserve-behavior checks for guard selection precedence, deny/retry/non-retryable enforcement, descriptor/label propagation, and helper/runtime action behavior.
- Standardized each phase exit criteria to require:
  npm run build && npm test && npm run test:tokens && npm run test:examples

Dependency verification:
- Verified linear chain with `tk dep tree --full m-3b09` in a temporary workspace mount that maps `.tickets/refactor` as `.tickets`.
- No dependency rewiring required.

Residual risk:
- Decision engine + retry enforcement split has tight coupling; final parity checks must include multi-guard traces where retry and transformed outputs interact.

**2026-02-09 08:25 UTC:** Micro-planning addendum (hotspot): added decision/retry interaction checklists to phases m-2136, m-33c8, and m-3b09.

Focus:
- Covers multi-guard traces where transformed outputs and retry enforcement interact.
- Adds explicit closure gates requiring checklist-backed tests before each phase closes.

**2026-02-10 10:27 UTC:** --dir refactor
