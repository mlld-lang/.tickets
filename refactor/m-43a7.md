---
id: m-43a7
status: open
deps: [m-e62f]
created: 2026-02-09T06:44:04Z
type: task
priority: 1
assignee: Adam Avenir
updated: 2026-02-09T06:44:11Z
---
# Refactor Program: Modularize interpreter/eval/run.ts - Phase 3: Extract run-command execution orchestration

Objective:
Move runCommand execution flow into a dedicated module that owns command preparation, security checks, and execution wiring.

Instructions for the implementing agent:
- Extract the runCommand branch into a command executor module with a clear input/output contract.
- Include command source resolution (pre-extracted command vs interpolation), parsed-command metadata, and command-size pre-check.
- Include stdin resolution and descriptor handling for withClause.stdin.
- Include security-manager analyzer checks and policy checks in the extracted flow.
- Include working-directory resolution, environment/provider config resolution, auth/using merges, and provider-vs-local execution path.
- Preserve propagation of output descriptors and operation-context metadata.
- Add focused tests for command branch behavior, including provider path and command-size/security failures.

## Acceptance Criteria

1. runCommand logic is extracted behind a dedicated orchestration API.
2. Existing command behaviors (including provider execution, stdin handling, security checks, and descriptor propagation) remain unchanged.
3. Focused tests cover command success and failure variants.
4. Exit criteria (required before next phase): full test gate passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

