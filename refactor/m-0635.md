---
id: m-0635
status: open
deps: [m-5156]
created: 2026-02-09T06:56:38Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-c494
tags: [refactor, guard-pre-hook, phase-1]
updated: 2026-02-09T06:57:41Z
---
# Refactor Program: Modularize interpreter/hooks/guard-pre-hook.ts - Phase 1: Extract guard override and with-clause resolution utilities


Objective:
Isolate override parsing/filtering logic from hook orchestration.

Instructions for the implementing agent:
- In scope: override and with-clause normalization/filtering utilities only.
- Out of scope: candidate collection, retry state, runtime evaluation, or helper injection extraction.
- Extract `extractGuardOverride`, `resolveWithClause`, `normalizeGuardNames`, `normalizeGuardOverride`, and `applyGuardOverrideFilter` into a focused utility module.
- Keep error messages and exception types identical for invalid override payloads.
- Keep privileged-guard inclusion behavior unchanged when guards are disabled or filtered.
- Add targeted unit tests for normalization edge cases and filter behavior.

Module boundaries:
- Override utility module handles parsing, normalization, and filtering only.
- Hook orchestrator remains owner of sequence control and state mutation.

Preserve behavior checks:
- `false`/`only`/`except` semantics remain unchanged.
- Invalid payload error types and messages remain unchanged.
- Privileged guard inclusion/exclusion behavior remains unchanged.

## Acceptance Criteria

1. Override parsing/filtering logic is moved behind a dedicated module API.
2. Existing override semantics and error messages remain unchanged.
3. Added tests cover valid/invalid override combinations and privileged-guard behavior.
4. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples
