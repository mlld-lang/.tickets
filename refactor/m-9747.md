---
id: m-9747
status: closed
deps: [m-845d]
created: 2026-02-09T07:06:39Z
type: epic
priority: 1
assignee: Adam Avenir
tags: [refactor, core-interpreter]
updated: 2026-02-10T12:50:30Z
---
# Refactor Program: Modularize interpreter/core/interpreter.ts



Largest unplanned target file: `interpreter/core/interpreter.ts` (~1,070 LOC).

This epic coordinates a phased refactor that decomposes core AST evaluation into focused modules while preserving node evaluation semantics, interpolation/security recording, variable-resolution behavior, and intent/effect emission ordering.

Execution order:
1. Phase 0 through Phase 7 proceed strictly in order.
2. Each phase closes only after its exit criteria are met.
3. No phase starts until its dependency ticket is closed.

Cross-phase constraints:
- Keep exported APIs stable: `evaluate`, `interpolate`, and `cleanNamespaceForDisplay`.
- Preserve evaluation behavior across document arrays, single-node dispatch, expression nodes, and directive delegation.
- Preserve interpolation security descriptor collection/recording behavior.
- Preserve variable-reference field/pipeline handling and expression-context behavior.
- Preserve intent/effect emission and document reconstruction semantics.

## Acceptance Criteria

1. Phase tickets (0-7) exist under this epic and are dependency-linked in sequence.
2. Each phase ticket includes explicit implementation instructions and explicit exit criteria.
3. Final structure splits responsibilities into cohesive modules under `interpreter/core/interpreter/` (or equivalent) and reduces `interpreter.ts` to orchestration/dispatch.
4. Final validation command passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-09 08:13 UTC:** Safety-hardening pass completed for phases m-ce57 -> m-f79f.

Tightening applied:
- Added explicit in-scope/out-of-scope boundaries to every phase.
- Added concrete module boundaries for traversal, dispatch, resolver, interpolation/security, and utility layers.
- Added explicit preserve-behavior checks for `evaluate`, `interpolate`, `cleanNamespaceForDisplay`, node dispatch semantics, interpolation security recording, field/pipeline resolution, and intent/effect ordering.
- Enforced explicit exit criteria in every phase with full gate command:
  npm run build && npm test && npm run test:tokens && npm run test:examples

Dependency verification:
- Verified linear chain with `tk dep tree --full m-f79f` in a temporary workspace mount that maps `.tickets/refactor` as `.tickets`.
- No dependency rewiring required.

Residual risk:
- Phase 4 includes many specialized node families; parity tests must remain split by node family to prevent silent drift.

**2026-02-09 08:25 UTC:** Micro-planning addendum (hotspot): added explicit node-family drift checklist to phase m-2e93.

Focus:
- Requires per-family positive/negative coverage and dispatch identity assertions.
- Adds explicit closure gate that every checklist scenario is backed by tests before phase close.

**2026-02-10 12:50 UTC:** Epic completion summary:
- Completed all phase tickets in required order:
  m-ce57 -> m-11c8 -> m-fd91 -> m-8659 -> m-2e93 -> m-1078 -> m-5bf5 -> m-f79f.
- Final composition state:
  - interpreter/core/interpreter.ts is orchestration-focused.
  - core node dispatch/evaluation logic lives in interpreter/core/interpreter/evaluator.ts.
  - interpolation/security, variable reference resolution, traversal, specialized handlers, namespace display, and value-resolution helpers are modularized under interpreter/core/interpreter/*.
- Contract verification:
  - Public entrypoints evaluate/interpolate/cleanNamespaceForDisplay remain stable.
  - Internal dependency check reports no cycles inside interpreter/core/interpreter/*.ts.
- Final epic gate:
  npm run build && npm test && npm run test:tokens && npm run test:examples => PASS.
