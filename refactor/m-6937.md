---
id: m-6937
status: closed
deps: [m-ff50]
created: 2026-02-09T07:04:25Z
type: epic
priority: 1
assignee: Adam Avenir
tags: [refactor, ast-extractor]
updated: 2026-02-11T19:47:16Z
---
# Refactor Program: Modularize interpreter/eval/ast-extractor.ts



Largest unplanned target file: `interpreter/eval/ast-extractor.ts` (~1,429 LOC).

This epic coordinates a phased refactor that decomposes AST extraction into focused modules while preserving pattern semantics, language extractor behavior, and output ordering guarantees.

Execution order:
1. Phase 0 through Phase 7 proceed strictly in order.
2. Each phase closes only after its exit criteria are met.
3. No phase starts until its dependency ticket is closed.

Cross-phase constraints:
- Keep exported APIs stable: `extractAst`, `extractNames`, and exported pattern helpers.
- Preserve matching semantics for wildcard/exact patterns, usage patterns, type filters, and null placeholders.
- Preserve extractor behavior and ordering for all supported languages.
- Preserve dedupe/containment pruning logic in result assembly.
- Keep performance characteristics acceptable for large source files.

## Wave 2 Architecture Contract

Target end state for `interpreter/eval/ast-extractor.ts`:
- Public exports stay stable: `extractAst`, `extractNames`, and exported pattern helpers.
- Pattern matching core and per-language extractors move into focused modules under `interpreter/eval/ast-extractor/` with a clear registry.
- Ordering, dedupe/containment pruning, and null-placeholder behavior stay behavior-compatible.
- Shared definition/result/pattern contracts are defined once and imported by language modules.

Wave 2 guardrails for every phase in this epic:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared definition parsing helpers across language extractors.
- Keep dispatch/registry ownership centralized to avoid fragmented mapping logic.
- Verify no circular dependencies inside `interpreter/eval/ast-extractor*` after each phase.

## Minimum Targeted Test Evidence

Every phase note includes targeted coverage from suites that exercise this area, using files such as:
- `interpreter/eval/content-loader.characterization.test.ts`
- `interpreter/eval/content-loader.structured.test.ts`
- `tests/pipeline-preservation/pipeline-preservation.test.ts`
- representative fixtures that use ast variants via `tests/cases/feat/alligator/*`

## Acceptance Criteria

1. Phase tickets (0-7) exist under this epic and are dependency-linked in sequence.
2. Each phase ticket includes explicit implementation instructions and explicit exit criteria.
3. Final structure splits responsibilities into cohesive modules under `interpreter/eval/ast-extractor/` (or equivalent) and reduces `ast-extractor.ts` to orchestration/registry glue.
4. Final validation command passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-11 19:47 UTC:** --dir refactor Epic architecture summary (ast-extractor modularization):
- Orchestrator: interpreter/eval/ast-extractor.ts (72 lines) owns public entrypoints (extractAst/extractNames), top-level filtering behavior, and registry composition only.
- Dispatch/mapping: interpreter/eval/ast-extractor/language-dispatch.ts (69 lines) owns extension mapping and extractor key resolution/dispatch.
- Pattern evaluation core: interpreter/eval/ast-extractor/pattern-core.ts (193 lines) owns wildcard/exact matching, usage matching, type-filter logic, duplicate suppression, containment pruning, and ordered null-placeholder result shaping.
- Shared utilities: interpreter/eval/ast-extractor/shared-utils.ts (98 lines) owns line/offset indexing, brace block end detection, and shared Definition slicing helpers.
- Language modules:
  - interpreter/eval/ast-extractor/typescript-extractor.ts (78 lines)
  - interpreter/eval/ast-extractor/python-extractor.ts (87 lines)
  - interpreter/eval/ast-extractor/ruby-extractor.ts (132 lines)
  - interpreter/eval/ast-extractor/rust-extractor.ts (85 lines)
  - interpreter/eval/ast-extractor/go-extractor.ts (79 lines)
  - interpreter/eval/ast-extractor/cpp-extractor.ts (214 lines)
  - interpreter/eval/ast-extractor/solidity-extractor.ts (118 lines)
  - interpreter/eval/ast-extractor/java-extractor.ts (92 lines)
  - interpreter/eval/ast-extractor/csharp-extractor.ts (188 lines)
  Each module owns concrete parsing/extraction logic for its language, including member detection and code/search slice shaping.
- Types contract: interpreter/eval/ast-extractor/types.ts (74 lines) defines shared pattern/result/definition types once for the extraction area.
- Verification tests added across phases: language-dispatch.test.ts, language-group-a/b/c/d.test.ts, registry-composition.test.ts, plus characterization/content-loader/alligator suites.

Guardrail confirmation:
- Callback/cycle-break seams: none introduced. No callback-lambda service composition.
- Runtime module count in extraction area: 13 runtime modules (orchestrator + dispatch/pattern/shared + 9 language modules).
- Runtime module line distribution: smallest runtime module is 69 lines; no new runtime module under 60 lines.
- Thin facade check: no extracted module is delegation-only; each runtime module contains concrete parsing, matching, dispatch, or slicing implementation logic.
- Dependency direction remains acyclic in the touched extraction area (orchestrator -> dispatch/pattern/language modules; language modules -> shared-utils/types).
