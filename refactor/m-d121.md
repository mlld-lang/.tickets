---
id: m-d121
status: closed
deps: [m-6a79]
created: 2026-02-09T06:58:07Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-c494
tags: [refactor, guard-pre-hook, phase-7]
updated: 2026-02-10T09:17:55Z
---
# Refactor Program: Modularize interpreter/hooks/guard-pre-hook.ts - Phase 7: Extract guard helper injection and helper executable factories


Objective:
Isolate helper-variable provisioning from guard orchestration.

Instructions for the implementing agent:
- In scope: helper factory and injection logic only.
- Out of scope: runtime decision logic, retry state handling, and block/action evaluation internals.
- Extract helper factory/injection logic (`injectGuardHelpers`, `createGuardHelperExecutable`, `ensurePrefixHelper`, `ensureTagHelper`, `attachGuardHelper`).
- Preserve helper names, parameter behavior, and existing fallback behavior when helpers already exist in parent env.
- Preserve debug guard logging around helper availability.
- Add tests for helper injection coverage, including guard input helper attachment semantics.

Module boundaries:
- Helper module owns helper executable creation and guard-env attachment behavior.
- Runtime evaluator consumes helper module via explicit API.
- Helper module does not own policy condition or decision transitions.

Preserve behavior checks:
- Helper names and call signatures remain unchanged.
- Helper precedence/fallback behavior with parent env helpers remains unchanged.
- Guard input helper attachment semantics remain unchanged.
- Debug logging signals around helper availability remain unchanged.

Micro-checklist (helper/runtime interoperability):
- Add tests where helpers are pre-defined in parent env and assert fallback precedence is unchanged.
- Add tests where helpers are absent and assert full helper set injection completeness.
- Add tests that use helper outputs inside replacement/env-producing guards to confirm interoperability with action modules.
- Assert debug logging markers for helper attach/skip behavior remain unchanged.

## Acceptance Criteria

1. Helper provisioning logic is extracted into dedicated helper modules.
2. Helper behavior and naming contracts are unchanged.
3. Tests verify helper resolution and injection behavior across guard env creation.
4. Every item in the micro-checklist is backed by explicit tests before closing this phase.
5. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 09:17 UTC:** Implemented helper-injection extraction by adding interpreter/hooks/guard-helper-injection.ts and moving injectGuardHelpers/createGuardHelperExecutable/ensurePrefixHelper/ensureTagHelper plus attachGuardHelper into the new module. Updated interpreter/hooks/guard-pre-hook.ts and interpreter/hooks/guard-runtime-evaluator.ts to consume the extracted APIs while preserving helper names, call signatures, parent-env fallback precedence, and debug helper-availability markers. Completed checklist coverage with tests/interpreter/hooks/guard-helper-injection.test.ts: parent helper fallback precedence, full helper injection when absent, helper output interoperability with replacement/env-producing guards, debug attach/skip markers, and guard-input helper attachment semantics. Tests run: npm test -- tests/interpreter/hooks/guard-helper-injection.test.ts tests/interpreter/hooks/guard-pre-hook.test.ts tests/interpreter/hooks/guard-runtime-evaluator.test.ts (pass); npm run build && npm test && npm run test:tokens && npm run test:examples (pass) [run 1 for checkpoint + run 2 for phase completion].
