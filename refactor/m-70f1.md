---
id: m-70f1
status: closed
deps: [m-719d]
created: 2026-02-09T07:00:10Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-68f8
tags: [refactor, guard-post-hook, phase-1]
updated: 2026-02-10T09:44:21Z
---
# Refactor Program: Modularize interpreter/hooks/guard-post-hook.ts - Phase 1: Extract override and guard selection utilities



Objective:
Separate override parsing and guard candidate discovery from orchestration.

Instructions for the implementing agent:
- In scope: override parsing/normalization/filtering and guard selection utility extraction.
- Out of scope: decision engine and retry enforcement extraction.
- Extract with-clause override parsing/normalization/filtering and operation-key derivation utilities.
- Extract per-input/per-operation guard collection helpers and ensure dedupe/order behavior remains unchanged.
- Add focused tests for override filtering and operation key derivation coverage.

Module boundaries:
- Override utility handles parsing and filter semantics only.
- Guard selection utility handles candidate ordering, dedupe, and operation-key derivation.
- Hook orchestrator remains owner of control flow.

Preserve behavior checks:
- Override semantics remain unchanged.
- Guard selection precedence remains unchanged.
- Candidate dedupe and order behavior remain unchanged.

## Acceptance Criteria

1. Override and selection logic are extracted into focused modules.
2. Selection precedence and override behavior remain baseline-compatible.
3. Tests cover precedence, dedupe, and operation key derivation.
4. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 09:44 UTC:** Completed phase-1 extraction for guard-post override and guard selection utilities.

What changed:
- Rewired `interpreter/hooks/guard-post-hook.ts` to consume extracted helpers:
  - `extractGuardOverride` / `normalizeGuardOverride` from `guard-override-utils`
  - `buildPerInputCandidates` / `collectOperationGuards` from `guard-candidate-selection`
  - `buildOperationKeys` from `guard-operation-keys`
- Removed duplicate inline implementations from `guard-post-hook.ts` for:
  - with-clause override parsing/normalization/filtering
  - operation key derivation
  - per-input/per-operation candidate collection
- Extended `interpreter/hooks/guard-candidate-selection.ts` to support:
  - explicit timing selection (`before`/`after`)
  - operation guard collection with optional variable-label fallback inputs
  - default behavior remains `before` for existing pre-hook callers.
- Expanded `tests/interpreter/hooks/guard-selection-and-keys.test.ts` with focused coverage for:
  - timing-aware per-input guard collection
  - after-timing operation key + variable-label collection and dedupe order.

Checklist coverage completed:
- override parsing/normalization/filtering extracted from post orchestrator ✅
- operation key derivation extracted from post orchestrator ✅
- per-input/per-operation candidate collection extracted with preserved ordering/dedupe ✅
- guard selection precedence for post path remains baseline-compatible (post-hook + utility suites) ✅

Tests run:
- `npx vitest run tests/interpreter/hooks/guard-post-hook.test.ts tests/interpreter/hooks/guard-selection-and-keys.test.ts tests/interpreter/hooks/guard-override-utils.test.ts tests/interpreter/hooks/guard-pre-hook.test.ts` ✅
- `npm run build && npm test && npm run test:tokens && npm run test:examples` ✅
