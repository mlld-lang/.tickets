---
id: m-c639
status: closed
deps: [m-2042]
created: 2026-02-09T06:36:42Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-15ea
tags: [refactor, pipeline-executor, phase-6]
updated: 2026-02-11T06:08:19Z
---
# Refactor Program: Modularize interpreter/eval/pipeline/executor.ts - Phase 6: Extract parallel-stage orchestration

Objective:
Isolate parallel-stage execution and aggregation into a dedicated orchestrator.

Instructions for the implementing agent:
- Extract `executeParallelStage` and parallel-error context handling into a focused module.
- Preserve ordered branch outputs, concurrency cap/rate pacing, and aggregated output shape.
- Preserve current behavior for retry signals in parallel branches (unsupported path handling) and error-marker generation.
- Add tests for branch ordering, error aggregation, and label/descriptor merge behavior across branches.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Parallel-stage orchestration and error aggregation live in dedicated module(s).
2. Parallel semantics and output contracts match baseline behavior.
3. Exit criteria: all tests pass with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-11 06:08 UTC:** --dir refactor Extracted parallel-stage orchestration into a dedicated runner and rewired PipelineExecutor to delegate executeParallelStage.

Completed phase checklist items:
- Moved executeParallelStage flow into PipelineParallelStageRunner, including branch env setup, branch operation-context boundaries, ordered concurrency execution, retry-signal rejection path, and aggregated output assembly.
- Moved parallel error-context handling into the runner path, preserving context reset/update behavior and error-marker generation semantics.
- Preserved ordered branch outputs, concurrency cap/rate pacing ( + ), and aggregated payload shape/metadata.
- Preserved descriptor propagation/merge behavior by aggregating branch label descriptors via mergeDescriptors before finalization.
- Added focused tests for branch ordering, error aggregation, retry rejection in parallel branches, and label-descriptor merge behavior.

Touched runtime modules (line counts + ownership):
- interpreter/eval/pipeline/executor.ts (684 LOC): orchestrator wiring and delegation boundaries; executeParallelStage now delegates.
- interpreter/eval/pipeline/executor/parallel-stage-runner.ts (332 LOC): owns parallel branch orchestration, parallel error-marker/context handling, and aggregated output/descriptor assembly.

Test module added:
- interpreter/eval/pipeline/executor/parallel-stage-runner.test.ts (239 LOC): characterizes ordered branch outputs, aggregated branch errors, retry rejection, and descriptor merge behavior.

Sub-checkpoint verification (build + targeted tests):
- npm run build && npx vitest run interpreter/eval/pipeline/executor/parallel-stage-runner.test.ts interpreter/eval/pipeline/executor.characterization.test.ts tests/pipeline/parallel-runtime.test.ts interpreter/eval/pipeline/executor/single-stage-runner.test.ts
- Status: PASS

Phase close gate:
- npm run build && npm test && npm run test:tokens && npm run test:examples
- Status: PASS

Guardrail confirmations:
- No new sub-60 runtime module introduced (new runtime module is 332 LOC).
- No callback-lambda service injection introduced; composition uses interface-typed service object wiring.
- No duplicated shared logic introduced across sibling extraction modules in this phase.
- Touched module dependency direction remains acyclic in the executor extraction area.

**2026-02-11 06:08 UTC:** --dir refactor Correction: preserved concurrency pacing settings via parallelCap and delayMs inputs in PipelineParallelStageRunner; prior note line dropped those identifiers due shell interpolation during note submission.
