---
id: m-4a76
status: open
deps: [m-4313]
created: 2026-02-09T06:44:05Z
type: task
priority: 1
assignee: Adam Avenir
updated: 2026-02-09T06:44:11Z
---
# Refactor Program: Modularize interpreter/eval/run.ts - Phase 7: Extract pipeline, streaming, and output finalization

Objective:
Isolate post-execution lifecycle logic that applies pipelines, finalizes streaming, and emits final output/effects.

Instructions for the implementing agent:
- Extract withClause post-processing into dedicated modules:
  - pipeline application and stage-0 retry eligibility
  - descriptor hint derivation and merge behavior
  - streaming finalization and stream-format adapter output override
  - display-text normalization, node insertion, and effect emission gating
- Preserve behavior for embedded/data-value/RHS contexts.
- Preserve output newline normalization and hasActualOutput checks.
- Add focused tests for pipeline + streaming + effect emission interactions.

## Acceptance Criteria

1. Pipeline/streaming/output-finalization logic is extracted and called from evaluateRun orchestration.
2. Existing behavior for stage-0 retry, stream-format output substitution, and effect emission gating remains consistent.
3. Focused lifecycle tests pass.
4. Exit criteria (required before next phase): full test gate passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

