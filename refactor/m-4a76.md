---
id: m-4a76
status: closed
deps: [m-4313]
created: 2026-02-09T06:44:05Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-bd66
tags: [refactor, run, phase-7]
updated: 2026-02-11T07:36:46Z
---
# Refactor Program: Modularize interpreter/eval/run.ts - Phase 7: Extract pipeline, streaming, and output finalization

Objective:
Isolate post-execution lifecycle logic that applies pipelines, finalizes streaming, and emits final output/effects.

Instructions for the implementing agent:
- Extract withClause post-processing into dedicated modules:
  - pipeline application and stage-0 retry eligibility
  - descriptor hint derivation and merge behavior
  - streaming finalization and stream-format adapter output override
  - display-text normalization, node insertion, and effect emission gating
- Preserve behavior for embedded/data-value/RHS contexts.
- Preserve output newline normalization and hasActualOutput checks.
- Add focused tests for pipeline + streaming + effect emission interactions.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Pipeline/streaming/output-finalization logic is extracted and called from evaluateRun orchestration.
2. Existing behavior for stage-0 retry, stream-format output substitution, and effect emission gating remains consistent.
3. Focused lifecycle tests pass.
4. Exit criteria (required before next phase): full test gate passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-11 07:36 UTC:** --dir refactor Phase 7 implementation complete.

Runtime modules touched:
- interpreter/eval/run-modules/run-output-lifecycle.ts (161 LOC): owns post-execution lifecycle orchestration for withClause pipeline application (stage-0 retry + descriptor hints), streaming finalization with adapter text override, and output node/effect emission gating.
- interpreter/eval/run.ts (400 LOC): evaluateRun now delegates post-execution lifecycle to run-output-lifecycle module.

Tests added/updated:
- interpreter/eval/run-modules/run-output-lifecycle.test.ts (197 LOC): focused lifecycle coverage for pipeline retryability/hints, stream-format finalization override, output normalization, and effect emission gating in embedded/data/RHS/streaming contexts.

Sub-checkpoint evidence:
- npm run build && npx vitest run interpreter/eval/run-modules/run-output-lifecycle.test.ts interpreter/eval/run.characterization.test.ts interpreter/eval/run.structured.test.ts
- Result: PASS (Test Files 3 passed; Tests 36 passed, 1 skipped).

Phase full-gate evidence:
- npm run build && npm test && npm run test:tokens && npm run test:examples
- Result: PASS
  - npm test: Test Files 340 passed, 7 skipped; Tests 3816 passed, 63 skipped.
  - npm run test:tokens: Test Files 6 passed; Tests 331 passed, 6 skipped.
  - npm run test:examples: Test Files 1 passed; Tests 1353 passed, 2 skipped.

Guardrail checks:
- No new runtime module under 60 lines (new runtime lifecycle module is 161 LOC).
- No callback-lambda service injection introduced.
- Shared post-execution lifecycle logic is centralized in one runtime module with no sibling duplication.
- Dependency direction in the touched run module area remains acyclic.
