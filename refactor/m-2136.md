---
id: m-2136
status: closed
deps: [m-735c]
created: 2026-02-09T07:00:10Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-68f8
tags: [refactor, guard-post-hook, phase-3]
updated: 2026-02-10T09:54:58Z
---
# Refactor Program: Modularize interpreter/hooks/guard-post-hook.ts - Phase 3: Extract post-guard decision engine



Objective:
Modularize decision accumulation across per-input and per-operation loops.

Instructions for the implementing agent:
- In scope: post-guard decision accumulation loop extraction only.
- Out of scope: override/selection parsing and retry signal builder extraction.
- Extract loop orchestration that evaluates guards and accumulates deny/retry reasons, hints, and trace data.
- Preserve current precedence rules for decision transitions and transform application ordering.
- Add tests for mixed guard traces and decision precedence under multiple guard matches.

Module boundaries:
- Decision engine module owns per-input/per-operation loop execution and aggregate decision state.
- Runtime guard evaluator remains invoked through a stable interface.
- Descriptor/output modules remain separate dependencies.

Preserve behavior checks:
- Decision transition precedence remains unchanged.
- Transform application ordering remains unchanged.
- Mixed guard trace aggregation (reasons/hints/metadata) remains unchanged.

Micro-checklist (multi-guard trace matrix):
- Add a multi-guard trace matrix with at least: deny-after-allow, retry-after-allow, and transform-after-allow cases.
- Add explicit precedence assertions for deny vs retry outcomes when multiple guards match.
- Add assertions that reason/hint aggregation ordering is unchanged across per-input and per-operation loops.
- Add a case where transformed output participates in later guard decisions and assert unchanged ordering.

## Acceptance Criteria

1. Decision accumulation loop logic is extracted into a dedicated engine module.
2. Precedence and transform ordering remain baseline-compatible.
3. Tests cover mixed-trace precedence outcomes.
4. Every item in the micro-checklist is backed by explicit tests before closing this phase.
5. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 09:54 UTC:** Completed phase-3 extraction of post-guard decision accumulation into a dedicated engine module.

What changed:
- Added `interpreter/hooks/guard-post-decision-engine.ts` to own:
  - per-input loop execution
  - per-operation loop execution
  - decision transitions (`allow`/`deny`/`retry`)
  - reasons/hints/trace aggregation
  - transform application ordering and descriptor updates through injected collaborators
- Updated `interpreter/hooks/guard-post-hook.ts` to delegate accumulation loops to `runPostGuardDecisionEngine(...)` and consume returned decision state.
- Kept retry enforcement/signal construction in `guard-post-hook.ts` (out of scope for this phase).
- Added focused mixed-trace tests in `tests/interpreter/hooks/guard-post-decision-engine.test.ts`.

Micro-checklist coverage completed:
- deny-after-allow matrix case ✅
- retry-after-allow matrix case ✅
- transform-after-allow case ✅
- explicit deny vs retry precedence assertion under multi-match ✅
- reason/hint aggregation ordering across per-input + per-operation loops ✅
- transformed output participation in later decisions with ordering assertions ✅

Tests run:
- `npx vitest run tests/interpreter/hooks/guard-post-decision-engine.test.ts tests/interpreter/hooks/guard-post-hook.test.ts tests/interpreter/hooks/guard-post-descriptor.test.ts tests/interpreter/hooks/guard-post-output-normalization.test.ts tests/interpreter/hooks/guard-pre-hook.test.ts` ✅
- `npm run build && npm test && npm run test:tokens && npm run test:examples` ✅
