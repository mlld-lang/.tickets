---
id: m-8006
status: closed
deps: [m-cb49]
links: []
created: 2026-02-09T06:19:05Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-ef4e
tags: [refactor, environment, phase-5, shadow-env, execution]
updated: 2026-02-10T21:20:24Z
---
# Refactor Program: Modularize interpreter/env/Environment.ts - Phase 5: Extract shadow environment and execution orchestration

Objective:
Move shadow-environment and command/code execution orchestration into dedicated collaborators.

Instructions for the implementing agent:
- Extract shadow environment management (`setShadowEnv`, `getShadowEnv`, node/python getters/creation, capture methods) into a focused module.
- Extract command/code execution wrapper logic (`getCommandExecutorFactory`, `executeCommand`, `executeCode`) into an execution orchestrator component.
- Preserve language-specific behavior, especially js/node ambient `mx` injection and node/python shadow lifecycle behavior.
- Preserve compatibility with existing executors and their dependency contracts.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Shadow-environment and execution wrapper logic are isolated behind clear APIs.
2. Language-specific execution behavior remains unchanged.
3. Existing shadow env and executor-focused tests remain green.
4. Exit criteria: full test gate passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-10 21:20 UTC:** Phase 5 complete: extracted shadow environment lifecycle and command/code execution orchestration from Environment runtime.

Checklist coverage:
- Extracted shadow environment management APIs (`setShadowEnv`, `getShadowEnv`, node/python getters/creators, capture helpers, cleanup) into ShadowEnvironmentRuntime.
- Extracted command/code execution wrapper behavior (`executeCommand`, `executeCode`, factory lifecycle, overload normalization, JS/Node ambient mx injection) into ExecutionOrchestrator.
- Preserved compatibility with existing executors and variable provider contracts via CommandExecutorFactory dependencies.
- Preserved language-specific behavior for JS/Node mx injection, stream-bus propagation, and node/python shadow lifecycle semantics.

Touched runtime modules (line counts + ownership):
- interpreter/env/runtime/ShadowEnvironmentRuntime.ts (195): owns local/parent shadow env lookup, node/python lifecycle, lexical capture maps, and shadow cleanup.
- interpreter/env/runtime/ExecutionOrchestrator.ts (193): owns command/code execution wrapper orchestration, options/context merge behavior, overload normalization, and ambient mx injection.

Additional tests added/updated:
- interpreter/env/runtime/ShadowEnvironmentRuntime.test.ts
- interpreter/env/runtime/ExecutionOrchestrator.test.ts
- Updated interpreter/env/Environment.characterization.test.ts wrapper/cleanup expectations for extracted seams.

Validation executed:
- Sub-checkpoint build: `npm run build` ✅
- Sub-checkpoint targeted behavior: `npm test -- --run interpreter/env/runtime/ShadowEnvironmentRuntime.test.ts interpreter/env/runtime/ExecutionOrchestrator.test.ts interpreter/env/Environment.characterization.test.ts interpreter/env/variable-passing-integration.test.ts interpreter/env/NodeShadowEnvironment.test.ts interpreter/env/executors/streaming.integration.test.ts interpreter/stream-execution.test.ts interpreter/debug-dynamic-import.test.ts interpreter/eval/exec-invocation.structured.test.ts` ✅
- Phase full gate: `npm run build && npm test && npm run test:tokens && npm run test:examples` ✅

Wave 2 quality guardrails:
- No new sub-60 runtime modules introduced in touched extraction area.
- No duplicated pre/post runtime logic introduced across extracted siblings.
- No callback-lambda service-composition injection introduced in new modules; runtime collaborators use interface-typed service objects.
- Shared execution contracts are centralized in ExecutionOrchestrator types and reused by Environment.

Dependency direction in touched area remains acyclic.
