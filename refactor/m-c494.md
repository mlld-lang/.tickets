---
id: m-c494
status: closed
deps: []
created: 2026-02-09T06:56:37Z
type: epic
priority: 1
assignee: Adam Avenir
tags: [refactor, guard-pre-hook]
updated: 2026-02-10T09:34:20Z
---
# Refactor Program: Modularize interpreter/hooks/guard-pre-hook.ts


Largest unplanned target file: `interpreter/hooks/guard-pre-hook.ts` (~1,779 LOC).

This epic coordinates a phased refactor that decomposes pre-guard orchestration into focused modules while preserving guard selection semantics, retry attempt tracking, security descriptor behavior, and guard helper/runtime behavior.

Execution order:
1. Phase 0 through Phase 8 proceed strictly in order.
2. Each phase closes only after its exit criteria are met.
3. No phase starts until its dependency ticket is closed.

Cross-phase constraints:
- Keep `guardPreHook` behavior and hook contract stable (`PreHook` input/output and metadata shape).
- Preserve guard override semantics (`false`, `only`, `except`) and bypass security checks.
- Preserve retry-attempt state isolation, guard context snapshots, and redaction behavior for secret-labeled inputs.
- Preserve helper availability and behavior (`opIs`, `opHas*`, `inputHas`, `prefixWith`, `tagValue`).
- Preserve policy-condition, `env` action, replacement/materialization, and metadata emission semantics.

## Acceptance Criteria

1. Phase tickets (0-8) exist under this epic and are dependency-linked in sequence.
2. Each phase ticket includes explicit implementation instructions and explicit exit criteria.
3. Final structure splits major responsibilities into cohesive modules under `interpreter/hooks/guard-pre/` (or equivalent focused subdirectory) and reduces `guard-pre-hook.ts` to orchestration.
4. Final validation command passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-09 08:14 UTC:** Safety-hardening pass completed for phases m-5156 -> m-6588.

Tightening applied:
- Added explicit in-scope/out-of-scope boundaries across all phases.
- Added explicit module-boundary requirements for override parsing, candidate/key selection, retry-state accumulation, materialization/redaction, runtime evaluation, action evaluation, and helper injection.
- Added preserve-behavior checks in each phase for override semantics (`false`/`only`/`except`), retry-attempt isolation, secret redaction, helper injection contracts, and env/policy/replacement behavior.
- Standardized exit criteria in each phase to require:
  npm run build && npm test && npm run test:tokens && npm run test:examples

Dependency verification:
- Verified linear chain with `tk dep tree --full m-6588` in a temporary workspace mount that maps `.tickets/refactor` as `.tickets`.
- No dependency rewiring required.

Residual risk:
- Runtime extraction across phases 5-7 has tight coupling between block evaluation and helper injection; final phase parity checks must include mixed retry+replacement+env cases.

**2026-02-09 08:25 UTC:** Micro-planning addendum (hotspot): added coupling checklists to phases m-6a4f, m-6a79, m-d121, and m-6588.

Focus:
- Covers mixed retry+replacement+env cases and helper/runtime interoperability.
- Adds explicit closure gates requiring checklist-backed tests before each phase closes.

**2026-02-10 09:34 UTC:** Epic completion summary: all phase tickets m-5156 -> m-0635 -> m-1b94 -> m-83af -> m-b451 -> m-6a4f -> m-6a79 -> m-d121 -> m-6588 are closed in order. Final phase m-6588 reduced guard-pre-hook.ts to orchestration and extracted residual responsibilities into guard-pre-runtime.ts, guard-pre-aggregation.ts, and guard-pre-logging.ts; added dependency-boundary tests (guard-pre-boundaries.test.ts), cross-module integration matrix tests (guard-pre-hook-integration-matrix.test.ts), and architecture ownership notes in docs/dev/HOOKS.md. Final parity and gate evidence for epic completion: npm run build && npm test && npm run test:tokens && npm run test:examples passed (plus repeated checkpoint gates in m-6588).
