---
id: m-6588
status: open
deps: [m-d121]
created: 2026-02-09T06:58:07Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-c494
tags: [refactor, guard-pre-hook, phase-8]
updated: 2026-02-09T06:58:21Z
---
# Refactor Program: Modularize interpreter/hooks/guard-pre-hook.ts - Phase 8: Final composition cleanup and module boundary verification


Objective:
Finalize modular composition and remove residual coupling from `guard-pre-hook.ts`.

Instructions for the implementing agent:
- In scope: orchestration cleanup, dependency direction checks, and final parity verification.
- Out of scope: new guard features or semantic changes.
- Reduce `guard-pre-hook.ts` to composition/orchestration glue that delegates to extracted modules.
- Remove dead code and duplicate helpers introduced during phased extraction.
- Verify imports/dependency directions are coherent (no cyclic dependencies between new guard-pre modules).
- Attach a short architecture note summarizing new module boundaries and ownership.
- Run final parity checks against Phase 0 baselines for override semantics, retry isolation, redaction, helper injection, and env/policy/replacement outcomes.

Module boundaries:
- `guard-pre-hook.ts` acts as orchestration entrypoint only.
- Extracted modules have acyclic dependencies and explicit ownership for override, selection, retry-state, materialization, runtime, actions, and helpers.
- Hook input/output and metadata contracts remain stable.

Preserve behavior checks:
- Override semantics (`false`, `only`, `except`) remain unchanged.
- Retry-attempt isolation remains unchanged.
- Secret redaction behavior remains unchanged.
- Helper injection contracts remain unchanged.
- Env/policy/replacement behavior remains unchanged.

Micro-checklist (cross-module integration gate):
- Add an end-to-end matrix that combines retry + replacement + env decisions across at least two attempts.
- Add a mixed case where override filtering changes the evaluated guard set and assert unchanged final decision.
- Add a redaction + helper-use case and assert both redaction output and helper behavior remain baseline-compatible.
- Add one non-happy-path integration test that traverses runtime evaluator, action helpers, and helper injection together.

## Acceptance Criteria

1. `guard-pre-hook.ts` primarily orchestrates extracted collaborators.
2. No duplicate or unreachable logic remains after extraction.
3. Architecture notes are attached and dependency boundaries are clear.
4. Every item in the micro-checklist is backed by explicit tests before closing this phase.
5. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples
