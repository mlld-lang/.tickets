---
id: m-21f6
status: open
deps: []
created: 2026-02-09T07:00:43Z
type: epic
priority: 1
assignee: Adam Avenir
tags: [refactor, when-evaluator]
updated: 2026-02-09T07:00:43Z
---
# Refactor Program: Modularize interpreter/eval/when.ts



Largest unplanned target file: `interpreter/eval/when.ts` (~1,524 LOC).

This epic coordinates a phased refactor that decomposes when-evaluation logic into focused modules while preserving condition semantics, assignment behavior, control-flow propagation, and error diagnostics.

Execution order:
1. Phase 0 through Phase 7 proceed strictly in order.
2. Each phase closes only after its exit criteria are met.
3. No phase starts until its dependency ticket is closed.

Cross-phase constraints:
- Keep exported APIs stable: `evaluateWhen`, `evaluateCondition`, `evaluateLetAssignment`, and `evaluateAugmentedAssignment`.
- Preserve comparison and truthiness semantics, including denied-context handling and none-placement validation.
- Preserve block scoping, variable ownership checks, and parallel-isolation mutation constraints.
- Preserve return/control propagation behavior (including exe-return control paths).
- Preserve current error messages/locations for user-facing condition failures.

## Acceptance Criteria

1. Phase tickets (0-7) exist under this epic and are dependency-linked in sequence.
2. Each phase ticket includes explicit implementation instructions and explicit exit criteria.
3. Final structure splits responsibilities into cohesive modules under `interpreter/eval/when/` (or equivalent) and reduces `when.ts` to orchestration.
4. Final validation command passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples
