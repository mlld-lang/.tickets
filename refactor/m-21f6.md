---
id: m-21f6
status: closed
deps: [m-bd66]
created: 2026-02-09T07:00:43Z
type: epic
priority: 1
assignee: Adam Avenir
tags: [refactor, when-evaluator]
updated: 2026-02-11T16:28:12Z
---
# Refactor Program: Modularize interpreter/eval/when.ts



Largest unplanned target file: `interpreter/eval/when.ts` (~1,524 LOC).

This epic coordinates a phased refactor that decomposes when-evaluation logic into focused modules while preserving condition semantics, assignment behavior, control-flow propagation, and error diagnostics.

Execution order:
1. Phase 0 through Phase 7 proceed strictly in order.
2. Each phase closes only after its exit criteria are met.
3. No phase starts until its dependency ticket is closed.

Cross-phase constraints:
- Keep exported APIs stable: `evaluateWhen`, `evaluateCondition`, `evaluateLetAssignment`, and `evaluateAugmentedAssignment`.
- Preserve comparison and truthiness semantics, including denied-context handling and none-placement validation.
- Preserve block scoping, variable ownership checks, and parallel-isolation mutation constraints.
- Preserve return/control propagation behavior (including exe-return control paths).
- Preserve current error messages/locations for user-facing condition failures.

## Wave 2 Architecture Contract

Target end state for `interpreter/eval/when.ts`:
- Public exports stay stable: `evaluateWhen`, `evaluateCondition`, `evaluateLetAssignment`, and `evaluateAugmentedAssignment`.
- Assignment support, action-sequence execution, form handlers, matching engines, and condition utilities are extracted to cohesive modules under `interpreter/eval/when/`.
- Truthiness/comparison semantics and denied-target checks remain behavior-compatible.
- Shared condition/result/helper types are defined once and reused by condition and form modules.

Wave 2 guardrails for every phase in this epic:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate truthiness/comparison helpers across form and condition modules.
- Do not use callback-lambda constructor bundles for when module composition.
- Verify no circular dependencies inside `interpreter/eval/when*` after each phase.

## Minimum Targeted Test Evidence

Every phase note includes targeted coverage from suites that exercise this area, using files such as:
- `interpreter/eval/when.test.ts`
- `interpreter/eval/for-expression-when.test.ts`
- representative token fixtures under `tests/tokens/when-blocks/*`
- representative token fixtures under `tests/tokens/when-expressions/*`

## Acceptance Criteria

1. Phase tickets (0-7) exist under this epic and are dependency-linked in sequence.
2. Each phase ticket includes explicit implementation instructions and explicit exit criteria.
3. Final structure splits responsibilities into cohesive modules under `interpreter/eval/when/` (or equivalent) and reduces `when.ts` to orchestration.
4. Final validation command passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-11 16:28 UTC:** Epic completion architecture note (`interpreter/eval/when.ts` modularization):

Final module map and responsibilities:
- `interpreter/eval/when.ts` (79 lines): top-level orchestration and subtype dispatch (`evaluateWhen`) plus condition-runtime composition (`evaluateCondition`) and export surface.
- `interpreter/eval/when/assignment-support.ts` (267 lines): let/augmented assignment evaluation, scope/ownership checks, and assignment-specific runtime behavior.
- `interpreter/eval/when/action-runner.ts` (94 lines): ordered action execution and result/control propagation for when actions.
- `interpreter/eval/when/form-handlers.ts` (248 lines): simple/match/block form orchestration, env merge semantics, block-action behavior, and none-operator validation.
- `interpreter/eval/when/match-engines.ts` (290 lines): matching strategies (first/any/all), none/wildcard placement validation, and matcher-level branch selection.
- `interpreter/eval/when/condition-evaluator.ts` (257 lines): condition pipeline runtime (wrapper/unary/expression/exec/generic paths), condition error wrapping, and exec-result truthiness handling.
- `interpreter/eval/when/condition-utils.ts` (229 lines): pure truthiness/comparison/denied-target utility semantics shared by condition and form runtime wiring.

Call flow summary:
1) `evaluateWhen` selects simple/match/block handler.
2) Form handlers call matcher runtime and action runner.
3) Match engines call condition evaluator and comparison utilities.
4) Condition evaluator delegates value semantics to condition utilities and resolves expression/exec paths.

Service composition and seams:
- No callback-lambda constructor bundles are introduced.
- Composition uses interface-typed runtime service objects.
- No recursion-only callback seam is required in this area.

Guardrail confirmations:
- No extracted runtime module is under 60 lines.
- No extracted module is a thin forwarder/facade; each contains non-trivial implementation logic.
- Shared utilities are defined once in `condition-utils.ts` and reused.
- Dependency direction remains acyclic across `interpreter/eval/when*` modules.

Epic validation evidence:
- Full gate passed at epic completion:
  `npm run build && npm test && npm run test:tokens && npm run test:examples` âœ…
