---
id: m-6a79
status: open
deps: [m-6a4f]
created: 2026-02-09T06:58:07Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-c494
tags: [refactor, guard-pre-hook, phase-6]
updated: 2026-02-09T06:58:21Z
---
# Refactor Program: Modularize interpreter/hooks/guard-pre-hook.ts - Phase 6: Extract guard block and replacement evaluators


Objective:
Modularize guard-block execution and replacement/env value resolution.

Instructions for the implementing agent:
- In scope: guard block execution helpers and action value/replacement/env resolution helpers.
- Out of scope: top-level runtime evaluator orchestration and helper injection factories.
- Extract `evaluateGuardBlock` into a dedicated block evaluator module with explicit handling for let/augmented assignments and conditional matching.
- Extract `evaluateGuardReplacement`, `resolveGuardEnvConfig`, and decision-metadata builders into action modules.
- Preserve interpreter call boundaries (`evaluate`, `VariableImporter`, `evaluateCondition`) and thrown error types/locations.
- Add tests for replacement transforms, label modification-only paths, and env config extraction.

Module boundaries:
- Block evaluator module owns block AST traversal and assignment semantics.
- Action module owns replacement/env config and decision metadata builders.
- Runtime evaluator composes these modules through stable interfaces.

Preserve behavior checks:
- Let/augmented assignment behavior remains unchanged.
- Replacement transforms and label-modification-only paths remain unchanged.
- Env config extraction semantics remain unchanged.
- Error types/locations for block/action failures remain unchanged.

Micro-checklist (replacement/env coupling cases):
- Add mixed-case tests where a guard block yields replacement + env config in the same evaluation path.
- Add let and augmented-assignment cases that each trigger replacement evaluation and assert identical downstream values.
- Add a label-modification-only case and assert no unintended replacement payload is emitted.
- Add one failure case per action helper and assert error type/location parity.

## Acceptance Criteria

1. Guard block and action evaluation responsibilities are isolated into dedicated modules.
2. Error locations/messages and runtime behavior match baseline.
3. Tests cover let/augmented rules, replacement behavior, and env action config extraction.
4. Every item in the micro-checklist is backed by explicit tests before closing this phase.
5. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples
