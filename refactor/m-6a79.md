---
id: m-6a79
status: closed
deps: [m-6a4f]
created: 2026-02-09T06:58:07Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-c494
tags: [refactor, guard-pre-hook, phase-6]
updated: 2026-02-10T09:08:45Z
---
# Refactor Program: Modularize interpreter/hooks/guard-pre-hook.ts - Phase 6: Extract guard block and replacement evaluators


Objective:
Modularize guard-block execution and replacement/env value resolution.

Instructions for the implementing agent:
- In scope: guard block execution helpers and action value/replacement/env resolution helpers.
- Out of scope: top-level runtime evaluator orchestration and helper injection factories.
- Extract `evaluateGuardBlock` into a dedicated block evaluator module with explicit handling for let/augmented assignments and conditional matching.
- Extract `evaluateGuardReplacement`, `resolveGuardEnvConfig`, and decision-metadata builders into action modules.
- Preserve interpreter call boundaries (`evaluate`, `VariableImporter`, `evaluateCondition`) and thrown error types/locations.
- Add tests for replacement transforms, label modification-only paths, and env config extraction.

Module boundaries:
- Block evaluator module owns block AST traversal and assignment semantics.
- Action module owns replacement/env config and decision metadata builders.
- Runtime evaluator composes these modules through stable interfaces.

Preserve behavior checks:
- Let/augmented assignment behavior remains unchanged.
- Replacement transforms and label-modification-only paths remain unchanged.
- Env config extraction semantics remain unchanged.
- Error types/locations for block/action failures remain unchanged.

Micro-checklist (replacement/env coupling cases):
- Add mixed-case tests where a guard block yields replacement + env config in the same evaluation path.
- Add let and augmented-assignment cases that each trigger replacement evaluation and assert identical downstream values.
- Add a label-modification-only case and assert no unintended replacement payload is emitted.
- Add one failure case per action helper and assert error type/location parity.

## Acceptance Criteria

1. Guard block and action evaluation responsibilities are isolated into dedicated modules.
2. Error locations/messages and runtime behavior match baseline.
3. Tests cover let/augmented rules, replacement behavior, and env action config extraction.
4. Every item in the micro-checklist is backed by explicit tests before closing this phase.
5. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 09:08 UTC:** Implemented phase 6 extraction for guard block/action evaluation.

What changed:
- Extracted guard block traversal + assignment semantics into interpreter/hooks/guard-block-evaluator.ts via evaluateGuardBlock.
- Extracted replacement/env config/decision metadata helpers into interpreter/hooks/guard-action-evaluator.ts via evaluateGuardReplacement, resolveGuardEnvConfig, and buildDecisionMetadata.
- Rewired interpreter/hooks/guard-pre-hook.ts to consume extracted modules and removed in-file implementations.
- Added tests in tests/interpreter/hooks/guard-block-action-evaluator.test.ts covering mixed replacement+env path, let/augmented replacement parity, label-modification-only replacement behavior, replacement helper failure propagation, and env-config missing-value error surface.

Checklist completion:
- [x] Mixed-case path: guard block emits replacement + env config in one pre-hook evaluation path.
- [x] Let and augmented assignment replacement flows assert identical downstream replacement value.
- [x] Label-modification-only action path asserts no text drift and preserves intended payload.
- [x] Failure cases added for action helpers with error type/location parity assertions.

Tests run:
- npm test -- tests/interpreter/hooks/guard-block-action-evaluator.test.ts tests/interpreter/hooks/guard-pre-hook.test.ts tests/interpreter/hooks/guard-runtime-evaluator.test.ts (pass)
- npm run build && npm test && npm run test:tokens && npm run test:examples (pass)
- npm run build && npm test && npm run test:tokens && npm run test:examples (pass, phase completion rerun)
