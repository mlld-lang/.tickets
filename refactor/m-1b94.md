---
id: m-1b94
status: closed
deps: [m-0635]
created: 2026-02-09T06:58:06Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-c494
tags: [refactor, guard-pre-hook, phase-2]
updated: 2026-02-10T08:32:10Z
---
# Refactor Program: Modularize interpreter/hooks/guard-pre-hook.ts - Phase 2: Extract guard candidate collection and operation key services


Objective:
Separate guard-discovery logic from decision orchestration.

Instructions for the implementing agent:
- In scope: guard candidate collection and operation key derivation helpers only.
- Out of scope: retry-state accumulation, context materialization, runtime guard execution.
- Extract `buildPerInputCandidates`, `collectOperationGuards`, `buildOperationKeys`, `buildOperationKeySet`, and `buildOperationSnapshot` into dedicated selection/key modules.
- Preserve guard ordering and de-dup behavior for both data labels and operation keys.
- Preserve operation key expansion for run subtypes (`cmd`, `exec`, language-specific keys).
- Add tests for candidate ordering, dedupe, and operation-key derivation.

Module boundaries:
- Selection module owns candidate ordering and dedupe.
- Operation-key module owns key expansion and snapshot assembly.
- Orchestrator owns when/where these modules are invoked.

Preserve behavior checks:
- Guard candidate ordering remains unchanged.
- Dedup behavior remains unchanged.
- Run subtype key expansion remains unchanged (`cmd`, `exec`, language-specific keys).
- Per-input vs per-operation guard selection parity remains unchanged.

## Acceptance Criteria

1. Candidate collection and operation-key logic resides in dedicated modules.
2. Ordering and dedupe semantics are unchanged for per-input and per-operation guard sets.
3. Tests cover run subtype key derivation and label-driven selection.
4. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 08:32 UTC:** Phase 2 implementation complete.

What changed:
- Extracted per-input and per-operation guard discovery into `interpreter/hooks/guard-candidate-selection.ts`.
- Extracted operation-key derivation and snapshot assembly into `interpreter/hooks/guard-operation-keys.ts`.
- Updated `interpreter/hooks/guard-pre-hook.ts` to consume the new selection/key module APIs while keeping orchestration and runtime guard flow local.
- Added targeted coverage in `tests/interpreter/hooks/guard-selection-and-keys.test.ts` for:
  - per-input ordering + de-duplication,
  - operation-key ordering + de-duplication,
  - run subtype key expansion (`cmd`, `exec`, language),
  - privileged-guard inclusion under override filtering,
  - operation snapshot assembly.

Checklist/acceptance coverage:
- [x] Candidate collection and operation-key logic moved into dedicated modules.
- [x] Ordering and de-duplication semantics preserved for per-input and per-operation guards.
- [x] Run subtype key expansion behavior preserved.
- [x] Targeted tests added for label-driven selection and key derivation.

Tests run:
- npx vitest run tests/interpreter/hooks/guard-selection-and-keys.test.ts tests/interpreter/hooks/guard-pre-hook.test.ts -> PASS
- npm run build && npm test && npm run test:tokens && npm run test:examples -> PASS
- npm run build && npm test && npm run test:tokens && npm run test:examples (phase completion rerun) -> PASS
