---
id: m-1b94
status: open
deps: [m-0635]
created: 2026-02-09T06:58:06Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-c494
tags: [refactor, guard-pre-hook, phase-2]
updated: 2026-02-09T06:58:06Z
---
# Refactor Program: Modularize interpreter/hooks/guard-pre-hook.ts - Phase 2: Extract guard candidate collection and operation key services


Objective:
Separate guard-discovery logic from decision orchestration.

Instructions for the implementing agent:
- In scope: guard candidate collection and operation key derivation helpers only.
- Out of scope: retry-state accumulation, context materialization, runtime guard execution.
- Extract `buildPerInputCandidates`, `collectOperationGuards`, `buildOperationKeys`, `buildOperationKeySet`, and `buildOperationSnapshot` into dedicated selection/key modules.
- Preserve guard ordering and de-dup behavior for both data labels and operation keys.
- Preserve operation key expansion for run subtypes (`cmd`, `exec`, language-specific keys).
- Add tests for candidate ordering, dedupe, and operation-key derivation.

Module boundaries:
- Selection module owns candidate ordering and dedupe.
- Operation-key module owns key expansion and snapshot assembly.
- Orchestrator owns when/where these modules are invoked.

Preserve behavior checks:
- Guard candidate ordering remains unchanged.
- Dedup behavior remains unchanged.
- Run subtype key expansion remains unchanged (`cmd`, `exec`, language-specific keys).
- Per-input vs per-operation guard selection parity remains unchanged.

## Acceptance Criteria

1. Candidate collection and operation-key logic resides in dedicated modules.
2. Ordering and dedupe semantics are unchanged for per-input and per-operation guard sets.
3. Tests cover run subtype key derivation and label-driven selection.
4. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples
