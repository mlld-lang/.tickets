---
id: m-722c
status: closed
deps: [m-6937]
created: 2026-02-09T07:06:06Z
type: epic
priority: 1
assignee: Adam Avenir
tags: [refactor, for-evaluator]
updated: 2026-02-11T20:42:37Z
---
# Refactor Program: Modularize interpreter/eval/for.ts



Largest unplanned target file: `interpreter/eval/for.ts` (~1,184 LOC).

This epic coordinates a phased refactor that decomposes for-directive and for-expression execution into focused modules while preserving iteration semantics, parallel execution behavior, control-flow propagation, and error/context reporting behavior.

Execution order:
1. Phase 0 through Phase 7 proceed strictly in order.
2. Each phase closes only after its exit criteria are met.
3. No phase starts until its dependency ticket is closed.

Cross-phase constraints:
- Keep exported APIs stable: `evaluateForDirective` and `evaluateForExpression`.
- Preserve iteration binding behavior for item/key variables, field access derivatives, and metadata propagation.
- Preserve parallel cap/rate resolution and retry/error handling semantics.
- Preserve control-flow behavior for done/continue and exe-return propagation.
- Preserve batch pipeline behavior for for-expression outputs.

## Wave 2 Architecture Contract

Target end state for `interpreter/eval/for.ts`:
- Public exports stay stable: `evaluateForDirective` and `evaluateForExpression`.
- Parallel option parsing, iteration binding/wrapping helpers, shared iteration runner, directive action execution, expression batch handling, and error aggregation are extracted under `interpreter/eval/for/`.
- Control markers, parallel semantics, and metadata propagation remain behavior-compatible.
- Shared iteration result/context contracts are defined once and reused.

Wave 2 guardrails for every phase in this epic:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate iteration setup/teardown logic across directive and expression paths.
- Do not compose iteration services via callback-lambda constructor bundles.
- Verify no circular dependencies inside `interpreter/eval/for*` after each phase.

## Minimum Targeted Test Evidence

Every phase note includes targeted coverage from suites that exercise this area, using files such as:
- `interpreter/eval/for-nested-empty.test.ts`
- `interpreter/eval/for-expression-when.test.ts`
- `interpreter/eval/for-expression-mx.test.ts`
- `tests/integration/for-expr-error-propagation.test.ts`
- representative token fixtures under `tests/tokens/for-loops/*`

## Acceptance Criteria

1. Phase tickets (0-7) exist under this epic and are dependency-linked in sequence.
2. Each phase ticket includes explicit implementation instructions and explicit exit criteria.
3. Final structure splits responsibilities into cohesive modules under `interpreter/eval/for/` (or equivalent) and reduces `for.ts` to orchestration.
4. Final validation command passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-11 20:42 UTC:** Epic completion architecture note (for evaluator modularization)

Final module layout:
- Orchestrator: interpreter/eval/for.ts (265 LOC)
- Extracted runtime modules under interpreter/eval/for/:
  - binding-utils.ts (269 LOC): iteration binding, dotted-field handling, metadata and key-variable rules.
  - parallel-options.ts (143 LOC): parse and normalize /for parallel options (cap/rate).
  - iteration-runner.ts (140 LOC): shared per-iteration environment setup/teardown context for directive + expression.
  - directive-action-runner.ts (214 LOC): directive action execution for block/non-block paths, retry handling, bare exec effect emission.
  - expression-runner.ts (236 LOC): expression-node sequence evaluation, control propagation, structured-result handling.
  - batch-pipeline.ts (89 LOC): expression batch pipeline application and fallback behavior.
  - error-reporting.ts (82 LOC): marker formatting/creation, @mx for-errors context publication, stderr reporting for parallel failures.
  - source-evaluator.ts (102 LOC): source evaluation, iterable validation/type mismatch reporting, expression source descriptor fallback.
  - result-variable.ts (168 LOC): final for-expression variable assembly + descriptor/provenance propagation.
- Shared type-only module:
  - types.ts (9 LOC): ForIterationError, ForControlKindResolver.

Seams and specialization points:
- Shared runner boundary: iteration-runner.ts supplies setupIterationContext/push/pop context helpers used by both evaluateForDirective and evaluateForExpression.
- Directive specialization: directive-action-runner.ts contains directive block/non-block semantics and retry policy handling.
- Expression specialization: expression-runner.ts + batch-pipeline.ts + result-variable.ts own expression branch evaluation and final value shaping.
- Shared cross-cutting concerns: error-reporting.ts and source-evaluator.ts remove duplicated logic from the orchestrator.

Callback/cycle-break seam usage:
- No callback-lambda service composition introduced.
- No recursion/cycle-break callback seams were required.

Module count and line-count distribution:
- Runtime modules in extraction area (including orchestrator): 10 files.
- Runtime line distribution (LOC): 82, 89, 102, 140, 143, 168, 214, 236, 265, 269.

Guardrail confirmations:
- No runtime module under 60 LOC (type-only exception: types.ts).
- No thin facade modules; each extracted runtime file owns substantive behavior.
- No duplicated source-validation/error-aggregation/result-assembly logic across sibling modules.
- Local dependency graph for interpreter/eval/for.ts + interpreter/eval/for/*.ts is acyclic (NO_CYCLES).

Final gate evidence:
- npm run build && npm test && npm run test:tokens && npm run test:examples
- Result: pass (exit 0) with full suite/tokens/examples green.
