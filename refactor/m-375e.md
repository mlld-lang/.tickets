---
id: m-375e
status: closed
deps: [m-b564]
links: []
created: 2026-02-09T06:03:26Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-9f2b
tags: [refactor, exec-invocation, phase-7, command]
updated: 2026-02-10T19:58:16Z
---
# Phase 7: Extract command executable handler

Objective:
Extract command executable flow (highest risk path) into a dedicated handler.

Instructions for the implementing agent:
- Move command execution logic into `interpreter/eval/exec/handlers/command.ts` (or equivalent), including:
  - autoverify/signature checks
  - command template interpolation
  - env/auth/using injection
  - provider execution path
  - oversized-env bash fallback
  - command-level with-clause pipeline handling
- Preserve shell validation, security descriptor propagation, and policy label-flow checks.
- Verify command output normalization and stdin handling remain identical.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Command executable path is isolated in a dedicated handler module.
2. Autoverify, env injection, provider, and fallback behavior remain consistent.
3. Command-focused tests (including autoverify/env-injection/security regressions) remain green.
4. Full test gate passes and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-10 19:58 UTC:** Phase implementation complete.

What changed:
- Added `interpreter/eval/exec/command-handler.ts` (795 LOC).
  - Ownership: dedicated command executable flow for autoverify/signature checks, command template interpolation, environment/provider execution, oversized-env bash fallback, command-level pipeline handling, and command output normalization.
- Updated `interpreter/eval/exec-invocation.ts` (1945 LOC) to delegate command executable execution to `executeCommandExecutable(...)` while preserving existing guard/policy orchestration around command execution.

Checklist evidence:
- Command executable path is isolated in a dedicated handler module.
- Handler preserves:
  - autoverify/signature enrichment for signed prompt variables,
  - env/auth/using injection with policy label-flow enforcement,
  - provider execution path,
  - oversized-env bash heredoc fallback,
  - command-level with-clause pipeline handling and output normalization.

Targeted tests run (all pass):
- `npm run build`
- `npx vitest run interpreter/eval/exec-invocation.autoverify.test.ts interpreter/eval/exec-invocation.env-injection.test.ts interpreter/eval/exec-invocation.structured.test.ts tests/integration/policy-command-exec.test.ts tests/security/shell-escaping-regression.test.ts`
- `npx vitest run tests/bash-env-limit.test.ts`

Full gate run (pass):
- `npm run build && npm test && npm run test:tokens && npm run test:examples`

Wave 2 guardrail attestations:
- No new sub-60 runtime module introduced in this phase.
- No duplicated pre/post implementation introduced in touched area.
- No callback-lambda service injection introduced for service composition.
- Shared command handler contracts (`CommandExecutableHandlerOptions` and services) are defined once in `command-handler.ts` for this extraction area.
- Dependency direction remains acyclic in touched modules.
