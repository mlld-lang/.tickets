---
id: m-5156
status: open
deps: []
created: 2026-02-09T06:56:38Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-c494
tags: [refactor, guard-pre-hook, phase-0]
updated: 2026-02-09T06:56:38Z
---
# Refactor Program: Modularize interpreter/hooks/guard-pre-hook.ts - Phase 0: Baseline and characterization


Objective:
Establish a safety net for pre-guard behavior before structural extraction.

Instructions for the implementing agent:
- In scope: characterization tests and extraction-boundary mapping only.
- Out of scope: moving runtime logic to new modules or changing hook behavior.
- Build a responsibility map of `guard-pre-hook.ts`, including guard selection, decision progression, retry tracking, helper injection, and metadata/event emission.
- Add/expand characterization tests for high-risk flows:
  - per-input and per-operation guard collection and ordering
  - guard override (`false`, `only`, `except`) and bypass-blocked behavior
  - deny/retry/env/allow transitions and metadata aggregation
  - secret-label redaction in previews/context snapshots
  - replacement handling and transformed input propagation
- Record extraction seams and known regression hazards in ticket notes.
- Do not move code across files in this phase.

Preserve behavior checks:
- Override semantics (`false`, `only`, `except`) remain baseline-locked.
- Retry-attempt state stays isolated by attempt key and scope.
- Secret redaction remains intact in previews and context snapshots.
- Helper injection contracts stay stable (`opIs`, `opHas*`, `inputHas`, `prefixWith`, `tagValue`).
- Env/policy/replacement outcomes and metadata remain baseline-compatible.

## Acceptance Criteria

1. Characterization coverage exists for each high-risk flow and each preserve-behavior check.
2. Baseline notes include explicit module extraction boundaries and regression hazards.
3. No intentional runtime semantic change is introduced.
4. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples
