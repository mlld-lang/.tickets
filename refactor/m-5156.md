---
id: m-5156
status: closed
deps: []
created: 2026-02-09T06:56:38Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-c494
tags: [refactor, guard-pre-hook, phase-0]
updated: 2026-02-10T08:19:58Z
---
# Refactor Program: Modularize interpreter/hooks/guard-pre-hook.ts - Phase 0: Baseline and characterization


Objective:
Establish a safety net for pre-guard behavior before structural extraction.

Instructions for the implementing agent:
- In scope: characterization tests and extraction-boundary mapping only.
- Out of scope: moving runtime logic to new modules or changing hook behavior.
- Build a responsibility map of `guard-pre-hook.ts`, including guard selection, decision progression, retry tracking, helper injection, and metadata/event emission.
- Add/expand characterization tests for high-risk flows:
  - per-input and per-operation guard collection and ordering
  - guard override (`false`, `only`, `except`) and bypass-blocked behavior
  - deny/retry/env/allow transitions and metadata aggregation
  - secret-label redaction in previews/context snapshots
  - replacement handling and transformed input propagation
- Record extraction seams and known regression hazards in ticket notes.
- Do not move code across files in this phase.

Preserve behavior checks:
- Override semantics (`false`, `only`, `except`) remain baseline-locked.
- Retry-attempt state stays isolated by attempt key and scope.
- Secret redaction remains intact in previews and context snapshots.
- Helper injection contracts stay stable (`opIs`, `opHas*`, `inputHas`, `prefixWith`, `tagValue`).
- Env/policy/replacement outcomes and metadata remain baseline-compatible.

## Acceptance Criteria

1. Characterization coverage exists for each high-risk flow and each preserve-behavior check.
2. Baseline notes include explicit module extraction boundaries and regression hazards.
3. No intentional runtime semantic change is introduced.
4. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 07:02 UTC:** Checkpoint 1 complete: responsibility map + extraction seam inventory (no runtime movement).

Responsibility map (current file sections):
- Override parsing/filtering and bypass security enforcement: extractGuardOverride, normalizeGuardOverride, applyGuardOverrideFilter, project config allowGuardBypass check in guardPreHook.
- Candidate/key selection: buildPerInputCandidates, collectOperationGuards, buildOperationKeys/buildOperationKeySet.
- Retry state tracking: getRootEnvironment/getAttemptStore, buildGuardAttemptKey, clearGuardAttemptState.
- Runtime guard execution: evaluateGuard + evaluateGuardBlock + evaluateGuardReplacement + resolveGuardEnvConfig.
- Materialization and redaction: buildVariablePreview/buildInputPreview, cloneGuardContextSnapshot, redactOrCloneGuardContextInput, cloneVariableForReplacement.
- Helper injection contracts: injectGuardHelpers, ensurePrefixHelper, ensureTagHelper, attachGuardHelper.
- Decision aggregation + emission: buildAggregateMetadata, buildAggregateGuardContext, appendGuardHistory, env.emitSDKEvent, action mapping (continue/retry/abort).

Extraction seams to preserve in later phases:
- Keep override normalization/filtering as a pure boundary (input = withClause guards, output = normalized override object).
- Keep candidate collection isolated from runtime evaluation (registry reads + order dedupe only).
- Keep attempt-state boundary isolated by operation/scope/variable key and rooted env store.
- Keep guard runtime boundary isolated from aggregation (single-guard eval returns GuardResult with metadata/replacement/env/hint).
- Keep redaction boundary isolated from metadata assembly (all previews/context snapshots sanitized before emission/errors).
- Keep helper injection boundary isolated (op/input helpers + prefixWith/tagValue resolution behavior unchanged).

Known regression hazards to baseline-lock:
- Override modes false/only/except must preserve privileged-guard behavior and bypass-blocked security error path.
- Retry attempt keys must stay isolated across scope (perInput vs perOperation) and variable identity.
- Secret redaction must stay applied in guardInput/inputPreview/outputPreview/guardContext snapshots and serialized errors.
- Replacement propagation must preserve transformedInputs order and feed downstream per-operation guards.
- Env decision metadata (envConfig/envGuard) must preserve first-selection semantics.
- Metadata aggregation must preserve reasons/hints/trace ordering and primary reason selection.

**2026-02-10 08:19 UTC:** Checkpoint 2 complete: characterization coverage expanded for high-risk pre-hook behavior (no runtime code movement).

Checklist coverage completed:
- per-input + per-operation guard ordering characterization added.
- override coverage expanded for false/only/except behavior (except path explicitly characterized).
- helper contract coverage expanded for opHas/opHasAny/opHasAll/inputHas/prefixWith/tagValue.
- retry state isolation coverage expanded (per-input identity and per-input vs per-operation scope isolation).
- env decision metadata aggregation characterized via direct pre-hook invocation assertions.
- replacement/transformed input and secret redaction characterization preserved by existing + expanded suite.

Additional gate-unblock updates made during required full-gate execution:
- Updated semantic token test cases to match current strict parser/token behavior for block comment fixtures.
- Updated token precision expectation for @input import token classification to variable[readonly].

Targeted tests run:
- npx vitest run tests/interpreter/hooks/guard-pre-hook.test.ts  -> PASS
- npx vitest run --config vitest.config.tokens.mts services/lsp/semantic-tokens.test.ts services/lsp/as-modifier-tokens.test.ts services/lsp/embedded-language-tokens.test.ts services/lsp/semantic-tokens-coverage.test.ts tests/tokens/token-test-runner.test.ts  -> PASS

Full gate run:
- npm run build && npm test && npm run test:tokens && npm run test:examples  -> PASS

Phase outcome:
- Acceptance criteria satisfied for baseline characterization and extraction seam mapping.
- No intentional runtime semantic change introduced in guard-pre runtime path.
