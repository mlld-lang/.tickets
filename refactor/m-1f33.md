---
id: m-1f33
status: closed
deps: [m-f706]
created: 2026-02-09T06:44:04Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-bd66
tags: [refactor, run, phase-1]
updated: 2026-02-11T06:58:54Z
---
# Refactor Program: Modularize interpreter/eval/run.ts - Phase 1: Extract pure helpers and pre-extracted input readers

Objective:
Extract deterministic helper logic from interpreter/eval/run.ts into focused modules without changing runtime behavior.

Instructions for the implementing agent:
- Move pure helper functions into a run helper module (for example: extractRawTextContent, dedentCommonIndent, resolveRunCodeOpType, mergeAuthUsing).
- Move pre-extracted input readers (run command, descriptor, stdin, and executable lookup helpers) into a dedicated run input-access module.
- Keep evaluateRun signature and externally visible behavior unchanged.
- Replace in-function helper usage with imports from extracted modules.
- Add focused tests for helper edge cases that are not already covered by characterization tests.
- Keep this phase as a code-move and wiring phase only; avoid behavior changes.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Pure helpers and pre-extracted input readers live in dedicated modules with clear names.
2. evaluateRun remains behaviorally identical and imports extracted helpers.
3. Added helper tests pass.
4. Exit criteria (required before next phase): full test gate passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-11 06:58 UTC:** Phase 1 extraction completed.

What changed:
- Extracted pure run helpers into `interpreter/eval/run-modules/run-pure-helpers.ts`:
  - `extractRawTextContent`
  - `dedentCommonIndent`
  - `resolveRunCodeOpType`
  - `mergeAuthUsing`
- Extracted pre-extracted input readers into `interpreter/eval/run-modules/run-pre-extracted-inputs.ts`:
  - `getPreExtractedRunCommand`
  - `getPreExtractedRunDescriptor`
  - `getPreExtractedRunStdin`
  - `getPreExtractedExec`
- Rewired `interpreter/eval/run.ts` to import these helpers/readers without behavior changes.
- Added focused helper tests in `interpreter/eval/run-modules/run-modules.test.ts` for helper edge cases and pre-extracted-reader behavior.

Touched runtime modules (ownership + line count):
- `interpreter/eval/run.ts` (1506 LOC): phase orchestrator still owns runtime behavior, now consuming extracted helper modules.
- `interpreter/eval/run-modules/run-pure-helpers.ts` (102 LOC): deterministic text/language/auth helper logic.
- `interpreter/eval/run-modules/run-pre-extracted-inputs.ts` (74 LOC): extracted-input reader logic for command/stdin/descriptor/executable retrieval.

Guardrail confirmations:
- No new runtime module under 60 LOC introduced.
- No callback-lambda service injection introduced.
- Shared helper logic moved once and imported; no helper duplication introduced.
- Module dependencies remain acyclic in the touched run area.

Sub-checkpoint evidence (pass):
- `npm run build && npx vitest run interpreter/eval/run-modules/run-modules.test.ts interpreter/eval/run.characterization.test.ts interpreter/eval/run.structured.test.ts interpreter/eval/run-in-blocks.test.ts tests/integration/policy-command-exec.test.ts tests/pipeline-context-retry.test.ts`

Full gate evidence (pass):
- `npm run build && npm test && npm run test:tokens && npm run test:examples`
