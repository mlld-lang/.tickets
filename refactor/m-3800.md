---
id: m-3800
status: open
deps: [m-7c90]
links: []
created: 2026-02-09T06:24:52Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-d11b
tags: [refactor, var, phase-7, tools]
---
# Refactor Program: Modularize interpreter/eval/var.ts - Phase 7: Isolate tool-scope and tool-collection normalization

Objective:
Isolate tool-scope and tool-collection normalization logic.

Instructions for the implementing agent:
- Move tool helper functions into focused module(s) (example target: `interpreter/eval/var/tool-scope.ts`):
  - `resolveWithClauseToolsValue`
  - `normalizeToolScopeValue`
  - `enforceToolSubset`
  - `normalizeToolCollection`
  - related utility helpers (`resolveToolMlldName`, `normalizeStringArray`, `isPlainObject` if still tool-owned)
- Keep validation/error semantics stable, including parameter coverage checks for bind/expose.
- Ensure tool collection normalization still enforces executable reference constraints via environment lookups.
- Add focused tests for tool normalization success/failure scenarios and subset enforcement.

## Acceptance Criteria

1. Tool-scope and tool-collection helpers are extracted into dedicated module(s).
2. Validation behavior and error semantics remain unchanged.
3. Added tests cover bind/expose validation and subset-enforcement scenarios.
4. Exit criteria: all tests pass, with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

