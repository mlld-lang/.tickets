---
id: m-a634
status: closed
deps: [m-375e]
links: []
created: 2026-02-09T06:03:26Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-9f2b
tags: [refactor, exec-invocation, phase-8, code]
updated: 2026-02-10T20:05:32Z
---
# Phase 8: Extract code executable handler

Objective:
Extract code executable flow into dedicated handler(s).

Instructions for the implementing agent:
- Move code-language dispatch into `interpreter/eval/exec/handlers/code.ts` (or equivalent), including:
  - mlld-when / mlld-foreach / mlld-for / mlld-loop / mlld-exe-block flows
  - bash/sh code-path behavior
  - js/node/python parameter shaping and shadow environment capture
  - auto-unwrap restoration and structured result normalization
- Preserve metadata/security propagation and with-clause processing.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Code executable path is isolated in dedicated handler module(s).
2. Language-specific behavior remains unchanged.
3. Code execution, shadow env, and structured output tests remain green.
4. Full test gate passes and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-10 20:05 UTC:** Phase implementation complete.

What changed:
- Added `interpreter/eval/exec/code-handler.ts` (406 LOC).
  - Ownership: dedicated code executable flow for language dispatch (`mlld-when`, `mlld-foreach`, `mlld-for`, `mlld-loop`, `mlld-exe-block`), bash/sh code-path handling, js/node/python parameter shaping, shadow env capture, auto-unwrap restoration, structured normalization, and code-level with-clause processing.
- Updated `interpreter/eval/exec-invocation.ts` (1619 LOC) to delegate code executable execution to `executeCodeExecutable(...)` and preserve surrounding guard/policy/result orchestration.

Checklist evidence:
- Code executable path is isolated into a dedicated handler module.
- Language-specific behavior remains preserved through delegated dispatch and unchanged execution paths.
- Shadow environment propagation and structured output normalization remain preserved in handler output.

Targeted tests run (all pass):
- `npm run build`
- `MLLD_STRICT=0 npx vitest run interpreter/eval/exec-invocation.structured.test.ts interpreter/env/variable-passing-integration.test.ts interpreter/env/variable-proxy-integration.test.ts interpreter/eval/foreach.structured.test.ts interpreter/eval/for-expression-mx.test.ts interpreter/eval/for-expression-when.test.ts tests/integration/js-shadow-cleanup.test.ts tests/integration/node-shadow-cleanup.test.ts interpreter/eval/show.structured.test.ts`

Full gate run (pass):
- `npm run build && npm test && npm run test:tokens && npm run test:examples`

Wave 2 guardrail attestations:
- No new sub-60 runtime module introduced in this phase.
- No duplicated pre/post implementation introduced in touched area.
- No callback-lambda service injection introduced for service composition.
- Shared code-handler contracts (`CodeExecutableHandlerOptions`, services, and result union) are defined once in `code-handler.ts` for this extraction area.
- Dependency direction remains acyclic in touched modules.
