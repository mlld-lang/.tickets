---
id: m-499a
status: open
deps: [m-edc5]
links: []
created: 2026-02-09T06:19:05Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-ef4e
tags: [refactor, environment, phase-2, security, policy]
---
# Refactor Program: Modularize interpreter/env/Environment.ts - Phase 2: Isolate security, policy, and state-write runtime

Objective:
Extract mutable security/policy/state runtime concerns into a dedicated collaborator.

Instructions for the implementing agent:
- Move the security runtime stack operations into a focused module/service:
  - snapshot creation and descriptor conversion
  - push/pop security context and capability context creation
  - descriptor merge/record utilities
- Move policy context and tool-allowlist orchestration into a cohesive API with existing parent fallback semantics.
- Move state-write tracking and `@state` snapshot update logic into dedicated state runtime helpers.
- Preserve existing error behavior and policy/tool scope restrictions.

## Acceptance Criteria

1. Security, policy, and state-write mutation logic is isolated behind clear internal APIs.
2. Parent fallback behavior and scope narrowing rules are preserved.
3. Provenance/security descriptor propagation behavior remains unchanged in tests.
4. Exit criteria: full test gate passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

