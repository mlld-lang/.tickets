---
id: m-499a
status: closed
deps: [m-edc5]
links: []
created: 2026-02-09T06:19:05Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-ef4e
tags: [refactor, environment, phase-2, security, policy]
updated: 2026-02-10T20:44:15Z
---
# Refactor Program: Modularize interpreter/env/Environment.ts - Phase 2: Isolate security, policy, and state-write runtime

Objective:
Extract mutable security/policy/state runtime concerns into a dedicated collaborator.

Instructions for the implementing agent:
- Move the security runtime stack operations into a focused module/service:
  - snapshot creation and descriptor conversion
  - push/pop security context and capability context creation
  - descriptor merge/record utilities
- Move policy context and tool-allowlist orchestration into a cohesive API with existing parent fallback semantics.
- Move state-write tracking and `@state` snapshot update logic into dedicated state runtime helpers.
- Preserve existing error behavior and policy/tool scope restrictions.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Security, policy, and state-write mutation logic is isolated behind clear internal APIs.
2. Parent fallback behavior and scope narrowing rules are preserved.
3. Provenance/security descriptor propagation behavior remains unchanged in tests.
4. Exit criteria: full test gate passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-10 20:44 UTC:** Completed Phase 2 extraction for security/policy/state runtime concerns.

What changed:
- Added `interpreter/env/runtime/SecurityPolicyRuntime.ts` (260 LOC)
  - Owns security runtime stack state and mutation: snapshot conversion, push/pop context, descriptor merge/record.
  - Owns policy runtime state: policy context/environment, policy summary merge/record, policy capabilities.
  - Owns tool-allowlist orchestration with parent-scope narrowing validation and allow checks.
- Added `interpreter/env/runtime/StateWriteRuntime.ts` (115 LOC)
  - Owns state-write indexing/logging, `@state` snapshot mutation, state variable refresh, and dynamic resolver synchronization.
- Added focused unit tests:
  - `interpreter/env/runtime/SecurityPolicyRuntime.test.ts`
  - `interpreter/env/runtime/StateWriteRuntime.test.ts`
- Updated `interpreter/env/Environment.ts` (2824 LOC)
  - Delegates security/policy/tool scope operations to `SecurityPolicyRuntime`.
  - Delegates state write and `@state` snapshot logic to `StateWriteRuntime`.
  - Preserved behavior/API signatures; restored internal `allowedTools` mirror for existing env-directive introspection tests.
- Updated `interpreter/env/bootstrap/EnvironmentBootstrap.ts` (289 LOC)
  - Reused shared `SecuritySnapshotLike` type from runtime extraction area.

Checklist/acceptance mapping:
- Security runtime stack operations isolated behind collaborator API: complete.
- Policy context + tool allowlist orchestration isolated with parent narrowing semantics preserved: complete.
- State-write tracking + `@state` snapshot update logic isolated in dedicated helper: complete.
- Provenance/security propagation behavior preserved by targeted + full gate results: complete.

Wave 2 guardrail evidence:
- No new sub-60 runtime modules introduced.
  - New runtime modules are 260 LOC and 115 LOC.
- No callback-lambda constructor service injection introduced.
  - Composition uses concrete collaborator objects (`SecurityPolicyRuntime`, `StateWriteRuntime`), no constructor callback-lambda seams added.
- Shared extraction-area type dedup done for security snapshot shape (`SecuritySnapshotLike`).
- Dependency direction in touched env runtime area remains acyclic by import inspection:
  - `Environment.ts` -> runtime modules
  - `bootstrap/EnvironmentBootstrap.ts` -> runtime type
  - runtime modules do not import `Environment.ts`.

Sub-checkpoint validation (build + targeted):
- `npm run build` ✅
- `npx vitest run interpreter/eval/env-directive.test.ts interpreter/env/runtime/SecurityPolicyRuntime.test.ts interpreter/env/runtime/StateWriteRuntime.test.ts interpreter/env/Environment.characterization.test.ts interpreter/env/tool-scope.test.ts tests/interpreter/import/state-live-update.test.ts tests/interpreter/policy-directive.test.ts tests/interpreter/security-metadata.test.ts` ✅

Full gate for phase close:
- `npm run build && npm test && npm run test:tokens && npm run test:examples` ✅
- Main suite: 314 files passed, 0 failed (7 skipped); 3657 passed (63 skipped)
- Token suite: 6 files passed; 331 passed (6 skipped)
- Examples suite: 1 file passed; 1353 passed (2 skipped)
