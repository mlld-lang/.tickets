---
id: m-796b
status: open
deps: [m-1781]
links: []
created: 2026-02-09T06:24:52Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-d11b
tags: [refactor, var, phase-2, collections]
---
# Refactor Program: Modularize interpreter/eval/var.ts - Phase 2: Extract collection complexity and recursive evaluators

Objective:
Extract collection complexity detection and recursive item evaluation logic.

Instructions for the implementing agent:
- Move `hasComplexValues`, `hasComplexArrayItems`, and `evaluateArrayItem` into dedicated evaluator module(s) (example target: `interpreter/eval/var/collection-evaluator.ts`).
- Isolate shared recursion behavior for nested object/array entries to remove duplicated handling branches.
- Keep lazy/eager thresholds unchanged for spread entries, conditional pairs, nested complex nodes, wrappers, and parser legacy shapes.
- Keep security descriptor collection hooks intact for variable references and interpolated content in collections.
- Add targeted tests for nested arrays/objects, wrapped literals/text, and variable reference handling inside collections.

## Acceptance Criteria

1. Collection complexity checks and recursive item evaluation are extracted behind stable helper interfaces.
2. Lazy/eager behavior and descriptor propagation for collection values remain unchanged.
3. Added tests cover nested and mixed-shape collection scenarios.
4. Exit criteria: all tests pass, with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

