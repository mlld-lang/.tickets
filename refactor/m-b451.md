---
id: m-b451
status: closed
deps: [m-83af]
created: 2026-02-09T06:58:07Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-c494
tags: [refactor, guard-pre-hook, phase-4]
updated: 2026-02-10T08:44:31Z
---
# Refactor Program: Modularize interpreter/hooks/guard-pre-hook.ts - Phase 4: Extract guard context/input/output materialization


Objective:
Isolate variable/context shaping used by guard evaluation.

Instructions for the implementing agent:
- In scope: guard context snapshot cloning, redaction, input/output preview and replacement materialization helpers.
- Out of scope: decision-state transitions and runtime action dispatch.
- Extract input/output materialization helpers (`cloneVariableForGuard`, preview builders, `resolveGuardValue`, replacement normalization).
- Extract context cloning/redaction utilities (`cloneGuardContextSnapshot`, redaction helpers) into a snapshot module.
- Preserve secret-label redaction behavior for previews and serialized guard metadata.
- Add tests for snapshot cloning, redaction, and mixed variable shapes (text/object/array).

Module boundaries:
- Materialization module owns variable cloning/preview/replacement shaping.
- Snapshot module owns context cloning and redaction rules.
- Runtime evaluator consumes these modules without mutating redaction policy.

Preserve behavior checks:
- Secret-labeled data redaction remains unchanged in previews and metadata.
- Context snapshot structure remains unchanged for guard execution consumers.
- Replacement materialization behavior remains unchanged across variable types.

## Acceptance Criteria

1. Context/input/output materialization helpers are separated into focused modules.
2. Secret-label handling and preview behavior remain unchanged.
3. Tests verify redaction behavior and context snapshot stability.
4. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 08:44 UTC:** Phase 4 implementation complete.

What changed:
- Extracted input/output materialization helpers into `interpreter/hooks/guard-materialization.ts`:
  - preview/redaction helpers (`buildVariablePreview`, `buildInputPreview`, secret-label checks, redacted output marker),
  - variable/replacement cloning (`cloneVariableForGuard`, `cloneVariableForReplacement`),
  - value/replacement shaping (`resolveGuardValue`, `normalizeGuardReplacements`).
- Extracted context cloning/redaction helpers into `interpreter/hooks/guard-context-snapshot.ts`:
  - `cloneGuardContextSnapshot`,
  - `redactOrCloneGuardContextInput`.
- Updated `interpreter/hooks/guard-pre-hook.ts` to consume extracted materialization/snapshot modules while leaving decision orchestration and runtime dispatch intact.
- Added targeted coverage in `tests/interpreter/hooks/guard-materialization.test.ts` for:
  - mixed variable preview behavior (text/object/array-backed values),
  - secret redaction semantics,
  - replacement shaping/cloning behavior,
  - context snapshot cloning/redaction stability.

Checklist/acceptance coverage:
- [x] Context/input/output materialization helpers separated into focused modules.
- [x] Secret-label preview/metadata redaction behavior preserved.
- [x] Context snapshot structure and redaction behavior verified by tests.
- [x] Replacement materialization behavior preserved across variable value shapes.

Tests run:
- npx vitest run tests/interpreter/hooks/guard-materialization.test.ts tests/interpreter/hooks/guard-pre-hook.test.ts -> PASS
- npm run build && npm test && npm run test:tokens && npm run test:examples -> PASS
- npm run build && npm test && npm run test:tokens && npm run test:examples (phase completion rerun) -> PASS
