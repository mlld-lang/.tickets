---
id: m-b451
status: open
deps: [m-83af]
created: 2026-02-09T06:58:07Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-c494
tags: [refactor, guard-pre-hook, phase-4]
updated: 2026-02-09T06:58:21Z
---
# Refactor Program: Modularize interpreter/hooks/guard-pre-hook.ts - Phase 4: Extract guard context/input/output materialization


Objective:
Isolate variable/context shaping used by guard evaluation.

Instructions for the implementing agent:
- In scope: guard context snapshot cloning, redaction, input/output preview and replacement materialization helpers.
- Out of scope: decision-state transitions and runtime action dispatch.
- Extract input/output materialization helpers (`cloneVariableForGuard`, preview builders, `resolveGuardValue`, replacement normalization).
- Extract context cloning/redaction utilities (`cloneGuardContextSnapshot`, redaction helpers) into a snapshot module.
- Preserve secret-label redaction behavior for previews and serialized guard metadata.
- Add tests for snapshot cloning, redaction, and mixed variable shapes (text/object/array).

Module boundaries:
- Materialization module owns variable cloning/preview/replacement shaping.
- Snapshot module owns context cloning and redaction rules.
- Runtime evaluator consumes these modules without mutating redaction policy.

Preserve behavior checks:
- Secret-labeled data redaction remains unchanged in previews and metadata.
- Context snapshot structure remains unchanged for guard execution consumers.
- Replacement materialization behavior remains unchanged across variable types.

## Acceptance Criteria

1. Context/input/output materialization helpers are separated into focused modules.
2. Secret-label handling and preview behavior remain unchanged.
3. Tests verify redaction behavior and context snapshot stability.
4. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples
