---
id: m-943f
status: open
deps: []
created: 2026-02-09T06:59:36Z
type: epic
priority: 1
assignee: Adam Avenir
tags: [refactor, import-directive-evaluator]
updated: 2026-02-09T06:59:36Z
---
# Refactor Program: Modularize interpreter/eval/import/ImportDirectiveEvaluator.ts



Largest unplanned target file: `interpreter/eval/import/ImportDirectiveEvaluator.ts` (~1,732 LOC).

This epic coordinates a phased refactor that decomposes import evaluation into focused services while preserving resolver/module behavior, import security semantics, policy needs enforcement, and import binding collision guarantees.

Execution order:
1. Phase 0 through Phase 7 proceed strictly in order.
2. Each phase closes only after its exit criteria are met.
3. No phase starts until its dependency ticket is closed.

Cross-phase constraints:
- Keep `evaluateImport` behavior and public contract stable.
- Preserve import type inference/validation semantics and existing error codes/messages.
- Preserve MCP import binding behavior, alias resolution rules, and tool parameter mapping.
- Preserve resolver/module/node/file/directory import behavior, including lock-file validation and policy checks.
- Preserve import binding collision enforcement and policy context application semantics.

## Acceptance Criteria

1. Phase tickets (0-7) exist under this epic and are dependency-linked in sequence.
2. Each phase ticket includes explicit implementation instructions and explicit exit criteria.
3. Final structure splits responsibilities into cohesive modules under `interpreter/eval/import/` and reduces `ImportDirectiveEvaluator.ts` to orchestration.
4. Final validation command passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-09 08:17 UTC:** Safety-hardening pass completed for phases m-3469 -> m-2f95.

Tightening applied:
- Added explicit in-scope/out-of-scope boundaries to each phase.
- Added concrete module-boundary requirements for type inference/validation, MCP services, resolver/input handlers, module/node handlers, file/url/directory handlers, and policy/needs/binding validators.
- Added explicit preserve-behavior checks for import-type error semantics, MCP flow parity, resolver/module/node/file/url/dir parity, needs/policy enforcement, and binding collision guarantees.
- Standardized each phase exit criteria to require:
  npm run build && npm test && npm run test:tokens && npm run test:examples

Dependency verification:
- Verified linear chain with `tk dep tree --full m-2f95` in a temporary workspace mount that maps `.tickets/refactor` as `.tickets`.
- No dependency rewiring required.

Residual risk:
- Branch parity risk remains highest where directory import traversal and policy/needs enforcement intersect; final parity checks should include mixed directory+module imports with collisions.

**2026-02-09 08:25 UTC:** Micro-planning addendum (hotspot): added intersection checklists to phases m-5b60, m-a2a7, and m-2f95.

Focus:
- Covers directory traversal + policy/needs enforcement + binding collision intersections.
- Adds explicit closure gates requiring checklist-backed tests before each phase closes.
