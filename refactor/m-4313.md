---
id: m-4313
status: closed
deps: [m-ba71]
created: 2026-02-09T06:44:05Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-bd66
tags: [refactor, run, phase-6]
updated: 2026-02-11T07:31:41Z
---
# Refactor Program: Modularize interpreter/eval/run.ts - Phase 6: Extract executable definition handler dispatcher

Objective:
Replace the monolithic runExec definition branch with a typed handler dispatcher per executable definition kind.

Instructions for the implementing agent:
- Introduce a dispatcher that routes by executable definition type.
- Extract handlers for:
  - command definitions
  - commandRef definitions (AST invocation and recursive run fallback)
  - builtin transformer definitions (including keychain policy enforcement)
  - code definitions (including mlld-when and mlld-exe-block special handling)
  - template definitions
  - prose definitions
- Preserve mergeAuthUsing behavior and descriptor propagation across handlers.
- Keep handler interfaces explicit (input context, env access, output/descriptors) and unit-testable.
- Add targeted tests per handler type, including failure paths.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Executable definition handling uses a dispatcher with isolated handlers.
2. All definition types preserve existing semantics and side effects.
3. Targeted tests cover each handler type and key failure paths.
4. Exit criteria (required before next phase): full test gate passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-11 07:31 UTC:** --dir refactor Phase 6 implementation complete.

Runtime modules touched:
- interpreter/eval/run-modules/run-exec-definition-dispatcher.ts (640 LOC): owns runExec executable-definition dispatch and handler implementations for command, commandRef (AST + recursive fallback), builtin transformer, code (including mlld-when/mlld-exe-block branches), template, and prose definitions.
- interpreter/eval/run.ts (458 LOC): runExec branch now delegates definition handling to the typed dispatcher and applies returned descriptors/outputs.

Tests added/updated:
- interpreter/eval/run-modules/run-exec-definition-dispatcher.test.ts (430 LOC): targeted coverage for each handler type plus failure paths (command security block, commandRef cycle, builtin keychain arg validation, mlld-when missing node, unsupported type).

Sub-checkpoint evidence:
- npm run build && npx vitest run interpreter/eval/run-modules/run-exec-definition-dispatcher.test.ts interpreter/eval/run-modules/run-exec-resolver.test.ts interpreter/eval/run.characterization.test.ts interpreter/eval/run.structured.test.ts
- Result: PASS (Test Files 4 passed; Tests 44 passed, 1 skipped).

Phase full-gate evidence:
- npm run build && npm test && npm run test:tokens && npm run test:examples
- Result: PASS
  - npm test: Test Files 339 passed, 7 skipped; Tests 3811 passed, 63 skipped.
  - npm run test:tokens: Test Files 6 passed; Tests 331 passed, 6 skipped.
  - npm run test:examples: Test Files 1 passed; Tests 1353 passed, 2 skipped.

Guardrail checks:
- No new runtime module under 60 lines (new runtime dispatcher is 640 LOC).
- No callback-lambda service injection introduced as composition pattern; one explicit recursion seam is typed in services (evaluateRunRecursive) to break run.ts commandRef recursion cycle.
- Shared runExec definition-handler logic is consolidated in one runtime module; no duplicated sibling logic introduced.
- Dependency direction in the touched run module area remains acyclic.
