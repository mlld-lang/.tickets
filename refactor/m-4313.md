---
id: m-4313
status: open
deps: [m-ba71]
created: 2026-02-09T06:44:05Z
type: task
priority: 1
assignee: Adam Avenir
updated: 2026-02-09T06:44:11Z
---
# Refactor Program: Modularize interpreter/eval/run.ts - Phase 6: Extract executable definition handler dispatcher

Objective:
Replace the monolithic runExec definition branch with a typed handler dispatcher per executable definition kind.

Instructions for the implementing agent:
- Introduce a dispatcher that routes by executable definition type.
- Extract handlers for:
  - command definitions
  - commandRef definitions (AST invocation and recursive run fallback)
  - builtin transformer definitions (including keychain policy enforcement)
  - code definitions (including mlld-when and mlld-exe-block special handling)
  - template definitions
  - prose definitions
- Preserve mergeAuthUsing behavior and descriptor propagation across handlers.
- Keep handler interfaces explicit (input context, env access, output/descriptors) and unit-testable.
- Add targeted tests per handler type, including failure paths.

## Acceptance Criteria

1. Executable definition handling uses a dispatcher with isolated handlers.
2. All definition types preserve existing semantics and side effects.
3. Targeted tests cover each handler type and key failure paths.
4. Exit criteria (required before next phase): full test gate passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

