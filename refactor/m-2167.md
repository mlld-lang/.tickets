---
id: m-2167
status: closed
deps: [m-3800]
links: []
created: 2026-02-09T06:24:52Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-d11b
tags: [refactor, var, phase-8, pipeline]
updated: 2026-02-11T05:06:48Z
---
# Refactor Program: Modularize interpreter/eval/var.ts - Phase 8: Extract pipeline post-processing and result rewriting

Objective:
Extract pipeline post-processing and final result rewriting.

Instructions for the implementing agent:
- Move pipeline execution/skip logic into focused helper module(s) (example target: `interpreter/eval/var/pipeline-finalizer.ts`).
- Preserve skip conditions exactly:
  - `ExecInvocation` with withClause
  - `VariableReference` with pipes
  - `load-content` with pipes
  - command values already handled through `evaluateRun`
- Preserve post-pipeline rewriting behavior for string and structured pipeline outputs.
- Ensure security metadata merge and finalization behavior remain stable after pipeline execution.
- Add focused tests for pipeline skip/execute matrix and post-pipeline variable rewriting.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Pipeline skip/execute and result-rewrite logic is extracted into dedicated helper module(s).
2. Pipeline guard conditions and rewrite semantics remain unchanged.
3. Added tests cover skip/execute cases and output-shape rewrites.
4. Exit criteria: all tests pass, with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-11 05:06 UTC:** Phase 8 implementation complete.

What changed:
- Extracted pipeline skip/execute and post-pipeline result rewriting into interpreter/eval/var/pipeline-finalizer.ts.
- Moved pipeline guard conditions into dedicated helpers while preserving exact skip behavior for:
  - ExecInvocation with withClause
  - VariableReference with pipes
  - load-content with pipes
  - command branches already handled by evaluateRun via withClause
- Moved post-pipeline rewriting behavior for string and structured outputs into pipeline-finalizer.
- Updated interpreter/eval/var.ts to delegate pipeline finalization to createPipelineFinalizer(...).process(...).
- Added focused tests in interpreter/eval/var/pipeline-finalizer.test.ts for skip/execute matrix and rewrite behavior.

Checklist completion:
- [x] Extracted pipeline skip/execute and result rewriting into dedicated helper module.
- [x] Preserved all skip guard conditions and run-handled command bypass behavior.
- [x] Preserved string and structured post-pipeline rewrite semantics.
- [x] Added focused tests for skip/execute matrix and output-shape rewrites.

Touched runtime modules and ownership:
- interpreter/eval/var/pipeline-finalizer.ts (130 lines): owns pipeline execution gating and post-pipeline variable rewrite logic for string/structured outputs.
- interpreter/eval/var.ts (332 lines): owns var orchestration and delegates pipeline finalization to pipeline-finalizer.

Targeted verification:
- npm run build -> PASS
- npx vitest run interpreter/eval/var/pipeline-finalizer.test.ts interpreter/eval/var/execution-evaluator.test.ts interpreter/eval/var.characterization.test.ts tests/interpreter/security-metadata.test.ts interpreter/eval/run.structured.test.ts interpreter/eval/show.structured.test.ts -> PASS

Phase full-gate exit criteria:
- npm run build && npm test && npm run test:tokens && npm run test:examples -> PASS

Guardrail confirmations:
- No new runtime module under 60 lines was introduced.
- No callback-lambda service injection was introduced.
- Shared pipeline finalization behavior is centralized in one module; no duplicated sibling logic introduced.
