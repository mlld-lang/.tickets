---
id: m-408b
status: closed
deps: [m-8006]
links: []
created: 2026-02-09T06:19:05Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-ef4e
tags: [refactor, environment, phase-6, scope, lifecycle]
updated: 2026-02-10T21:27:57Z
---
# Refactor Program: Modularize interpreter/env/Environment.ts - Phase 6: Unify child-environment lifecycle and scope merge

Objective:
Reduce duplication and isolate lifecycle logic for child environment creation, inheritance, and merge behavior.

Instructions for the implementing agent:
- Introduce a child-environment lifecycle helper that owns shared behavior currently split between `createChild` and `createChildEnvironment`.
- Preserve import resolver child creation semantics, policy/tool inheritance, streaming/provenance inheritance, and trace inheritance.
- Keep `mergeChild` behavior exactly consistent, including block-scoped variable exclusions and node merge behavior.
- Add focused tests for child lifecycle and merge semantics if coverage is incomplete.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Child creation paths share a clear internal lifecycle implementation with reduced duplication.
2. Child inheritance and merge semantics remain unchanged.
3. Scope and import behavior tests remain green.
4. Exit criteria: full test gate passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-10 21:27 UTC:** Phase 6 implementation complete.

Changes made
- Added `interpreter/env/runtime/ChildEnvironmentLifecycle.ts` (107 LOC): owns shared child context resolution, inheritance application, and merge semantics.
- Updated `interpreter/env/Environment.ts` (2309 LOC total; phase diff: +68/-87):
  - Added `createLifecycleChild(...)` helper to centralize shared child creation/inheritance/policy/tracking flow.
  - Refactored `createChild(...)` and `createChildEnvironment()` to use shared lifecycle + construction path.
  - Refactored `mergeChild(...)` to delegate variable/node merge to lifecycle service.
- Added `interpreter/env/runtime/ChildEnvironmentLifecycle.test.ts` (82 LOC): targeted coverage for context resolution, inheritance toggles, merge exclusions, and node merge.

Checklist status
- [x] Shared lifecycle implementation introduced for both child-creation paths.
- [x] Child inheritance semantics preserved (policy/tool inheritance, streaming/provenance, module isolation, trace as applicable).
- [x] Merge semantics preserved (block-scoped exclusions for `let` and `exe-param`, node append behavior).
- [x] Focused child lifecycle tests added.

Validation
- Sub-phase targeted validation:
  - `npm run build && npm test -- --run interpreter/env/runtime/ChildEnvironmentLifecycle.test.ts interpreter/env/Environment.characterization.test.ts interpreter/env/variable-passing-integration.test.ts interpreter/debug-dynamic-import.test.ts interpreter/stream-execution.test.ts tests/interpreter/hooks/guard-pre-hook.test.ts`
  - Result: PASS
- Phase close full gate:
  - `npm run build && npm test && npm run test:tokens && npm run test:examples`
  - Result: PASS

Wave 2 guardrail evidence
- No new runtime module under 60 LOC introduced. New runtime module is 107 LOC (`ChildEnvironmentLifecycle.ts`).
- No callback-lambda service-composition injection introduced. Lifecycle logic is composed via `ChildEnvironmentLifecycle` service object.
- Shared lifecycle logic is centralized in one module; no duplicated sibling implementations were introduced.
- Touched dependency direction remains acyclic (Environment facade -> runtime lifecycle service; service imports only shared types).
