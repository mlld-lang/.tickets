---
id: m-3887
status: closed
deps: [m-43a7]
created: 2026-02-09T06:44:04Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-bd66
tags: [refactor, run, phase-4]
updated: 2026-02-11T07:16:06Z
---
# Refactor Program: Modularize interpreter/eval/run.ts - Phase 4: Extract direct run-code execution path

Objective:
Isolate runCode path behavior into a dedicated code execution module.

Instructions for the implementing agent:
- Extract direct runCode handling (code block text extraction, dedent, argument materialization, and executeCode invocation).
- Preserve AutoUnwrapManager usage, argument descriptor collection, and policy/label-flow checks.
- Preserve operation-context updates derived from language capability mapping.
- Preserve working-directory resolution semantics and execution-context propagation.
- Add focused tests for argument extraction (variable refs and primitives), language mapping, and policy-denied code execution.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. runCode path is extracted behind a dedicated module with explicit inputs/outputs.
2. Behavior for argument extraction, policy checks, and executeCode invocation remains consistent.
3. Focused runCode tests pass.
4. Exit criteria (required before next phase): full test gate passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-11 07:16 UTC:** --dir refactor Phase 4 implementation complete.

Runtime modules touched:
- interpreter/eval/run-modules/run-code-executor.ts (157 LOC): owns direct runCode path orchestration (code extraction/dedent, arg materialization, capability mapping/policy and label-flow checks, executeCode invocation wiring).
- interpreter/eval/run.ts (1020 LOC): runCode branch delegates to executeRunCode while preserving external evaluateRun contracts and execution context propagation.

Tests updated:
- interpreter/eval/run.characterization.test.ts (533 LOC): adds runCode-focused characterization for policy deny and primitive-argument fallback.

Sub-checkpoint evidence:
- npm run build && npx vitest run interpreter/eval/run.characterization.test.ts interpreter/eval/run.structured.test.ts interpreter/eval/run-modules/run-modules.test.ts interpreter/eval/run-modules/run-policy-context.test.ts
- Result: PASS (Test Files 4 passed; Tests 46 passed, 1 skipped).

Phase full-gate evidence:
- npm run build && npm test && npm run test:tokens && npm run test:examples
- Result: PASS
  - npm test: Test Files 337 passed, 7 skipped; Tests 3798 passed, 63 skipped.
  - npm run test:tokens: Test Files 6 passed; Tests 331 passed, 6 skipped.
  - npm run test:examples: Test Files 1 passed; Tests 1353 passed, 2 skipped.

Guardrail checks:
- No new runtime module under 60 lines (new runtime file is 157 LOC).
- No callback-lambda service injection introduced.
- No duplicated sibling logic introduced in touched run module area; shared helpers continue to be consumed via run-modules helpers.
- Dependency direction in touched run module area remains acyclic.
