---
id: m-118a
status: closed
deps: [m-4c1a]
created: 2026-02-09T06:59:37Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-943f
tags: [refactor, import-directive-evaluator, phase-4]
updated: 2026-02-10T13:31:52Z
---
# Refactor Program: Modularize interpreter/eval/import/ImportDirectiveEvaluator.ts - Phase 4: Extract module and node import handlers



Objective:
Modularize registry/module and node package import paths.

Instructions for the implementing agent:
- In scope: module candidate/fallback resolution, lock validation, and node package import handler extraction.
- Out of scope: resolver/input flow and file/url/directory flow extraction.
- Extract module candidate generation/fallback resolution and lock-file version validation into dedicated module import helpers.
- Extract node package import conversion/wrapping and processing-result validation into a node import handler module.
- Preserve local-module preference logic and no-exports failure behavior.

Module boundaries:
- Module import helper owns candidate generation, fallback ordering, and lock-file checks.
- Node import handler owns package conversion/wrapping and processing-result validation.
- Evaluator orchestrates module vs node routing.

Preserve behavior checks:
- Module candidate fallback order remains unchanged.
- Lock-file validation behavior remains unchanged.
- Local-module preference behavior remains unchanged.
- No-exports failure semantics remain unchanged.

## Acceptance Criteria

1. Module and node import logic is extracted into focused handlers.
2. Fallback, lock validation, and no-exports semantics remain baseline-compatible.
3. Tests cover module/node parity and failure behavior.
4. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 13:30 UTC:** --dir refactor Extracted module/node import paths out of ImportDirectiveEvaluator into dedicated handlers:\n- Added interpreter/eval/import/ModuleImportHandler.ts for module candidate generation, fallback traversal, local-module preference checks, no-exports break semantics, and lock-file version validation.\n- Added interpreter/eval/import/NodeImportHandler.ts for node package resolution/normalization/wrapping, processing-result validation, and policy-context application.\n- Updated ImportDirectiveEvaluator routing to delegate module and node branches to handlers while preserving orchestration behavior.\n- Updated characterization coverage to validate module fallback behavior via ModuleImportHandler.\n- Added focused parity suites: module-import-handler.test.ts and node-import-handler.test.ts.\n- Updated tests/integration/lockfile-version-enforcement.test.ts to validate extracted lock-check behavior through ModuleImportHandler.\n\nChecklist/acceptance progress: (1) module/node logic extracted into focused handlers ✅, (2) fallback/local/lock/no-exports semantics preserved ✅, (3) module/node parity + failure behavior tests added/updated ✅.\n\nTests run:\n- npx vitest run interpreter/eval/import/module-import-handler.test.ts interpreter/eval/import/node-import-handler.test.ts interpreter/eval/import/import-directive-evaluator.characterization.test.ts tests/integration/lockfile-version-enforcement.test.ts -> PASS\n- npm run build && npm test && npm run test:tokens && npm run test:examples -> PASS

**2026-02-10 13:31 UTC:** --dir refactor Committed phase slice as 8984d642f (refactor(import-directive-evaluator): complete m-118a module-node-handlers).\n\nPost-commit closure gate:\n- npm run build && npm test && npm run test:tokens && npm run test:examples -> PASS\n\nPhase exit criteria satisfied; ready to close.
