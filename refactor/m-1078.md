---
id: m-1078
status: closed
deps: [m-2e93]
created: 2026-02-09T07:06:40Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-9747
tags: [refactor, core-interpreter, phase-5]
updated: 2026-02-10T12:33:46Z
---
# Refactor Program: Modularize interpreter/core/interpreter.ts - Phase 5: Extract interpolation and security recording helpers



Objective:
Centralize interpolation helper behavior and security recording contracts.

Instructions for the implementing agent:
- In scope: extract interpolation helper and security descriptor recording integration.
- Out of scope: dispatch table changes, variable resolver changes, and namespace utility extraction.
- Move `interpolateWithSecurityRecording` and related helper wiring into `interpreter/core/interpreter/interpolation-security.ts` (or equivalent).
- Preserve descriptor collection, merge behavior, and recording semantics across all call sites.
- Add tests for descriptor capture/merge ordering and cases with no descriptors.

Module boundaries:
- Interpolation/security module exposes a small API for interpolation + descriptor recording.
- Module does not own node dispatch or variable resolver behavior.
- Call sites pass explicit context and descriptor collectors.

Preserve behavior checks:
- `interpolate` output behavior remains unchanged.
- Security descriptor capture and merge semantics remain baseline-compatible.
- Descriptor recording order remains stable in multi-interpolation flows.
- No descriptor loss occurs across adapter boundaries.

## Acceptance Criteria

1. Interpolation/security helper logic is extracted into a dedicated module with explicit interfaces.
2. Descriptor recording and merge behavior remains baseline-compatible.
3. Preserve-behavior checks are covered by focused interpolation/security tests.
4. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 12:31 UTC:** Phase implementation complete:
- Extracted interpolation security helper into interpreter/core/interpreter/interpolation-security.ts via createInterpolationSecurityAdapter().
- Moved interpolateWithSecurityRecording behavior (descriptor collection, merge, record) out of interpreter.ts and wired interpreter.ts through the new adapter while preserving existing interpolate call sites.
- Added focused tests in interpreter/core/interpreter/interpolation-security.test.ts for:
  - single descriptor capture/recording without merge,
  - multi-descriptor merge ordering before recording,
  - no-descriptor flows (no merge/no record),
  - stable record ordering across sequential interpolations.

Acceptance checklist status:
- [x] Interpolation/security helper extracted into dedicated module
- [x] Descriptor recording + merge behavior preserved
- [x] Focused interpolation/security behavior tests added

Tests run:
- npx vitest run interpreter/core/interpreter/interpolation-security.test.ts interpreter/core/interpreter.characterization.test.ts interpreter/core/interpreter/resolve-variable-reference.test.ts interpreter/core/interpreter/traversal.test.ts interpreter/core/interpreter/dispatch.test.ts interpreter/core/interpreter/handlers/specialized-handlers.test.ts => PASS
- npm run build && npm test && npm run test:tokens && npm run test:examples => PASS

**2026-02-10 12:33 UTC:** Post-commit verification complete after commit 1b8d65826. Full gate rerun passed: npm run build && npm test && npm run test:tokens && npm run test:examples. Phase exit criteria remain satisfied; closing phase.
