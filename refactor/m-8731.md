---
id: m-8731
status: closed
deps: [m-499a]
links: []
created: 2026-02-09T06:19:05Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-ef4e
tags: [refactor, environment, phase-3, variables, resolvers]
updated: 2026-02-10T20:54:10Z
---
# Refactor Program: Modularize interpreter/env/Environment.ts - Phase 3: Extract variable and resolver facade

Objective:
Separate variable-facing orchestration from resolver-facing orchestration, keeping `Environment` as a facade.

Instructions for the implementing agent:
- Extract resolver variable flow from `getResolverVariable` into dedicated helper/module(s):
  - reserved-name checks
  - resolver invocation and content conversion
  - security descriptor projection to variable metadata
  - resolver cache read/write behavior
- Group variable-oriented convenience behavior (`setVariable`, `getVariable`, frontmatter aliases, transform lookup, import binding registry) behind cohesive internal methods/modules.
- Preserve interaction boundaries with `VariableManager` and `CacheManager`.

## Wave 2 Phase Guardrails

Required design constraints for this phase:
- Do not create runtime modules under 60 lines unless the file is a pure type-definition file or re-export barrel.
- Do not duplicate shared logic across sibling modules in this area; extract a shared helper/service when behavior overlaps.
- Do not introduce constructor callback-lambda injection as a service-composition strategy; use interface-typed service objects.
- Define shared result/context/types/type-guards once per extraction area and import them instead of re-declaring.
- Keep module dependency direction acyclic in the touched area before closing the phase.

Evidence required in the phase note before close:
- Touched runtime modules with line counts and a short ownership note per module.
- Targeted test commands run for this phase and pass/fail status.
- Explicit statement that no new sub-60 runtime module was introduced (or list allowed type/barrel exceptions).
- Explicit statement that no callback-lambda service injection was introduced (or justify a recursion-only exception).

## Acceptance Criteria

1. Resolver and variable orchestration logic is decomposed into focused modules with clear boundaries.
2. Reserved variable semantics and resolver cache behavior remain unchanged.
3. Characterization tests for variable lookup/resolution and frontmatter behavior remain green.
4. Exit criteria: full test gate passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples


**2026-02-10 20:54 UTC:** Completed Phase 3 extraction for variable/resolver facade boundaries.

What changed:
- Added `interpreter/env/runtime/ResolverVariableFacade.ts` (198 LOC)
  - Owns resolver-variable orchestration end-to-end:
    - reserved-name gating and keychain denial behavior,
    - cache read/write behavior for resolver variables,
    - resolver invocation and content conversion,
    - security descriptor projection into variable metadata,
    - unresolved placeholder creation when resolver manager is unavailable.
- Added `interpreter/env/runtime/VariableFacade.ts` (93 LOC)
  - Owns variable-facing convenience orchestration:
    - variable set/get/update/has/getValue passthroughs,
    - import binding registry accessors,
    - transform lookup helper,
    - frontmatter alias variable materialization (`fm` + `frontmatter`).
- Added runtime unit tests:
  - `interpreter/env/runtime/ResolverVariableFacade.test.ts` (105 LOC)
  - `interpreter/env/runtime/VariableFacade.test.ts` (100 LOC)
- Updated `interpreter/env/Environment.ts` (2641 LOC)
  - Delegates import-binding and variable convenience behavior to `VariableFacade`.
  - Delegates resolver variable flow to `ResolverVariableFacade`.
  - Preserves `Environment` facade/public method signatures and SDK debug event emission behavior.

Checklist/acceptance mapping:
- Resolver and variable orchestration decomposed into focused modules: complete.
- Reserved variable semantics and resolver cache behavior preserved: complete.
- Characterization coverage for variable lookup/resolution + frontmatter alias behavior remains green: complete.

Wave 2 guardrail evidence:
- No new sub-60 runtime modules introduced.
  - New runtime modules in this phase are 198 LOC and 93 LOC.
- No callback-lambda constructor service injection introduced.
  - Composition uses concrete collaborator objects (`ResolverVariableFacade`, `VariableFacade`) and shared runtime services.
- Shared extraction-area contracts/types are centralized in runtime modules (`ImportBindingInfo`, facade option types).
- Touched env runtime dependency direction remains acyclic by import inspection:
  - `Environment.ts` imports runtime collaborators;
  - runtime collaborators do not import `Environment.ts`.

Sub-checkpoint validation (build + targeted):
- `npm run build` ✅
- `npx vitest run interpreter/env/runtime/ResolverVariableFacade.test.ts interpreter/env/runtime/VariableFacade.test.ts interpreter/env/Environment.characterization.test.ts interpreter/env/debug.test.ts interpreter/eval/env-directive.test.ts tests/interpreter/security-metadata.test.ts tests/interpreter/import/state-live-update.test.ts tests/interpreter/environment-provider.test.ts` ✅
  - Result: 8 files passed, 55 tests passed.

Full gate for phase close:
- `npm run build && npm test && npm run test:tokens && npm run test:examples` ✅
- Main suite: 316 files passed, 0 failed (7 skipped); 3666 passed (63 skipped)
- Token suite: 6 files passed; 331 passed (6 skipped)
- Examples suite: 1 file passed; 1353 passed (2 skipped)
