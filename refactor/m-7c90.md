---
id: m-7c90
status: open
deps: [m-cb8c]
links: []
created: 2026-02-09T06:24:52Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-d11b
tags: [refactor, var, phase-6, variables]
---
# Refactor Program: Modularize interpreter/eval/var.ts - Phase 6: Extract variable construction strategies

Objective:
Extract variable construction and metadata attachment into strategy-based builders.

Instructions for the implementing agent:
- Move variable creation logic (type selection + source metadata + security metadata application) into dedicated module(s) (example target: `interpreter/eval/var/variable-builder.ts`).
- Replace long variable-construction condition chains with strategy functions keyed by RHS/value shape and wrapper metadata.
- Preserve behavior for:
  - primitive vs text vs template variable creation
  - triple-colon template AST preservation
  - structured value wrapping
  - existing Variable wrapper preservation
  - retryability metadata and sourceFunction attachment
  - tool collection metadata attachment
- Add targeted tests for variable factory selection and metadata propagation.

## Acceptance Criteria

1. Variable construction logic is extracted into dedicated strategy module(s).
2. Variable type selection and metadata/security behavior remain unchanged.
3. Added tests verify factory outcomes and metadata flags for representative RHS shapes.
4. Exit criteria: all tests pass, with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

