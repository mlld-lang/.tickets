---
id: m-225c
status: open
deps: []
created: 2026-02-09T07:01:16Z
type: epic
priority: 1
assignee: Adam Avenir
tags: [refactor, content-loader]
updated: 2026-02-09T07:01:16Z
---
# Refactor Program: Modularize interpreter/eval/content-loader.ts



Largest unplanned target file: `interpreter/eval/content-loader.ts` (~1,500 LOC).

This epic coordinates a phased refactor that decomposes content loading into focused services while preserving AST extraction behavior, file/url/glob loading semantics, section extraction behavior, security descriptor propagation, and structured return contracts.

Execution order:
1. Phase 0 through Phase 7 proceed strictly in order.
2. Each phase closes only after its exit criteria are met.
3. No phase starts until its dependency ticket is closed.

Cross-phase constraints:
- Keep `processContentLoader` contract stable across all supported return shapes.
- Preserve filesystem/url policy enforcement and security descriptor metadata behavior.
- Preserve AST extraction mode semantics (name-list and content pattern branches).
- Preserve section extraction and rename-template behavior, including fallback section matching.
- Preserve structured wrapping/finalization behavior and downstream pipeline compatibility.

## Acceptance Criteria

1. Phase tickets (0-7) exist under this epic and are dependency-linked in sequence.
2. Each phase ticket includes explicit implementation instructions and explicit exit criteria.
3. Final structure splits responsibilities into cohesive modules under `interpreter/eval/content-loader/` (or equivalent) and reduces `content-loader.ts` to orchestration.
4. Final validation command passes with output attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-09 08:19 UTC:** Safety-hardening pass completed for phases m-9251 -> m-03cd.

Tightening applied:
- Added explicit in-scope/out-of-scope boundaries across all phases.
- Added concrete module-boundary requirements for source/read helpers, AST pipelines, URL/file/glob handlers, section utilities, and transform/finalization adapters.
- Added explicit preserve-behavior checks for source reconstruction + policy checks, AST extraction variants, URL/HTML/file/glob parity, section extraction/heading matching, and finalization return-shape contracts.
- Standardized each phase exit criteria to require:
  npm run build && npm test && npm run test:tokens && npm run test:examples

Dependency verification:
- Verified linear chain with `tk dep tree --full m-03cd` in a temporary workspace mount that maps `.tickets/refactor` as `.tickets`.
- No dependency rewiring required.

Residual risk:
- Finalization remains high risk where transforms feed mixed structured/text outputs; parity checks should include mixed glob+AST+template flows.

**2026-02-09 08:25 UTC:** Micro-planning addendum (hotspot): added mixed-output finalization checklists to phases m-031c and m-03cd.

Focus:
- Covers mixed structured/text outputs and integrated glob+AST+template flows.
- Adds explicit closure gates requiring checklist-backed tests before each phase closes.
