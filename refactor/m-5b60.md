---
id: m-5b60
status: closed
deps: [m-118a]
created: 2026-02-09T06:59:37Z
type: task
priority: 1
assignee: Adam Avenir
parent: m-943f
tags: [refactor, import-directive-evaluator, phase-5]
updated: 2026-02-10T13:40:49Z
---
# Refactor Program: Modularize interpreter/eval/import/ImportDirectiveEvaluator.ts - Phase 5: Extract file, URL, and directory import handlers



Objective:
Isolate filesystem/network import orchestration.

Instructions for the implementing agent:
- In scope: file/url import handlers and directory traversal/option parsing/skip logic extraction.
- Out of scope: module/node/resolver/MCP handler extraction.
- Extract file/url import handling and directory import traversal (`maybeProcessDirectoryImport`, option parsing, skip logic) into dedicated handlers.
- Preserve directory key sanitization, duplicate-key detection, and index discovery behavior.
- Add tests for directory `skipDirs`, empty-directory failure, and mixed file/directory path behavior.

Module boundaries:
- File/url handler module owns single-source import processing.
- Directory handler module owns traversal, option parsing, key generation, and duplicate detection.
- Top-level evaluator routes source types without embedding traversal logic.

Preserve behavior checks:
- File/url parsing and import behavior remain unchanged.
- Directory `skipDirs`, key sanitization, duplicate-key detection, and index discovery remain unchanged.
- Empty-directory and mixed path failure semantics remain unchanged.

Micro-checklist (directory traversal risk matrix):
- Add directory traversal cases combining nested dirs, `skipDirs`, and index discovery with deterministic ordering assertions.
- Add mixed module-like/file-like naming cases to assert unchanged key sanitization and duplicate-key detection.
- Add collision-triggering directory imports and assert unchanged error payloads.
- Add empty-directory and optional-import combinations to assert unchanged failure/skip behavior.

## Acceptance Criteria

1. File/url/directory import logic is extracted into focused handlers.
2. Traversal, duplicate detection, and failure behavior remain baseline-compatible.
3. Tests cover skip rules, empty-directory failures, and mixed path cases.
4. Every item in the micro-checklist is backed by explicit tests before closing this phase.
5. Exit criteria: test gate command succeeds and output is attached:
   npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 13:39 UTC:** --dir refactor Implemented Phase 5 extraction:
- Added interpreter/eval/import/DirectoryImportHandler.ts for directory traversal, skipDirs parsing, key sanitization, duplicate-key detection, index discovery, and empty-directory failure behavior.
- Added interpreter/eval/import/FileUrlImportHandler.ts for file/url orchestration and directory fallback routing.
- Updated ImportDirectiveEvaluator routing to delegate file/url imports into FileUrlImportHandler and removed embedded directory/file traversal methods.
- Updated characterization/integration tests to follow extracted boundaries.
Checklist status:
- [x] nested traversal + skipDirs + deterministic ordering assertions.
- [x] mixed naming sanitization and duplicate-key detection assertions.
- [x] collision-triggering imports with unchanged DIRECTORY_IMPORT_DUPLICATE_KEY payload assertions.
- [x] empty-directory and optional templates skip behavior assertions.
Tests:
- PASS npx vitest run interpreter/eval/import/directory-import-handler.test.ts interpreter/eval/import/file-url-import-handler.test.ts interpreter/eval/import/import-directive-evaluator.characterization.test.ts interpreter/eval/import/import-types.test.ts
- PASS npm run build && npm test && npm run test:tokens && npm run test:examples

**2026-02-10 13:40 UTC:** --dir refactor Post-commit validation complete.
Commit: 844861359 (refactor(import-directive-evaluator): complete m-5b60 extract file url directory handlers)
Gate:
- PASS npm run build
- PASS npm test
- PASS npm run test:tokens
- PASS npm run test:examples
Phase exit criteria satisfied.
