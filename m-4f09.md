---
id: m-4f09
status: closed
deps: []
created: 2026-02-24T20:46:01Z
type: bug
priority: 0
assignee: Adam Avenir
updated: 2026-02-25T00:57:15Z
---
# Validator false positives: @ in strings, scoped packages, and loop vars

## Bug

The validator reports "undefined variable" warnings for `@` symbols that are not variable references:

1. **String literals**: `@` inside quoted strings (e.g., `"user@example.com"`)
2. **npm scoped packages**: `@anthropic/mcp-server` in MCP tool declarations
3. **for-loop implicit variables**: `@item`, `@index`, `@key` that are automatically declared by `for` loops

11+ false positive instances across 7+ topics.

## Where to Look

`cli/commands/analyze.ts`:
- `detectUndefinedVariables()` at line 355
- First pass (lines 360-451): collects declared variables from `var`, `guard`, `exe`, `import`, `for`, and `let`
- Second pass (lines 456-474): flags all `VariableReference` nodes not in the declared set
- `BUILTIN_VARIABLES` set (line 462): allowlist for built-in names
- `detectUndefinedTemplateVariables()` at line 1570: separate check for template variables

## Fix â€” three changes in `detectUndefinedVariables()`:

1. **Skip `@` inside string literals**: When a `VariableReference` node's source position falls inside a string literal (quoted content in the AST), do not flag it.

2. **Add for-loop implicit variables**: Add `@item`, `@index`, `@key` to `BUILTIN_VARIABLES`, OR detect them from `for` directive scopes in the first pass (lines 360-451).

3. **Skip npm scoped package patterns**: When the `@`-prefixed text is followed by `/` (matching pattern `@[a-z]+/`), do not flag it as an undefined variable.

