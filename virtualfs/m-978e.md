---
id: m-978e
status: open
deps: [m-a251]
created: 2026-02-18T17:12:20Z
type: task
priority: 2
assignee: Adam Avenir
updated: 2026-02-18T17:12:20Z
---
# Phase 2: Implement VirtualFS change lifecycle APIs

Context:
- Source plan: plan-virtualfs.md (Phase 2)

Goal:
Implement VirtualFS change lifecycle APIs for inspect/apply/revert workflows.

Implementation tasks:
- Extend VirtualFS with:
  - changes() (or canonical equivalent),
  - reset(),
  - discard(path),
  - flush(path?),
  - export(),
  - apply(patch).
- Define strict TypeScript types for VFS changes and patches.
- Implement path-scoped and global flush semantics.
- Enforce no-backing flush failure behavior.
- Ensure discard/reset fully clear intended shadow/deleted state.

## Design

Integration anchors:
- services/fs/VirtualFS.ts
- interpreter/eval/output.ts
- interpreter/eval/append.ts
- interpreter/eval/pipeline/builtin-effects.ts

Consistency requirements:
- Patch serialization must be deterministic.
- Flush/discard behavior must be path-precise and test-backed.

## Acceptance Criteria

Exit criteria:
- Added test coverage:
  - Add services/fs/VirtualFS.lifecycle.test.ts covering changes/reset/discard/flush/export/apply edge cases.
  - Add integration coverage for output/append shadow behavior prior to flush and after apply/export.
- All tests pass:
  - full regression gate.
- Docs updates:
  - Update CHANGELOG.md with lifecycle APIs.
  - Update any API notes/examples impacted by lifecycle semantics.
- Commit made:
  - Commit with message: feat(vfs): add change lifecycle and patch APIs

