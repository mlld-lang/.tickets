---
id: m-a251
status: open
deps: []
created: 2026-02-18T17:12:19Z
type: task
priority: 2
assignee: Adam Avenir
---
# Phase 1: Implement VirtualFS core IFileSystemService semantics

Context:
- Source plan: plan-virtualfs.md (Phase 1)
- Implement core filesystem semantics in services/fs/VirtualFS.ts

Goal:
Implement a production VirtualFS that satisfies IFileSystemService with copy-on-write shadow semantics and virtual identity.

Implementation tasks:
- Create services/fs/VirtualFS.ts.
- Implement:
  - readFile, writeFile, appendFile, exists, mkdir, readdir, isDirectory, stat
  - optional access, unlink, rm
  - isVirtual() => true
- Add factory methods:
  - VirtualFS.empty()
  - VirtualFS.over(backing: IFileSystemService)
- Ensure read precedence:
  - shadow writes first,
  - deleted masking,
  - fallback to backing.
- Ensure writes are shadow-only pre-flush.
- Implement directory markers/merging sufficient for readdir/stat/isDirectory correctness.

## Design

Integration anchors:
- services/fs/IFileSystemService.ts
- services/fs/NodeFileSystem.ts
- core/services/PathContextService.ts
- core/utils/findProjectRoot.ts

Behavior parity requirements:
- Error behavior should match Node/Memory expectations for ENOENT code/path where relevant.
- VirtualFS must not mutate backing on write/append/mkdir/delete until flush phase APIs are introduced.

## Acceptance Criteria

Exit criteria:
- Added test coverage:
  - Add services/fs/VirtualFS.core.test.ts covering:
    - read precedence, write/append, exists/isDirectory/stat, mkdir, readdir, rm/unlink/access, isVirtual.
  - Add/extend targeted integration tests for PathContextService and findProjectRoot with VirtualFS.
- All tests pass:
  - full regression gate (build:fixtures, test, test:tokens, test:heredoc, build).
- Docs updates:
  - Add CHANGELOG.md entries for VirtualFS core.
  - Update plan/doc note references impacted by core behavior.
- Commit made:
  - Commit with message: feat(vfs): implement VirtualFS core filesystem semantics

