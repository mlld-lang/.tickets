---
id: m-1138
status: open
deps: []
created: 2026-02-02T22:06:23Z
type: task
priority: 2
assignee: Adam
---
# When expression evaluation failed with 2 condition errors - J2BD crash

## Bug

The J2BD pipeline crashes with `When expression evaluation failed with 2 condition errors` after a worker successfully commits.

## Context

- Pipeline runs successfully through iterations 1 and 2
- Worker completes and commits (commit 961cc4131)
- friction_reported event is logged
- Then crash occurs

## What We Know

1. **Crash location**: Somewhere after friction_reported is logged but exact location unclear. The run.json doesn't have lastWorkerResult, suggesting crash happens before saveRunState.

2. **The error source**: when-expression.ts:662 throws when multiple conditions fail during evaluation and none match.

3. **Reproduction attempts**:
   - `when @decision.action [...]` with null decision gives "1 condition error" (not 2)
   - `when @decision.action [...]` with missing action field gives "1 condition error"
   - String decision fails earlier with FieldAccess error

4. **Related bug**: The `let @run` shadowing bug (m-3b36) means state isn't persisted correctly across loop iterations, which may contribute.

5. **Relevant files**:
   - llm/run/j2bd/index.mld (main orchestrator)
   - llm/run/j2bd/lib/context.mld (context building with several when expressions)
   - interpreter/eval/when-expression.ts (error throwing code)

## Run Data

Run directory: j2bd/security/runs/2026-02-02-3
- events.jsonl shows all events through friction_reported
- run.json missing lastWorkerResult (confirming crash before save)
- decision-1.json is valid JSON with action: "work"

## What I Haven't Tried

- Running full pipeline with verbose debugging (takes 15+ min)
- Binary search through context.mld when expressions
- Testing with exact state from crashed run

## Next Steps

1. Fix the let shadowing bug first (m-3b36) - may resolve this
2. Add more granular error messages showing WHICH when expression failed
3. Add line numbers to the condition error messages


**2026-02-03 01:58 UTC:** ## Updated Findings (Session 5)

**Exact crash location confirmed**: line 202, column 3 in index.mld - the `when @decision.action [...]` block

**Reproduction attempts (all give 1 error, not 2)**:
- null decision → 1 condition error (condition 7, the `*` default)
- { action: null } → 1 condition error
- StructuredValue from JSON file → 1 condition error
- Optional file load returning null → 1 condition error
- String decision (not object) → FieldAccess error (different)

**The mystery**: Cannot reproduce '2 condition errors' - consistently get '1 condition error' when bound value is null. Something specific about J2BD runtime state causes 2 conditions to fail.

**Debugging strategy**: Add before line 202:
```
show \`DEBUG: decision = @decision\`
show \`DEBUG: decision.action = @decision.action\`
```

Or run with MLLD_DEBUG=true
