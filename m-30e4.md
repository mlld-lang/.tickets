---
id: m-30e4
status: closed
deps: []
created: 2026-02-19T20:51:13Z
type: feature
priority: 0
assignee: Adam Avenir
updated: 2026-02-19T21:16:02Z
---
# Auto-enable checkpointing when llm-labeled calls exist

## Summary

Currently --checkpoint is required to enable the checkpoint/resume system. But the llm label on exe declarations already signals intent — if you wrote exe llm @fn(...), you want those calls cached. Requiring --checkpoint on top of that is redundant ceremony.

Flip the default: auto-enable checkpointing when any llm-labeled exe is encountered during evaluation. Users opt out with --no-checkpoint.

## Motivation

- The llm label IS the opt-in. The flag is redundant.
- Forgetting --checkpoint means losing work on crash — the exact scenario the feature prevents.
- "Pit of success" design: the right thing happens by default.
- The transparency property makes this safe: checkpoints don't change output, so auto-enabling can't break anything. Only side effect is disk writes to .mlld/checkpoints/.

## Design

### Auto-detection

Don't scan the import tree upfront. Lazily initialize CheckpointManager on first encounter of an llm-labeled call during evaluation. Zero cost for scripts that don't use llm labels.

The checkpoint hooks already check for the llm label at evaluation time (see interpreter/hooks/checkpoint-pre-hook.ts lines 7-12). The change is: instead of skipping when --checkpoint is absent, initialize the manager on demand.

### Flag changes

| Flag | Behavior |
|------|----------|
| (no flag) | Auto-enable checkpointing if llm labels are encountered. Cache stored in .mlld/checkpoints/<script>/. |
| --new | Clear previous cache, start a fresh run, still checkpoint this run. Replaces --fresh for user-facing convention. |
| --no-checkpoint | Disable checkpoint system entirely. No JSONL log, no cache reads/writes. For debugging or benchmarking. |
| --resume [target] | Implies checkpointing (already does). |
| --fork <script> | Implies checkpointing (already does). |
| --checkpoint | Becomes a no-op, kept for backwards compat. |

### Naming note

--no-checkpoint is preferred over --no-log because the feature is called "checkpointing." --no-log could be confused with suppressing show output or event logs.

### --fresh vs --new

Currently --fresh exists in the CLI. Evaluate whether to:
- Rename --fresh to --new (breaking change, but pre-1.0)
- Keep both as aliases
- Keep --fresh for the low-level "rebuild cache" meaning and --new for the higher-level "new run" convention that orchestrators use

## Implementation approach

1. In the checkpoint hook system, change the guard from "bail if --checkpoint not set" to "lazily initialize CheckpointManager on first llm-labeled call"
2. Key files:
   - cli/commands/run.ts — flag parsing (lines 24-32, 198-207)
   - interpreter/hooks/checkpoint-pre-hook.ts — the llm label check (lines 7-12)
   - interpreter/hooks/checkpoint-post-hook.ts — cache write logic
   - interpreter/index.ts — checkpoint option plumbing
3. Add --no-checkpoint flag to CLI
4. Make --checkpoint a backwards-compat no-op (or just keep accepting it silently)
5. Update docs and help text

## Getting up to speed

- Spec: spec-hooks-checkpoints-resume.md (root, 949 lines) — read User Guide section (lines ~31-298)
- CLI integration: cli/commands/run.ts
- Hook implementation: interpreter/hooks/checkpoint-pre-hook.ts, checkpoint-post-hook.ts
- CheckpointManager: interpreter/checkpoint/CheckpointManager.ts
- Current tests: tests/interpreter/checkpoint/

