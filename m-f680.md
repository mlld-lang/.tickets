---
id: m-f680
status: closed
deps: []
created: 2026-02-15T22:41:08Z
type: bug
priority: 0
assignee: Adam
updated: 2026-02-15T23:23:30Z
---
# Fix expression descriptor drop in var assignment

## Problem

When an expression is used as a var RHS, the taint metadata is lost even though the expression evaluator correctly merged it.

**Example that loses taint:**
```mlld
var secret @apiKey = "sk-123"
var @safe = "public"
var @result = @apiKey == "wrong" ? @apiKey : @safe

>> @result contains the actual secret string "sk-123"
>> But @result.mx.taint does NOT include 'secret' label
>> The taint was calculated in the ternary evaluator but dropped
```

This affects: ternary operators, logical operators, arithmetic, comparisons - any expression used as var RHS.

**Impact**: Medium priority for arithmetic (taint on `3+5` doesn't matter). High priority for ternary where you're selecting between tainted values and the selected value should preserve its taint.

## Root Cause

File: `/Users/adam/dev/mlld/interpreter/eval/var/rhs-dispatcher.ts` lines 411-418

```typescript
case 'expression': {
  const { evaluateUnifiedExpression } = await import('../expressions');
  const expressionResult = await evaluateUnifiedExpression(valueNode, env);
  return {
    type: 'resolved',
    handler: handlerKey,
    value: expressionResult.value  // <-- DROPS .descriptor field!
  };
}
```

The expression evaluator in `/Users/adam/dev/mlld/interpreter/eval/expressions.ts` (line 353) correctly merges descriptors from operands:
```typescript
const mergedDescriptor = mergeEvaluatorDescriptors(leftResult, rightResult);
```

And returns it in the result:
```typescript
return createEvaluatorResult(result, mergedDescriptor);
```

But the rhs-dispatcher only extracts `.value` and ignores `.descriptor`.

## Fix

In `/Users/adam/dev/mlld/interpreter/eval/var/rhs-dispatcher.ts` lines 411-418:

Propagate the expression descriptor:

```typescript
case 'expression': {
  const { evaluateUnifiedExpression } = await import('../expressions');
  const expressionResult = await evaluateUnifiedExpression(valueNode, env);
  return {
    type: 'resolved',
    handler: handlerKey,
    value: expressionResult.value,
    descriptor: expressionResult.descriptor  // <-- ADD THIS
  };
}
```

Then in `/Users/adam/dev/mlld/interpreter/eval/var.ts` around line 260, the existing descriptor extraction will pick it up:
```typescript
const resolvedValueDescriptor = extractSecurityDescriptor(resolvedValue, {
  recursive: true,
  mergeArrayElements: true
});
mergeResolvedDescriptor(resolvedValueDescriptor);
```

But we also need to check if the dispatcher's `descriptor` field is directly used. Search for how other RHS types (like `exe-invocation`) propagate their descriptors.

## Acceptance Criteria

1. Create test case in `tests/cases/security/` showing ternary preserves taint:
   ```mlld
   var secret @key = "sk-123"
   var @public = "safe"
   var @result = @key == "sk-123" ? @key : @public
   show @result.mx.taint
   ```
   Expected: Output includes "secret" label

2. Verify existing expression tests still pass

3. Check that arithmetic expressions still work (even though descriptor has no useful info):
   ```mlld
   var @x = 3 + 5  >> Should work, descriptor can be empty
   ```

4. Run `npm test` - all existing tests must pass

## Related Files

- `/Users/adam/dev/mlld/interpreter/eval/var/rhs-dispatcher.ts` (lines 411-418) - THE FIX GOES HERE
- `/Users/adam/dev/mlld/interpreter/eval/expressions.ts` (line 353) - Expression evaluator merges descriptors
- `/Users/adam/dev/mlld/interpreter/eval/var.ts` (line 260) - Descriptor extraction in var builder
- Investigation: agent aaa899d full report

**2026-02-15 23:23 UTC:** Fixed expression descriptor loss in var assignment flow. Propagated descriptor through var RHS dispatcher and merged in prepareVarAssignment; expression variable references now return descriptors from resolved values/source variable fallback. Added regression fixture tests/cases/security/var-expression-descriptor-preserved and updated rhs dispatcher unit test. Verified with: npx vitest run interpreter/eval/expressions-plus.test.ts interpreter/eval/var/rhs-dispatcher.test.ts; npx vitest run interpreter/interpreter.fixture.test.ts -t "security/var-expression-descriptor-preserved"; npm test. Commit: 7707a52b5.
