---
id: m-32d1
status: done
deps: []
created: 2026-02-15T15:48:43Z
type: task
priority: 1
assignee: Adam
tags: [qa-2026-02-14, p1, reconcile, security]
updated: 2026-02-15T15:49:32Z
---
# Reconcile: trusted!/!label/clear! syntax - verify grammar matches interpreter

QA flagged these as broken. Agent removed from docs. Review agent says grammar DOES parse them (when-rhs-action.peggy 45-50) and interpreter handles them (label-modification.ts:242).

Current doc state (line 65): 'Current workaround: use allow with { addLabels, removeLabels } until shorthand syntax is implemented.'

Reconcile:
1. Test if => trusted! @var actually works in practice
2. If YES: remove the 'workaround' language (line 65), make both syntaxes equal in the docs
3. If NO: investigate why grammar parses but runtime doesn't support

Already partially fixed in d797953 - just need to validate and remove workaround language.

## Acceptance Criteria

Shorthand syntax verified working or confirmed broken, docs accurate

## Resolution

Investigated and confirmed the gap. The shorthand syntax is in a middle state:

**Non-privileged shorthand works:** `=> pii @var`, `=> untrusted @var`, `=> trusted @var`, `=> pii,internal @var` all work correctly in exe/when blocks. Tested and verified.

**Privileged shorthand parses but can't execute:** `=> trusted! @var`, `=> !label @var`, `=> clear! @var` are correctly parsed (grammar: ReturnLabelModifier in when-rhs-action.peggy) and handled (interpreter: applyLabelModifiers cases for 'bless', 'remove', 'clear' in label-modification.ts). However, they all require `context.privileged === true`, and privilege only flows through guard evaluation. Guards use `GuardAction` syntax (allow/deny/retry/env), not `WhenRHSAction`, so there is no execution path where the privileged shorthand can succeed.

**Root cause:** The shorthand lives in `WhenRHSAction` (exe/when blocks), but privilege lives in guard context. Guards have their own action grammar (`GuardAction`) that uses `allow with { addLabels, removeLabels }` for label modifications. These two systems don't overlap.

**Doc fix:** Replaced "Current workaround: use allow with { addLabels, removeLabels } until shorthand syntax is implemented" with accurate description: the shorthand is parsed and handled but privilege only flows through guard context which uses `allow with {}` syntax. Also updated line 108 to reference `allow with { addLabels, removeLabels }` instead of `trusted!`/`!label` shorthand in the guard context section.

