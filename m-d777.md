---
id: m-d777
status: closed
deps: []
created: 2026-02-01T23:23:17Z
type: bug
priority: 2
assignee: Adam
---
# when block nested returns don't propagate

Nested blocks inside when cases with `=> @result` don't propagate the return value correctly.

**Reproduction:**
```mlld
exe @conditionalTemplate(type, name) = [
  when @type [
    "greeting" => [
      let @r = @simpleTemplate(@name)
      => @r
    ]
    * => "unknown"
  ]
]
```

Returns empty/0 chars instead of the template result.

**Workaround:**
Capture the when result in a let before returning:
```mlld
exe @letTemplate(type, name) = [
  let @result = when @type [
    "greeting" => @simpleTemplate(@name)
    * => "unknown"
  ]
  => @result
]
```

This works correctly.

**Test case:** tmp/test-template.mld reproduces the issue


## Notes

**2026-02-07T01:16:21Z**

Verified fixed â€” the WhenExpression unwrap at exe.ts:111-112 (from commit 55ceacf) handles nested returns correctly. Confirmed with test reproduction: when block with [let @r = ...; => @r] inside exe block returns the correct value.
