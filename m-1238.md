---
id: m-1238
status: closed
deps: []
links: []
created: 2026-01-25T12:43:21Z
type: bug
priority: 1
assignee: Adam Avenir
tags: [interpreter, parallel, for-loop]
---
# run sh with file redirection fails inside for parallel blocks

When using `run sh` with file output inside a `for parallel` block, files are not created.

## Reproduction

```mlld
var @items = ["a", "b"]
var @results = for parallel(2) @item in @items [
  run cmd {mkdir -p ./tmp/pfull/@item}  // This works
  run sh {echo 'hello' > ./tmp/pfull/@item/output.txt}  // This fails silently
  => @item
]
// Directories created, but output.txt files don't exist
```

## Expected
Files should be created by the sh command.

## Actual
Directories are created (mkdir works), but files from echo redirection are not created.

## Notes
- `run cmd` (simple commands) appears to work
- `run sh` with file operations fails
- Related to output directive also failing in parallel blocks


**2026-01-25T12:55:24Z**

## Investigation Findings

This is NOT parallel-specific - it's by design.

`run sh {...}` does NOT interpolate mlld variables. From `/Users/adam/dev/mlld/interpreter/eval/run.ts` lines 603-604:

```typescript
// Verbatim code (no interpolation) with dedent
const code = dedentCommonIndent(extractRawTextContent(codeNodes));
```

When you write:
```mlld
run sh {echo "hello" > ./tmp/@item/out.txt}
```

It literally executes the string `@item` in the shell, not the mlld variable value.

## Workaround

Pass variables as arguments:
```mlld
run sh (@item) {echo "hello" > ./tmp/$item/out.txt}
```

This passes mlld variable `@item` to shell as `$item`.

## Recommendation

Consider closing as "working as designed" with documentation improvement, or add a warning when `@var` patterns are detected in sh blocks.

**2026-01-25T18:29:18Z**

## Closed as 'by design'

This is not a bug - `run sh` intentionally doesn't interpolate mlld variables. Use the parameter passing syntax:

```mlld
run sh (@item) {echo "hello" > ./tmp/$item/out.txt}
```

This passes mlld variable `@item` to shell as `$item`.
