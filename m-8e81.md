---
id: m-8e81
status: closed
deps: []
created: 2026-02-25T06:21:40Z
type: bug
priority: 0
assignee: Adam Avenir
updated: 2026-02-25T17:42:14Z
---
# Seal capturedModuleEnv so it never reaches user space

## Bug

When a module is imported as a namespace (`import "mod.mld" as @ns`), the resulting namespace object carries a `capturedModuleEnv` property containing ALL variables from the module — including private (non-exported) ones and their values. This property is reachable from user-space code paths (error serialization, JSON.stringify, field enumeration).

## Acceptance criteria

1. `JSON.stringify()` on a namespace object must NOT include `capturedModuleEnv` or any of its contents
2. `Object.keys()` on a namespace object must return only exported names — `capturedModuleEnv` must not appear
3. Error messages that reference a namespace object must NOT include `capturedModuleEnv`
4. The interpreter's internal field resolution code must still be able to read `capturedModuleEnv` for its own purposes — do NOT delete the property, make it invisible to user-facing code paths
5. Use the keychain feature to seal `capturedModuleEnv`: mark it as a sealed/internal property so it is excluded from enumeration, serialization, and error formatting
6. All existing tests pass: `npm test`

## Where to look

1. Find where namespace objects are constructed after module import (likely in the import evaluator in `interpreter/eval/import.ts` or similar). That is where `capturedModuleEnv` gets attached to the namespace object.
2. Find the keychain sealing mechanism (search for "keychain" or "seal" in the codebase) and apply it to `capturedModuleEnv` on namespace objects.
3. Find any `JSON.stringify`, `Object.keys`, or error formatting paths that touch namespace objects and confirm they now skip sealed properties.

## What NOT to do

Do NOT remove `capturedModuleEnv` from the runtime. The interpreter needs it for field resolution on namespace imports. The goal is to make it invisible to users (not enumerable, not serializable, not in error output), not to delete it.

## Related

m-19a7 (FieldAccess error sanitization) depends on this ticket. Fix this one first.
