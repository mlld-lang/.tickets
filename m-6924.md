---
id: m-6924
status: closed
deps: []
created: 2026-02-21T12:15:00Z
type: task
priority: 2
assignee: Adam
updated: 2026-02-21T12:20:41Z
---
# Test infrastructure: support MCP subprocess tests in fixture runner

The fixture test runner uses a virtual filesystem (MemoryFileSystem) which prevents tests that spawn MCP subprocesses from working. The MCP subprocess runs on the real filesystem and can't find module files that only exist in VFS.

Example: tests/cases/security/mcp-served-input-no-src-mcp-taint-live/ passes when run directly via `mlld example.mld` but fails in the fixture runner because the `mlld mcp module.mld` subprocess can't resolve the module path.

This limits our ability to write automated tests for:
- MCP serving behavior (src:mcp taint on inputs/outputs)
- Guard behavior on MCP-served tools
- Tool collection + guard integration via MCP
- Any test using `import tools from mcp "mlld mcp ..."`

Possible approaches:
1. For live tests that spawn subprocesses, write support files to a temp directory on the real filesystem and use those paths
2. Add a test mode that mounts VFS files to real FS for subprocess access
3. Have the fixture runner detect MCP-dependent tests and set up the real FS paths before execution
4. Allow live tests to opt into real filesystem mode entirely

Reference test: tests/cases/security/mcp-served-input-no-src-mcp-taint-live/
See also: docs/dev/TESTS.md for test infrastructure documentation

## Acceptance Criteria

1. The mcp-served-input-no-src-mcp-taint-live test passes via MLLD_LIVE=1 npm run test:case
2. Tests that spawn MCP subprocesses can reference module files that the fixture runner provides
3. Existing non-MCP tests are unaffected


**2026-02-21 12:20 UTC:** Root cause: fixture tests defaulted basePath to '/', so MCP subprocesses executed from / and could not resolve tests/cases/... module paths on real FS. Fix: in interpreter/interpreter.fixture.test.ts, detect fixtures that run 'mlld mcp' and set basePath to repo root (path.join(__dirname, '..')) for those fixtures only. Verification: MLLD_LIVE=1 npm run test:case -- security/mcp-served-input-no-src-mcp-taint-live (pass) and npm run test:case -- slash/run/command (pass).
