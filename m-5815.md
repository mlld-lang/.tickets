---
id: m-5815
status: closed
deps: []
created: 2026-02-24T20:45:53Z
type: bug
priority: 0
assignee: Adam Avenir
updated: 2026-02-25T00:57:15Z
---
# While edge cases: bare done parse error and done null crash

## Bug 1: Bare `done` parse error

Using `done` without a value (to exit a while loop with no return value) causes a parse error.

### Where to Look

The `DoneLiteral` rule is in `grammar/base/literals.peggy` lines 75-98. It has three alternatives:
1. Line 76: `"done" _ "(" _ expr:Expression _ ")"` — done with parenthesized expression
2. Line 84: `"done" _ value:VarRHSContent` — done with a value
3. Line 92: `"done"` — bare done (no value)

The bare `done` alternative (line 92) should match, but it doesn't. The likely cause: alternative 2 (`"done" _ value:VarRHSContent`) greedily consumes the whitespace after "done" and then fails partway through parsing `VarRHSContent`, but peggy does not fall through to alternative 3 because `_` already consumed input. Verify by testing `done` alone on a line.

`DoneLiteral` is referenced from:
- `grammar/patterns/iteration.peggy` line 370
- `grammar/patterns/exe-rhs.peggy` line 744

### Fix

Ensure bare `done` on its own line parses successfully as a done-with-no-value. This may require reordering the alternatives (put bare `done` before `done` + value) or adding a negative lookahead to alternative 2 so it doesn't attempt to match when there's nothing after `done`.

---

## Bug 2: `done null` crashes with null pointer

Passing an explicit null to `done` (e.g., `done null`) causes a null pointer exception instead of terminating the loop gracefully.

### Where to Look

`interpreter/eval/while.ts` — `done` is handled via `resolveControlValue()` at line 98. When `control.kind === 'done'`, it returns `control.value` at line 104-106. The null pointer is likely in the caller of the while evaluator trying to access a property on the null return value.

### Fix

Add a null check: when `done` returns null, the while loop should terminate and return null (not crash).

