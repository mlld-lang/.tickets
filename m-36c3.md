---
id: m-36c3
status: closed
deps: []
created: 2026-02-25T15:34:50Z
type: bug
priority: 0
updated: 2026-02-25T19:31:45Z
---
# streamFormat in exe definition with-clause is ignored

## Bug

`streamFormat` in an exe definition's `with` clause is not read during streaming setup. The format adapter never activates, so raw NDJSON dumps to stdout.

## Reproduce

Create `tmp/repro-streamformat-exe.mld`:

```mlld
exe @llm(p) = stream cmd {echo '{"type":"text","text":"hello"}'} with { streamFormat: "claude-code" }
show @llm("test")
```

Run: `mlld tmp/repro-streamformat-exe.mld`

**Actual:** Raw JSON `{"type":"text","text":"hello"}` printed.
**Expected:** Just `hello` printed (adapter parses and extracts text).

## What to fix

The streaming setup code (look in `interpreter/eval/exec/`) resolves `streamFormat` from the invocation-time `withClause` but does not check the exe definition's `withClause` (stored in the exe's metadata). It needs to merge both, with invocation-time taking precedence.

## Verify

The repro above should print `hello` (not raw JSON). Also verify that invocation-time `with { streamFormat }` still works and overrides the exe-level setting.

## Acceptance Criteria

streamFormat in exe definition with-clause activates the adapter for all invocations of that exe.

**2026-02-25 19:31 UTC:** Fixed definition-level streamFormat merge with invocation override and added regressions (commit 938cc7967).
