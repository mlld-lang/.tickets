---
id: m-1e84
status: open
deps: [m-7fc3]
created: 2026-02-20T20:01:39Z
type: task
priority: 0
assignee: Adam
updated: 2026-02-20T20:01:44Z
---
# Audit all label propagation paths for taint loss

Template literal arguments strip labels before reaching exe calls (m-7fc3). This is a critical security gap — if taint is silently lost, guards and policies become bypassable. Need a systematic audit of every propagation path to find other cases where labels could be dropped. Paths to audit: template interpolation (backtick strings), string concatenation, collection construction (arrays/objects containing labeled values), pipeline stages, for-loop iteration, when-block branches, destructuring/spread, method calls (.trim(), .toUpperCase(), etc.), accessor chains (.field, [index]), and any other transformation that produces a new value from labeled inputs.

## Acceptance Criteria

Every path that transforms or wraps a labeled value preserves labels on the output. Test coverage for each path.


**2026-02-20 20:21 UTC:** ## Propagation Path Audit Results (2026-02-20)

### PASSING — Labels preserved correctly:
- Template interpolation (backtick strings) — including multi-label merge (secret+pii)
- Method calls: .trim(), .toUpperCase(), .join(), .split(), .replace(), .match(), .reverse(), .slice(), .concat()
- Pipeline through built-in transformers (@trim, @upper)
- When-expression: match branch, default (*) branch, value-matching
- For-loop iteration (including through exe)
- Nullish coalescing (@other ?? @name)
- Nested field access (@config.api.key)
- Array index access (@items[0])
- Array construction ([@var])
- Object construction ({key: @var})
- run/cmd interpolation — original labels + src:exec taint both present
- Exe invocation with labeled args (direct reference)

### BUGS FOUND:
1. **Object spread drops labels in var assignment** (m-b250, P0)
   - `var secret @orig = {k: "v"}; var @copy = { ...@orig }` => labels []
   - Exe arg path preserves labels correctly, so bug is var-assignment-specific

### BUGS ALREADY BEING FIXED (by implementing agent):
2. **Template literal exe args** (m-7fc3) — `@echo(\`hello @name\`)` drops labels
3. **Ternary in exe args** (new ticket) — `@echo(@flag ? @name : "x")` drops labels
4. **Conditional expressions in array/object literals** (m-296f) — `{k: @flag ? @name : "x"}` drops labels

### GAPS IN TEST COVERAGE (behavior works, needs fixture tests):
- Multi-label merge in template (secret + pii => both labels)
- When-expression standalone var assignment (when [...] result labels)
- Nullish coalescing fallback labels
- String .split(), .match(), .replace(), .join() label preservation
- Array .slice(), .reverse(), .concat() label preservation
- run cmd with labeled interpolation (labels + src:exec both survive)
- Object spread label propagation (once bug is fixed)
- For-loop through exe invocation labels
- When value-matching (`when @val ["x" => ...]`) labels

### NOT TESTABLE (syntax doesn't exist in mlld):
- Array spread `[...@arr]` — only object spread exists
- Destructuring assignment — not a mlld feature

**2026-02-20 20:31 UTC:** Found m-054b: js/sh/py blocks add no source taint at all, cmd uses src:exec instead of src:cmd. Label preservation through code blocks works correctly. No fixture tests for any code-block taint behavior.
