---
id: m-4013
status: closed
deps: []
created: 2026-02-19T23:01:01Z
type: bug
priority: 0
assignee: Adam Avenir
tags: [severity-high, pre-merge]
updated: 2026-02-19T23:23:08Z
---
# Fix fork+resume invalidation bug: forkIndex immune to --resume

## Problem

`--resume @fn` is silently ineffective when fork entries exist for the target function. All invalidation methods (`invalidateFunction`, `invalidateFunctionSite`, `invalidateFunctionFrom`, `invalidateFrom`) only remove entries from `localIndex`. The `forkIndex` is never modified after loading, and `get()` checks `forkIndex` FIRST unconditionally.

## Evidence

- `CheckpointManager.ts` `get()` at line 464: forkIndex checked first, unconditionally
- `removeKeys()` at line 835: `this.localIndex.delete(key)` — only touches localIndex
- Zero occurrences of `forkIndex.delete`, `forkIndex.clear`, `forkIndex.set` after construction
- No test covers `--fork` + `--resume` combination

## Scenario

1. Script A caches key K for function F
2. Script B runs with `--fork A` (fork has key K)
3. Script B runs again with `--fork A --resume @F`
4. `invalidateFunction('F')` removes nothing from forkIndex
5. `get(K)` still returns fork's cached value — `--resume` silently ignored

## Fix

Invalidation methods should also remove matching entries from `forkIndex` in-memory without modifying fork files on disk. Add a combined `--fork --resume` test.


**2026-02-19 23:15 UTC:** Confirmed bug exists as described. get() checks forkIndex first unconditionally (line 464). All five invalidation methods (invalidateFunction, invalidateFunctionSite, invalidateFunctionFrom, invalidateFrom, removeKeys) only touch localIndex. Zero occurrences of forkIndex.delete/clear/set after construction. No test covers --fork + --resume combination.

**2026-02-19 23:23 UTC:** Implemented fork-aware in-memory invalidation in CheckpointManager: invalidateFunction/invalidateFunctionSite/invalidateFunctionFrom/invalidateFrom now match local+fork entries, and removeKeys evicts from forkIndex+forkResultCache without touching fork files on disk. Added regressions in tests/interpreter/checkpoint/resume-fork.test.ts (fork+resume @llm) and tests/interpreter/checkpoint/CheckpointManager.test.ts (all selector paths against fork cache). Verified with: NODE_ENV=test MLLD_NO_STREAMING=true npx vitest run tests/interpreter/checkpoint/CheckpointManager.test.ts tests/interpreter/checkpoint/resume-fork.test.ts.
