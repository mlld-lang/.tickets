---
id: m-6865
status: open
deps: [m-57c7]
created: 2026-02-18T17:09:31Z
type: task
priority: 1
assignee: Adam Avenir
updated: 2026-02-18T17:09:39Z
---
# Phase 4: For/loop/import operation context expansion

Implement Phase 4 operation-context expansion for loops/import and batch hooks.

Scope:
- Emit operation contexts for:
  - `for`
  - `for:iteration`
  - `for:batch`
  - `loop`
  - `import`
- Add `@mx.for.*` fields including batch index/size where applicable.
- Add/extend concurrency helper callback plumbing for batch boundary events.

## Design

Key files:
- `interpreter/eval/for.ts`
- `interpreter/eval/for/iteration-runner.ts`
- `interpreter/utils/parallel.ts`
- `interpreter/env/ContextManager.ts`

## Acceptance Criteria

Exit criteria:
- Added test coverage:
  - `interpreter/eval/for.characterization.test.ts` for iteration and batch metadata
  - hook integration tests for `op:for:iteration` and `op:for:batch`
- All tests pass:
  - `npm test interpreter/eval/for.characterization.test.ts tests/interpreter/hooks/`
  - `npm run build`
  - `npm test`
- Docs updates complete:
  - `docs/dev/HOOKS.md`
  - `docs/user/flow-control.md`
- Commit made after green tests:
  - `feat(hooks): emit loop iteration and batch operation contexts`

