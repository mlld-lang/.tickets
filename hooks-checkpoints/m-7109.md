---
id: m-7109
status: closed
deps: []
created: 2026-02-20T16:05:53Z
type: task
priority: 3
assignee: Adam Avenir
tags: [severity-low, polish]
updated: 2026-02-24T19:46:50Z
---
# Validate operation type identifiers in hook filters

## Problem

`hook after op:totallyinvalid:nonsense` parses without error and silently never fires. The grammar (`grammar/directives/hook.peggy:96-112`) accepts any colon-separated identifier after `op:` via `HookOperationIdentifier`. No validation exists anywhere in the pipeline.

At runtime (`interpreter/hooks/user-hook-runner.ts:154-156`), the operation type is matched via `registry.getOperationHooks(operationType, timing)` — an unrecognized type simply returns no hooks and silently does nothing.

## Required change

Add a **warning** (not an error) at hook registration time in `HookRegistry` (`interpreter/hooks/HookRegistry.ts`) when the `filterValue` for a hook with `filterKind: 'operation'` is not in the known set.

Known operation types (verify these against the codebase — search for strings passed to `runUserHooks` or set as `operation.type`):
- `exe`
- `var`
- `for`
- `for:iteration`
- `for:batch`
- `loop`
- `import`
- `show`
- `output`
- `append`
- `run`

The warning should use the existing mlld warning infrastructure (not `console.warn`). Emit something like:

> Warning: Hook "op:{value}" uses unknown operation type "{value}". Known types: exe, var, for, for:iteration, for:batch, loop, import, show, output, append, run.

Do NOT make this a parse error — unknown types should still register (forward compatibility). This is a diagnostic warning only.

## Acceptance criteria

- `hook after op:nonsense { ... }` parses successfully but emits a warning at registration time.
- `hook after op:exe { ... }` registers with no warning.
- All known operation types register without warning.
- Existing hook tests continue to pass.
- Add a test that verifies the warning is emitted for an unknown op type.

