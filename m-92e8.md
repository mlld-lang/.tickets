---
id: m-92e8
status: closed
deps: []
created: 2026-02-16T00:52:11Z
type: bug
priority: 0
assignee: Adam
updated: 2026-02-16T02:10:12Z
---
# Fix @@ and \@ escape sequence position-dependent bugs

## Problem

`@@` and `\@` work correctly between literals (`user@@example.com` → `user@example.com`) but fail in two positions:

1. **Start of string**: `@@literal` outputs `@@literal` instead of `@literal`
2. **After variable interpolation**: `@user@@domain` outputs `alice@@domain` instead of `alice@domain`

## What to do

There are two layers of escape processing. Both need to handle all positions:

### Grammar layer (parse time)
- `grammar/patterns/exe-rhs.peggy` (lines 458-463): handles `@@` and `\@` in template/prose blocks, converting to Text nodes with content `@`
- `grammar/patterns/unified-run-content.peggy`: `CmdAtEscape` handles `@@` and `\@` in command brackets

Check that the grammar rules for `@@` and `\@` can match at the start of a string and immediately after a variable interpolation node. The issue is likely rule ordering — a higher-priority rule may be consuming the first `@` before the `@@` rule gets a chance to match.

### Interpolation layer (runtime)
- `interpreter/streaming/template-interpolator.ts` (lines 124-128): `processEscapes()` does `.replace(/@@/g, '@')` AFTER variable substitution
- Line 72: negative lookbehind `(?<!@)` prevents matching variables preceded by `@`

The runtime `processEscapes` runs after variable substitution, so `@user@@domain` becomes `alice@@domain` and then processEscapes should convert `@@` to `@`. If it doesn't, the issue is that the `@@` was already partially consumed during variable matching.

Fix both layers to handle escapes position-independently.

## Acceptance criteria

- `@@literal` at string start outputs `@literal`
- `user@@example.com` in middle outputs `user@example.com`
- `@user@@domain` after variable outputs `alice@domain`
- `\@literal` at string start outputs `@literal`
- `@user\@domain` after variable outputs `alice@domain`
- Add test cases for all three positions (start, middle, post-variable) in `tests/cases/`


**2026-02-16 02:10 UTC:** Implemented position-independent @@ and \@ escaping across grammar and streaming interpolation; added regression coverage in tests/grammar/regression/escape-at-position.test.ts, tests/streaming/template-interpolator.test.ts, and tests/cases/slash/var/escape-at-position-regression. Validation: npx vitest run interpreter/interpreter.fixture.test.ts -t 'slash/var/escape-at-position-regression' and npm test (390 passed, 7 skipped). Commit: 5e8c86afb.
