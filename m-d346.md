---
id: m-d346
status: closed
deps: []
created: 2026-02-04T03:32:41Z
type: bug
priority: 1
assignee: Adam
tags: [heredoc, bash, epipe, blocking]
updated: 2026-02-04T03:32:44Z
---
# Heredoc parameter passing causes silent bash failures for >64KB params

BashExecutor heredoc mode silently fails when passing large (>64KB) shell parameters. Bash exits immediately with no output instead of executing the script.

## Reproduction

The `@claudePoll` sh {} block receives a `$prompt` parameter (~71KB). When this exceeds the 64KB heredoc threshold (lowered in de7e0a336), BashExecutor switches from env var to heredoc:

```bash
prompt=$(cat <<'MLLD_EOF_xyz'
[71KB of content]
MLLD_EOF_xyz
)
# ...rest of user script...
```

Bash exits instantly — all loop iterations share the same millisecond timestamp, confirming the process never actually runs. No stderr output is captured.

## Evidence

- Decision agent prompt at 71,494 chars fails every time (14 retries, all at 2026-02-04T02:27:04.251Z — same ms)
- Same prompt at ~66K worked fine in previous runs (under 64K threshold, passed as env var)
- The 5K increase came from fixing a bug in `@loadAtom` that made `@buildReferenceMaterial` return real atom content instead of nulls
- Worker prompt at 127,383 chars also EPIPE'd (separate but related — was above even the old 128K threshold)

## Key Files

- `interpreter/env/executors/BashExecutor.ts:145-206` — heredoc prelude generation
- `llm/modules/claude-poll.mld.md` — the sh {} block that receives the large $prompt param
- Threshold commit: de7e0a336 (lowered from 128KB to 64KB)

## Possible Causes

1. Heredoc content breaks bash parsing — despite single-quoted delimiter, something in the 71K prompt might cause bash to choke. Could be embedded sequences that look like heredoc terminators despite the conflict check.
2. Pipe buffer overflow — the entire script (heredoc prelude + user code = ~74KB) is written to bash stdin via child.stdin.write(enhancedCode). If bash cannot consume it fast enough, the pipe fills. Node buffers this, but the write might complete before bash has parsed the heredoc, causing a race.
3. Command substitution size limit — $(cat <<'EOF' ...) may have a practical size limit in some bash versions. macOS bash is v3.2 (old).

## Suggested Investigation

1. Enable MLLD_DEBUG_BASH_SCRIPT=1 and dump the generated script to inspect heredoc structure
2. Extract the generated script and run it manually in bash to see the error
3. Test with macOS bash 3.2 vs homebrew bash 5.x to rule out version-specific limits
4. Check if child.stderr captures anything when the heredoc fails

## Workaround

Raise threshold back to 128KB or reduce prompt sizes below 64KB. The prompt scoping fix (using @buildReferenceMaterial instead of full spec dump) will bring prompts under 64KB naturally.

