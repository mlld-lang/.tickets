---
id: m-5194
status: open
deps: []
links: []
created: 2026-02-25T23:21:16Z
type: task
priority: p1
assignee: Adam Avenir
---
# # Doc Test Expected Output Migration

Promote doc code block tests from syntax-only (parse, don't execute) to full execution tests with expected output. Currently ~700 blocks are syntax-only; the goal is to have as many as possible running with verified output.

## Current State

### What's done
- Infra complete: extract-doc-tests.mjs, build-fixtures.mjs (recursive walker), doc-expect.mjs, .gitignore negation patterns
- Stale fixture auto-cleanup in build-fixtures.mjs (prevents duplicate fixture bugs)
- quickstart: 11 expectations, 5 skips, 2 syntax-only
- atoms/core: 6 expectations, 23 skips

### In Progress — atoms/flow-control
Dry-run completed. Ready to capture:
- 12 blocks with clean output (verified): 4f0f41d8, f53b30d1, 8606a7da, e5a5aaeb, b7fa0f67, 27e768f0, 74675c3c, 9f54c0c2, c74f5cab, c7d37282, 55d35314, 851dd123
- ~18 blocks need skips (undefined context vars, missing deps)
- 1 block (e038accd) has non-deterministic parallel output — skip

### Remaining
~670 blocks across atoms/effects, atoms/modules, atoms/output, top-level docs (flow-control, content-and-data, introduction), etc. Run `npm run doc:expect -- --status` for full picture.

## Architecture

### How doc tests work
1. `scripts/extract-doc-tests.mjs` extracts code blocks from `docs/src/atoms/**/*.md` and `docs/user/*.md` into `tests/cases/docs/<docname>/<8-char-hash>/`
2. `scripts/build-fixtures.mjs` generates `.generated-fixture.json` files in `tests/fixtures/docs/`
3. Test runner (`interpreter.fixture.test.ts`) executes each fixture:
   - No expected.md → syntax-only test (parse, don't execute)
   - Has expected.md → full execution test (compare output)
   - Has skip.md / skip-*.md → skipped during fixture build
4. `scripts/doc-expect.mjs` previews outputs and captures expectations

### expected.md and skip.md files
- Live in auto-generated `tests/cases/docs/` tree
- Excluded from gitignore via negation patterns — they are tracked in git
- Survive build:fixtures runs (extract script preserves them)
- Content-addressed dirs (8-char SHA-256 hash of code block) mean they survive doc block reordering
- When a doc block is edited, its hash changes: old dir becomes orphan, new dir is created. `npm run build:fixtures` warns about orphans. Run `npm run doc:expect -- <doc>/<new-hash>` to recapture.

## Principles

1. **Think critically about every output** — don't blindly capture. If anything looks even slightly off, stop and flag it. (This is how we caught the append bug q-6c82.)
2. **Confirm skips with the user** — don't just skip things. It may be possible to tweak the doc example to make it testable instead.
3. **Don't clutter docs for test purposes** — when a block needs external files, we'd rather skip than rewrite the doc example with test-specific paths.
4. **Track skipped blocks on the right ticket** — use `tk add-note` on q-fe38 for file-loading skips, m-63d5 for context-variable skips. When that infra gets built we know exactly what to revisit.
5. **The processMlld chunk bug (m-8025) has a workaround** — verify via `mlld` CLI and write expected.md manually when `doc-expect --dry-run` errors on a block that should work.

## Workflow

### Adding expectations
```bash
# 1. Dry-run a doc section
npm run doc:expect -- atoms/flow-control --dry-run

# 2. For each block, verify output against source
#    Cross-reference the example.mld with the output
#    Check: undefined vars produce expected defaults? Math correct? Conditions evaluate right?

# 3. Write expected.md files (manually, not via --yes)
echo 'expected output' > tests/cases/docs/<section>/<hash>/expected.md

# 4. Write skip.md for blocks that can't work
echo 'Reason for skip.' > tests/cases/docs/<section>/<hash>/skip.md

# 5. Rebuild fixtures and test
npm run build:fixtures
npm run test:case -- docs/<section>

# 6. Commit
find tests/cases/docs/<section> -name 'expected.md' -o -name 'skip.md' | xargs git add
git commit -m 'test(docs): add <section> doc test expectations and skips'
```

### Common skip reasons
- Undefined context variables — block assumes vars defined elsewhere in the doc
- External file dependencies — needs files not in VFS (ticket q-fe38)
- Shell/command dependencies — runs real shell commands with non-deterministic output
- Variable redefinition — block shows alternatives with duplicate var names
- Template file contents — shows .att/.mtt file contents, not standalone scripts
- Python/Node dependencies — needs runtime not available in VFS test env

### Verifying tricky blocks via CLI
For blocks where doc-expect errors due to m-8025 chunk issue:
```bash
cat > /tmp/test-block.mld << 'MLLD'
<paste source here>
MLLD
mlld /tmp/test-block.mld --no-format
```

## Related Tickets
- q-6c82 (p0): append produces document output in addition to file write
- m-8025 (p0): processMlld lazy-loaded chunks fail in doc-expect (workaround: use CLI)
- q-fe38 (p3): Doc test infra for file-loading examples
- m-63d5 (p3): SDK payload injection for context-dependent doc tests (would unlock ~30% of skipped blocks)

## Suggested Path Forward
1. Continue atoms/flow-control — 12 blocks ready to capture
2. Work through remaining atoms/ — effects, modules, output, etc.
3. Tackle top-level docs — flow-control, content-and-data, introduction
4. Consider m-63d5 — payload injection would unlock ~30% of currently-skipped blocks

