---
id: m-9347
status: closed
deps: []
links: []
created: 2026-01-28T22:44:48Z
type: bug
priority: 2
assignee: Adam
tags: [interpreter, import, scoping]
updated: 2026-01-30T12:04:08Z
---
# Forward reference in same-file exe functions breaks on import

Exe functions defined in a module cannot call other exe functions defined later in the same file when the module is imported.

## Symptom
```
exe @outer(x) = @inner(@x)  // defined first, calls @inner
exe @inner(x) = ...         // defined later
/export { @outer }
```
When @outer is imported and invoked: 'Referenced command not found: inner'

## Root Cause
Each exe captures its environment at DEFINITION time via captureModuleEnvironment() (exe.ts:994-996). When @outer is defined, @inner doesn't exist yet, so it's not in @outer's captured environment.

## Why This Is Complex
Attempted fix: refresh all capturedModuleEnv maps after module evaluation completes. This works for the forward-ref case but BREAKS the existing exe-chain-import test because:
1. The refresh creates circular references (each exe's capturedModuleEnv contains other exes with their own capturedModuleEnv)
2. The serialization logic in VariableImporter detects circularity and strips the capturedModuleEnv
3. This breaks exe functions that WERE working (backward references)

## Related Complexity
- docs/dev/DATA.md: StructuredValue wrappers, Variable metadata preservation
- docs/dev/SHADOW-ENV.md: capturedShadowEnvs similar pattern for shadow functions  
- VariableImporter.serializeModuleEnv uses WeakSet for circular reference detection
- ObjectReferenceResolver.serializeModuleEnv has similar logic

## Possible Approaches (needs design)
1. Two-pass module evaluation: first pass registers exe names, second pass captures complete environment
2. Lazy environment resolution: don't capture at definition, resolve at invocation
3. Smart refresh: update capturedModuleEnv without creating serialization-breaking circularity
4. Change lookup semantics: check multiple scopes during invocation

## Workaround
Define helper functions BEFORE the functions that call them:
```
exe @inner(x) = ...         // define helper first
exe @outer(x) = @inner(@x)  // then the caller
```

